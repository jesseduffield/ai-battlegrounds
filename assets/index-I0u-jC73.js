(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))a(s);new MutationObserver(s=>{for(const l of s)if(l.type==="childList")for(const o of l.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&a(o)}).observe(document,{childList:!0,subtree:!0});function r(s){const l={};return s.integrity&&(l.integrity=s.integrity),s.referrerPolicy&&(l.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?l.credentials="include":s.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function a(s){if(s.ep)return;s.ep=!0;const l=r(s);fetch(s.href,l)}})();const Ne=15;function _r(n,e){return n.effects.some(r=>r.id===e.id)?!1:(n.effects.push({...e}),!0)}function Nr(n,e,r,a){const s=[];switch(n.type){case"damage":{if(e.hp-=n.amount,s.push({turn:r.turn,actorId:e.id,damage:n.amount,description:`${e.name} takes ${n.amount} damage from ${a}!`,sound:"attack",witnessIds:R(r,[e.position])}),e.hp<=0){e.hp=0,e.alive=!1;const l=r.tiles[e.position.y][e.position.x];for(const o of e.inventory)l.items.push(o);if(e.inventory.length>0){const o=e.inventory.map(u=>u.name).join(", ");s.push({turn:r.turn,sound:"drop",actorId:e.id,position:e.position,description:`${e.name}'s items fell to the ground: ${o}`,witnessIds:R(r,[e.position])})}return e.inventory=[],e.equippedWeapon=void 0,e.equippedClothing=void 0,s.push({turn:r.turn,actorId:e.id,description:`${e.name} died from ${a}!`,sound:"death",witnessIds:R(r,[e.position])}),{description:`took ${n.amount} damage`,events:s,died:!0}}return{description:`took ${n.amount} damage`,events:s}}case"heal":{const l=Math.min(n.amount,e.maxHp-e.hp);return e.hp+=l,l>0&&s.push({turn:r.turn,actorId:e.id,damage:-l,description:`${e.name} heals ${l} HP from ${a}!`,witnessIds:R(r,[e.position])}),{description:`restored ${l} HP`,events:s}}case"apply_effect":return _r(e,{...n.effect}),s.push({turn:r.turn,actorId:e.id,description:`${e.name} gains ${n.effect.name} from ${a}!`,witnessIds:R(r,[e.position])}),{description:`gained ${n.effect.name} effect`,events:s};case"message":return s.push({turn:r.turn,actorId:e.id,description:`${a}: ${n.text}`,witnessIds:R(r,[e.position])}),{description:n.text,events:s};case"modify_stat":{const l=n.operation==="multiply"?`${n.stat} Ã—${Math.round(n.value*100)}%`:`${n.stat} ${n.value>=0?"+":""}${n.value}`;return s.push({turn:r.turn,actorId:e.id,description:`${e.name}'s ${l} from ${a}!`,witnessIds:R(r,[e.position])}),{description:`${n.stat} modified`,events:s}}case"custom":return{description:"custom effect pending",events:s,pendingCustom:{prompt:n.prompt}}}}function ho(n,e,r){const a=[],s=[];for(const l of n.effects)for(const o of l.triggers)if(o.on===e)for(const u of o.actions){const i=Nr(u,n,r,l.name);a.push(...i.events),i.pendingCustom&&s.push({characterId:n.id,effectName:l.name,prompt:i.pendingCustom.prompt})}return{events:a,pendingCustomActions:s}}function go(n){const e=[];for(const r of n.effects)r.duration>0&&(r.duration--,r.duration===0&&e.push(r));return n.effects=n.effects.filter(r=>r.duration!==0),e}function yo(n,e,r){let a=0,s=1;for(const l of n.effects)for(const o of l.triggers)if(o.on===e)for(const u of o.actions)u.type==="modify_stat"&&u.stat===r&&(u.operation==="add"?a+=u.value:u.operation==="multiply"&&(s*=u.value));return{additive:a,multiplicative:s}}function hs(n){const e=[];n.preventsMovement&&e.push("prevents movement");for(const r of n.triggers)for(const a of r.actions)if(a.type==="damage")e.push(`${a.amount} damage/${r.on.replace("_"," ")}`);else if(a.type==="heal")e.push(`${a.amount} heal/${r.on.replace("_"," ")}`);else if(a.type==="modify_stat"){const s=a.stat;if(a.operation==="multiply"){const l=Math.round(a.value*100);e.push(`${s} Ã—${l}%`)}else{const l=a.value>=0?"+":"";e.push(`${s} ${l}${a.value}`)}}else a.type==="custom"?e.push(`custom: "${a.prompt}"`):a.type==="apply_effect"?e.push(`applies ${a.effect.name}`):a.type==="message"&&e.push(`message: "${a.text}"`);return e.length>0?e.join(", "):"no effects"}function Z(){return Math.random().toString(36).substring(2,11)}function Ye(n,e){return Math.abs(n.x-e.x)+Math.abs(n.y-e.y)}function wo(n,e){return Math.max(Math.abs(n.x-e.x),Math.abs(n.y-e.y))}function rt(n,e){return n.x===e.x&&n.y===e.y}function Gt(n){return[{x:n.x,y:n.y-1},{x:n.x+1,y:n.y},{x:n.x,y:n.y+1},{x:n.x-1,y:n.y},{x:n.x-1,y:n.y-1},{x:n.x+1,y:n.y-1},{x:n.x-1,y:n.y+1},{x:n.x+1,y:n.y+1}]}function gs(n,e){return wo(n,e)===1}function bo(n){return n.type==="wall"}function ys(n){var e;return((e=n.feature)==null?void 0:e.type)==="chest"}function vo(n){var e;return((e=n.feature)==null?void 0:e.type)==="door"&&!n.feature.open}function at(n){return!(!["ground","grass"].includes(n.type)||vo(n)||ys(n))}function _o(n,e,r){let a=0;for(;a<n.length&&n[a].end<e;)a++;let s=e,l=r;for(;a<n.length&&n[a].start<=l;)s=Math.min(s,n[a].start),l=Math.max(l,n[a].end),n.splice(a,1);n.splice(a,0,{start:s,end:l})}function Mo(n,e,r){for(const a of n)if(a.start<=e&&a.end>=r)return!0;return!1}function ko(n){return n.length===1&&n[0].start<=0&&n[0].end>=1}function ws(n,e,r){const a=new Set;a.add(`${e.x},${e.y}`);for(let s=0;s<8;s++)Eo(n,e,r,s,a);return a}function xo(n,e,r){switch(n){case 0:return{dx:r,dy:-e};case 1:return{dx:e,dy:-r};case 2:return{dx:e,dy:r};case 3:return{dx:r,dy:e};case 4:return{dx:-r,dy:e};case 5:return{dx:-e,dy:r};case 6:return{dx:-e,dy:-r};case 7:return{dx:-r,dy:-e};default:return{dx:0,dy:0}}}function Eo(n,e,r,a,s){const l=[];for(let o=1;o<=r;o++){for(let u=0;u<=o;u++){const{dx:i,dy:c}=xo(a,o,u),m=e.x+i,g=e.y+c;if(m<0||m>=n.width||g<0||g>=n.height||Math.sqrt(i*i+c*c)>r)continue;const h=u/(o+1),y=(u+1)/o;Mo(l,h,y)||(s.add(`${m},${g}`),bo(n.tiles[g][m])&&_o(l,h,y))}if(ko(l))break}}function bs(n,e,r){const a=Ye(e,r),s=20;return a>s?!1:ws(n,e,s).has(`${r.x},${r.y}`)}function On(n,e){const r={tiles:[],characters:[],items:[]},a=e.viewDistance,s=ws(n,e.position,a);Io(n,s);for(const l of s){const[o,u]=l.split(","),i=parseInt(o,10),c=parseInt(u,10),m={x:i,y:c},g=n.tiles[c][i];r.tiles.push({...g,position:m});for(const h of g.items)r.items.push({item:h,position:m})}for(const l of n.characters)l.id!==e.id&&s.has(`${l.position.x},${l.position.y}`)&&r.characters.push({character:l,position:l.position});return r}function Io(n,e){const r=new Set;for(const a of e){const[s,l]=a.split(",").map(Number),o=[{x:s+1,y:l},{x:s-1,y:l},{x:s,y:l+1},{x:s,y:l-1}];for(const u of o){if(u.x<0||u.x>=n.width||u.y<0||u.y>=n.height)continue;const i=`${u.x},${u.y}`;if(e.has(i))continue;n.tiles[u.y][u.x].type==="wall"&&r.add(i)}}for(const a of r){const[s,l]=a.split(",").map(Number),o=[{x:s+1,y:l},{x:s-1,y:l},{x:s,y:l+1},{x:s,y:l-1}];let u=0;for(const i of o){if(i.x<0||i.x>=n.width||i.y<0||i.y>=n.height)continue;const c=`${i.x},${i.y}`;n.tiles[i.y][i.x].type==="wall"&&e.has(c)&&u++}u>=2&&e.add(a)}}function Nn(n,e){const r=On(n,e);for(const a of r.tiles){const s=a.position,l=`${s.x},${s.y}`,o=r.characters.find(c=>c.position.x===s.x&&c.position.y===s.y),u=r.items.filter(c=>c.position.x===s.x&&c.position.y===s.y).map(c=>c.item.name),i=a.feature?{type:a.feature.type,name:a.feature.name}:void 0;e.mapMemory.set(l,{type:a.type,lastSeenTurn:n.turn,items:u.length>0?u:void 0,characterName:o==null?void 0:o.character.name,characterAlive:o==null?void 0:o.character.alive,feature:i})}}function jt(n,e,r,a){if(rt(e,r))return[];const s=[{pos:e,path:[]}],l=new Set;for(l.add(`${e.x},${e.y}`);s.length>0;){const o=s.shift(),u=Gt(o.pos);for(const i of u){if(i.x<0||i.x>=n.width||i.y<0||i.y>=n.height)continue;const c=`${i.x},${i.y}`;if(l.has(c))continue;const m=n.tiles[i.y][i.x];if(ys(m)||!at(m))continue;const g=i.x-o.pos.x,h=i.y-o.pos.y;if(g!==0&&h!==0){const f=n.tiles[o.pos.y][i.x],p=n.tiles[i.y][o.pos.x];if(!at(f)&&!at(p))continue}if(n.characters.some(f=>f.alive&&rt(f.position,i)))continue;const d=[...o.path,i];if(rt(i,r))return d.length<=a?d:null;d.length<a&&(l.add(c),s.push({pos:i,path:d}))}}return null}function Wr(n,e){const r=[],a=e.position,s=e.movementRange,l=[{pos:a,steps:0}],o=new Set;for(o.add(`${a.x},${a.y}`);l.length>0;){const u=l.shift();if(u.steps>0&&r.push(u.pos),u.steps>=s)continue;const i=Gt(u.pos);for(const c of i){if(c.x<0||c.x>=n.width||c.y<0||c.y>=n.height)continue;const m=`${c.x},${c.y}`;if(o.has(m))continue;const g=n.tiles[c.y][c.x];if(!at(g))continue;const h=c.x-u.pos.x,y=c.y-u.pos.y;if(h!==0&&y!==0){const f=n.tiles[u.pos.y][c.x],p=n.tiles[c.y][u.pos.x];if(!at(f)&&!at(p))continue}n.characters.some(f=>f.alive&&f.id!==e.id&&rt(f.position,c))||(o.add(m),l.push({pos:c,steps:u.steps+1}))}}return r}function $o(n,e=1){let r=0;for(let a=0;a<e;a++)r+=Math.floor(Math.random()*n)+1;return r}function Co(n){var o;const e=((o=n.equippedWeapon)==null?void 0:o.damage)??1,r=yo(n,"on_attack","attack"),a=r.multiplicative<1||r.additive<0,s=$o(20);if(s===20){let u=e*2;return u=(u+r.additive)*r.multiplicative,{damage:Math.max(1,Math.floor(u)),roll:s,isDebuffed:a}}if(s===1)return{damage:0,roll:s,isDebuffed:a};if(s>=8){let u=e;return u=(u+r.additive)*r.multiplicative,{damage:Math.max(1,Math.floor(u)),roll:s,isDebuffed:a}}return{damage:0,roll:s,isDebuffed:a}}function Kt(n,e,r){var s,l,o,u,i,c,m,g,h,y;const a=[];switch(r.type){case"move":{const d=e.effects.find(E=>E.preventsMovement);if(d)return{success:!1,message:`${e.name} cannot move due to ${d.name}! (${d.duration} turns remaining)`,events:a};const f=jt(n,e.position,r.targetPosition,e.movementRange);if(!f)return{success:!1,message:"Cannot reach that position",events:a};const p=n.characters.find(E=>E.alive&&E.id!==e.id&&rt(E.position,r.targetPosition));if(p)return{success:!1,message:`Cannot move onto ${p.name}'s position`,events:a};const b={...e.position};let w=r.targetPosition,M=!1,x=[b,...f];for(let E=0;E<f.length;E++){const _=f[E],I=n.tiles[_.y][_.x];if(((s=I.feature)==null?void 0:s.type)==="trap"&&!I.feature.triggered){const C=I.feature,B=C.appliesEffect;w=_,x=[b,...f.slice(0,E+1)],M=!0,_r(e,{...B,sourceId:C.ownerId});const k=C.ownerId===e.id;a.push({turn:n.turn,actorId:e.id,position:_,description:`${e.name} stepped on ${k?"their own":"a"} ${C.name}! ${B.name} for ${B.duration} turns!`,sound:"trap",witnessIds:R(n,[_])}),C.triggered=!0,I.feature=void 0;break}}e.position=w,a.push({turn:n.turn,actorId:e.id,position:w,description:M?`${e.name} moved toward (${r.targetPosition.x}, ${r.targetPosition.y}) but was caught in a trap at (${w.x}, ${w.y})!`:`${e.name} moved to (${w.x}, ${w.y})`,witnessIds:R(n,[w])});for(const E of n.characters)E.id!==e.id&&E.alive;return{success:!0,message:M?"Trapped!":"Moved successfully",events:a,animationData:{type:"move",path:x}}}case"move_toward":{const d=e.effects.find(k=>k.preventsMovement);if(d)return{success:!1,message:`${e.name} cannot move due to ${d.name}! (${d.duration} turns remaining)`,events:a};let f=jt(n,e.position,r.targetPosition,1e3);if(!f||f.length===0){const k=Wr(n,e);if(k.length===0)return{success:!1,message:"Cannot move - no reachable tiles",events:a};const A=r.targetPosition,U=k.reduce((W,he)=>{const Ge=Math.abs(he.x-A.x)+Math.abs(he.y-A.y),ar=Math.abs(W.x-A.x)+Math.abs(W.y-A.y);return Ge<ar?he:W});if(f=jt(n,e.position,U,e.movementRange),!f||f.length===0)return{success:!1,message:`Cannot find path toward (${r.targetPosition.x}, ${r.targetPosition.y})`,events:a}}const p=Math.min(f.length,e.movementRange),b=f.slice(0,p),w=b[b.length-1],M=n.characters.find(k=>k.alive&&k.id!==e.id&&rt(k.position,w));if(M)if(b.length>1)b.pop();else return{success:!1,message:`Path blocked by ${M.name}`,events:a};const x={...e.position};let E=b[b.length-1],_=!1,I=[x,...b];for(let k=0;k<b.length;k++){const A=b[k],U=n.tiles[A.y][A.x];if(((l=U.feature)==null?void 0:l.type)==="trap"&&!U.feature.triggered){const W=U.feature,he=W.appliesEffect;E=A,I=[x,...b.slice(0,k+1)],_=!0,_r(e,{...he,sourceId:W.ownerId});const Ge=W.ownerId===e.id;a.push({turn:n.turn,actorId:e.id,position:A,description:`${e.name} stepped on ${Ge?"their own":"a"} ${W.name}! ${he.name} for ${he.duration} turns!`,sound:"trap",witnessIds:R(n,[A])}),W.triggered=!0,U.feature=void 0;break}}e.position=E;const C=f.length-p,B=rt(E,r.targetPosition);return a.push({turn:n.turn,actorId:e.id,position:E,description:_?`${e.name} was caught in a trap at (${E.x}, ${E.y})!`:B?`${e.name} arrived at destination (${E.x}, ${E.y})`:`${e.name} moved toward (${r.targetPosition.x}, ${r.targetPosition.y}), now at (${E.x}, ${E.y}) - ${C} tiles remaining`,witnessIds:R(n,[E])}),{success:!0,message:_?"Trapped!":B?"Arrived at destination":`Moving toward destination (${C} tiles remaining)`,events:a,animationData:{type:"move",path:I}}}case"look_around":{const d=On(n,e);for(const f of d.tiles){const p=f.position,b=`${p.x},${p.y}`,w=d.characters.find(E=>E.position.x===p.x&&E.position.y===p.y),M=d.items.filter(E=>E.position.x===p.x&&E.position.y===p.y).map(E=>E.item.name),x=f.feature?{type:f.feature.type,name:f.feature.name}:void 0;e.mapMemory.set(b,{type:f.type,lastSeenTurn:n.turn,items:M.length>0?M:void 0,characterName:w==null?void 0:w.character.name,characterAlive:w==null?void 0:w.character.alive,feature:x})}return{success:!0,message:`Looked around. Saw ${d.characters.length} characters and ${d.items.length} items.`,events:a}}case"search_container":{const d=[e.position,...Gt(e.position)];let f,p;for(const w of d){if(w.x<0||w.x>=n.width||w.y<0||w.y>=n.height)continue;const M=n.tiles[w.y][w.x];if(((o=M.feature)==null?void 0:o.type)==="chest"&&M.feature.id===r.targetFeatureId){f=M.feature,p=w;break}}if(!f||!p)return{success:!1,message:"Chest not adjacent - must be within 1 tile to search",events:a};f.searched=!0;const b=f.contents??[];return a.push({turn:n.turn,sound:"search",actorId:e.id,position:p,description:`${e.name} searched ${f.name}`,witnessIds:R(n,[p])}),{success:!0,message:`Found ${b.length} items`,events:a}}case"pick_up":{const d=[e.position,...Gt(e.position)];let f,p;const b=r.targetItemName.toLowerCase();for(const w of d){if(w.x<0||w.x>=n.width||w.y<0||w.y>=n.height)continue;const M=n.tiles[w.y][w.x],x=M.items.findIndex(E=>E.name.toLowerCase()===b);if(x>=0){f=M.items[x],M.items.splice(x,1),p=w;break}if(((u=M.feature)==null?void 0:u.type)==="chest"&&M.feature.searched){const E=(M.feature.contents??[]).findIndex(_=>_.name.toLowerCase()===b);if(E>=0){f=M.feature.contents[E],M.feature.contents.splice(E,1),p=w;break}}if(f)break}return!f||!p?{success:!1,message:"Item not found nearby",events:a}:(e.inventory.push(f),a.push({turn:n.turn,sound:"pickup",actorId:e.id,itemId:f.id,position:e.position,description:`${e.name} picked up ${f.name}`,witnessIds:R(n,[e.position])}),{success:!0,message:`Picked up ${f.name}`,events:a,animationData:{type:"pickup",targetPosition:e.position,itemName:f.name}})}case"drop":{const d=e.inventory.findIndex(b=>b.id===r.targetItemId);if(d<0)return{success:!1,message:"Item not in inventory",events:a};const f=e.inventory[d];return e.inventory.splice(d,1),((i=e.equippedWeapon)==null?void 0:i.id)===f.id&&(e.equippedWeapon=void 0),((c=e.equippedClothing)==null?void 0:c.id)===f.id&&(e.equippedClothing=void 0),n.tiles[e.position.y][e.position.x].items.push(f),a.push({turn:n.turn,sound:"drop",actorId:e.id,itemId:f.id,position:e.position,description:`${e.name} dropped ${f.name}`,witnessIds:R(n,[e.position])}),{success:!0,message:`Dropped ${f.name}`,events:a}}case"equip":{const d=e.inventory.find(f=>f.id===r.targetItemId);if(!d)return{success:!1,message:"Item not in inventory",events:a};if(d.type==="weapon")e.equippedWeapon=d;else if(d.type==="clothing")e.equippedClothing=d;else return{success:!1,message:"Cannot equip this item type",events:a};return a.push({turn:n.turn,sound:"equip",actorId:e.id,itemId:d.id,description:`${e.name} equipped ${d.name}`,witnessIds:R(n,[e.position])}),{success:!0,message:`Equipped ${d.name}`,events:a}}case"unequip":{const d=e.inventory.find(f=>f.id===r.targetItemId);if(!d)return{success:!1,message:"Item not in inventory",events:a};if(d.type==="weapon"&&((m=e.equippedWeapon)==null?void 0:m.id)===d.id)e.equippedWeapon=void 0;else if(d.type==="clothing"&&((g=e.equippedClothing)==null?void 0:g.id)===d.id)e.equippedClothing=void 0;else return{success:!1,message:"Item is not equipped",events:a};return a.push({turn:n.turn,sound:"equip",actorId:e.id,itemId:d.id,description:`${e.name} unequipped ${d.name}`,witnessIds:R(n,[e.position])}),{success:!0,message:`Unequipped ${d.name}`,events:a}}case"use":{const d=e.inventory.find(b=>b.id===r.targetItemId);if(!d)return{success:!1,message:"Item not in inventory",events:a};if(!d.useEffect)return{success:!1,message:`${d.name} cannot be used`,events:a};const f=Nr(d.useEffect,e,n,d.name);a.push(...f.events);const p=e.inventory.findIndex(b=>b.id===r.targetItemId);return p>=0&&e.inventory.splice(p,1),a.push({turn:n.turn,sound:"use",actorId:e.id,itemId:d.id,description:`${e.name} used ${d.name} and ${f.description}`,witnessIds:R(n,[e.position])}),{success:!0,message:`Used ${d.name}`,events:a}}case"attack":{const d=n.characters.find(w=>w.id===r.targetCharacterId);if(!d)return{success:!1,message:"Target not found",events:a};if(!d.alive)return{success:!1,message:"Target is already dead",events:a};if(!gs(e.position,d.position))return{success:!1,message:"Target too far away",events:a};const{damage:f,roll:p}=Co(e),b=((h=e.equippedWeapon)==null?void 0:h.name)??"fists";if(f===0)a.push({turn:n.turn,sound:"miss",actorId:e.id,targetId:d.id,description:p===1?`${e.name} critically missed attacking ${d.name}!`:`${e.name} missed ${d.name} with ${b} (rolled ${p})`,witnessIds:R(n,[d.position])});else{d.hp-=f;const w=p===20;if(a.push({turn:n.turn,sound:"attack",actorId:e.id,targetId:d.id,damage:f,description:w?`${e.name} CRITICAL HIT ${d.name} with ${b} for ${f} damage!`:`${e.name} hit ${d.name} with ${b} for ${f} damage`,witnessIds:R(n,[d.position])}),d.hp<=0){d.hp=0,d.alive=!1;const M=n.tiles[d.position.y][d.position.x];for(const x of d.inventory)M.items.push(x);if(d.inventory.length>0){const x=d.inventory.map(E=>E.name).join(", ");a.push({turn:n.turn,sound:"drop",actorId:d.id,position:d.position,description:`${d.name}'s items fell to the ground: ${x}`,witnessIds:R(n,[d.position])})}d.inventory=[],d.equippedWeapon=void 0,d.equippedClothing=void 0,a.push({turn:n.turn,sound:"death",actorId:e.id,targetId:d.id,description:`${d.name} has been killed by ${e.name}!`,witnessIds:R(n,[d.position])})}}return{success:!0,message:f>0?`Hit for ${f} damage`:"Missed",events:a,animationData:{type:"attack",targetPosition:d.position,damage:f,missed:f===0}}}case"talk":{const d=n.characters.find(f=>f.id===r.targetCharacterId);return d?d.alive?Ye(e.position,d.position)>Ne?{success:!1,message:"Target too far away to talk",events:a}:(a.push({turn:n.turn,actorId:e.id,targetId:d.id,message:r.message,description:`${e.name} to ${d.name}: "${r.message.replace(/\n/g," ")}"`,witnessIds:R(n,[e.position,d.position])}),{success:!0,message:"Message delivered",events:a}):{success:!1,message:"Cannot talk to the dead",events:a}:{success:!1,message:"Target not found",events:a}}case"place":{const d=Math.abs(r.targetPosition.x-e.position.x),f=Math.abs(r.targetPosition.y-e.position.y);if(d>1||f>1||d===0&&f===0)return{success:!1,message:"Can only place trap on adjacent tile (not current tile)",events:a};if(r.targetPosition.x<0||r.targetPosition.x>=n.width||r.targetPosition.y<0||r.targetPosition.y>=n.height)return{success:!1,message:"Target tile out of bounds",events:a};const p=n.tiles[r.targetPosition.y][r.targetPosition.x];if(!at(p))return{success:!1,message:"Cannot place trap on non-walkable tile",events:a};if(p.feature)return{success:!1,message:"Cannot place trap on a tile with a feature",events:a};const b=e.inventory.find(x=>x.id===r.targetItemId);if(!b)return{success:!1,message:"Trap not in inventory",events:a};if(b.type!=="trap")return{success:!1,message:"Item is not a trap",events:a};const w=e.inventory.findIndex(x=>x.id===b.id);e.inventory.splice(w,1);const M={id:Z(),name:"Trapped",duration:5,preventsMovement:!0,triggers:[{on:"turn_start",actions:[{type:"damage",amount:3}]},{on:"on_attack",actions:[{type:"modify_stat",stat:"attack",operation:"multiply",value:.5}]}]};return p.feature={type:"trap",id:b.id,name:b.name,ownerId:e.id,witnessIds:R(n,[r.targetPosition]),appliesEffect:b.trapEffect??M,triggered:!1},a.push({turn:n.turn,actorId:e.id,itemId:b.id,position:{...r.targetPosition},description:`${e.name} placed a ${b.name} at (${r.targetPosition.x}, ${r.targetPosition.y})`,witnessIds:R(n,[r.targetPosition])}),{success:!0,message:`Placed ${b.name} at (${r.targetPosition.x}, ${r.targetPosition.y}) - invisible to enemies!`,events:a,animationData:{type:"place",targetPosition:e.position,itemName:b.name}}}case"issue_contract":{if(r.contractExpiry<1||r.contractExpiry>20)return{success:!1,message:"Contract expiry must be between 1 and 20 turns",events:a};const d=n.characters.find(b=>b.id===r.targetCharacterId);if(!d)return{success:!1,message:"Target character not found",events:a};if(d.id===e.id)return{success:!1,message:"Cannot issue contract to yourself",events:a};if(!d.alive)return{success:!1,message:"Target character is dead",events:a};const f=Ye(e.position,d.position);if(f>Ne)return{success:!1,message:`${d.name} is too far away (${f} tiles, max ${Ne})`,events:a};const p=r.message?` saying "${r.message}"`:"";return a.push({turn:n.turn,actorId:e.id,targetId:d.id,message:r.contractContents,description:`${e.name} offers a Blood Contract to ${d.name}${p}: "${r.contractContents}" (${r.contractExpiry} turns)`,witnessIds:[e.id,d.id]}),{success:!0,message:`Blood Contract offered to ${d.name}`,events:a}}case"sign_contract":return{success:!0,message:"Agreed to sign the contract",events:a};case"decline_contract":return{success:!0,message:"Declined the contract",events:a};case"unlock":{const d=Gt(e.position);let f,p,b;for(const _ of d){if(_.x<0||_.x>=n.width||_.y<0||_.y>=n.height)continue;const I=n.tiles[_.y][_.x];if(((y=I.feature)==null?void 0:y.type)==="door"&&I.feature.id===r.targetFeatureId){f=_,p=I,b=I.feature;break}}if(!f||!p||!b)return{success:!1,message:"No matching door adjacent to unlock",events:a};if(!b.locked)return{success:!1,message:"This door is not locked",events:a};if(b.open)return{success:!1,message:"This door is already open",events:a};const w=e.inventory.findIndex(_=>_.type==="key"&&_.unlocksFeatureId===b.id);if(w===-1)return{success:!1,message:`You need the correct key to unlock ${b.name}`,events:a};const M=e.inventory[w].name;e.inventory.splice(w,1),b.locked=!1,b.open=!0;const x={turn:n.turn,sound:"drop",actorId:e.id,description:`ðŸ”‘ ${e.name} uses ${M} (key consumed)`,witnessIds:R(n,[e.position])};a.push(x);const E={turn:n.turn,sound:"unlock",actorId:e.id,position:f,description:`ðŸ”“ ${e.name} unlocks ${b.name} at (${f.x}, ${f.y})!`,witnessIds:R(n,[f])};a.push(E);for(const _ of n.characters)_.alive&&bs(n,_.position,f)&&_.mapMemory.set(`${f.x},${f.y}`,{type:p.type,lastSeenTurn:n.turn,feature:{type:"door",name:b.name}});return{success:!0,message:`Unlocked ${b.name}`,events:a}}case"wait":return{success:!0,message:`${e.name} waits`,events:a};default:return{success:!1,message:"Unknown action type",events:a}}}function So(n,e,r){return bs(n,e.position,r)&&Ye(e.position,r)<=e.viewDistance}function R(n,e){return n.characters.filter(r=>r.alive&&e.some(a=>So(n,r,a))).map(r=>r.id)}function qr(n,e){var i,c;const r=On(n,e),a=[{type:"look_around"},{type:"wait"}],{x:s,y:l}=e.position,o=[];for(let m=-e.movementRange;m<=e.movementRange;m++)for(let g=-e.movementRange;g<=e.movementRange;g++){if(g===0&&m===0)continue;const h={x:s+g,y:l+m};h.x>=0&&h.x<n.width&&h.y>=0&&h.y<n.height&&jt(n,e.position,h,e.movementRange)&&o.push(h)}for(const m of o)a.push({type:"move",targetPosition:m});const u=n.tiles[l][s];for(const m of u.items)a.push({type:"pick_up",targetItemName:m.name});if(((i=u.feature)==null?void 0:i.type)==="chest"&&(a.push({type:"search_container",targetFeatureId:u.feature.id}),u.feature.searched&&u.feature.contents))for(const m of u.feature.contents)a.push({type:"pick_up",targetItemName:m.name});((c=u.feature)==null?void 0:c.type)==="door"&&u.feature.locked&&a.push({type:"unlock",targetFeatureId:u.feature.id});for(const m of e.inventory)a.push({type:"drop",targetItemId:m.id}),(m.type==="weapon"||m.type==="clothing")&&a.push({type:"equip",targetItemId:m.id});e.equippedWeapon&&a.push({type:"unequip",targetItemId:e.equippedWeapon.id}),e.equippedClothing&&a.push({type:"unequip",targetItemId:e.equippedClothing.id});for(const{character:m}of r.characters)gs(e.position,m.position)&&a.push({type:"attack",targetCharacterId:m.id});for(const m of n.characters)m.id===e.id||!m.alive||Ye(e.position,m.position)<=Ne&&a.push({type:"talk",targetCharacterId:m.id,message:""});return{status:{hp:e.hp,maxHp:e.maxHp,position:e.position,inventory:e.inventory,equippedWeapon:e.equippedWeapon,equippedClothing:e.equippedClothing},visible:r,witnessedEvents:n.events.filter(m=>m.witnessIds.includes(e.id)),possibleActions:a}}const Mr="RFC3986",kr={RFC1738:n=>String(n).replace(/%20/g,"+"),RFC3986:n=>String(n)},Po="RFC1738",Ao=Array.isArray,Be=(()=>{const n=[];for(let e=0;e<256;++e)n.push("%"+((e<16?"0":"")+e.toString(16)).toUpperCase());return n})(),sr=1024,To=(n,e,r,a,s)=>{if(n.length===0)return n;let l=n;if(typeof n=="symbol"?l=Symbol.prototype.toString.call(n):typeof n!="string"&&(l=String(n)),r==="iso-8859-1")return escape(l).replace(/%u[0-9a-f]{4}/gi,function(u){return"%26%23"+parseInt(u.slice(2),16)+"%3B"});let o="";for(let u=0;u<l.length;u+=sr){const i=l.length>=sr?l.slice(u,u+sr):l,c=[];for(let m=0;m<i.length;++m){let g=i.charCodeAt(m);if(g===45||g===46||g===95||g===126||g>=48&&g<=57||g>=65&&g<=90||g>=97&&g<=122||s===Po&&(g===40||g===41)){c[c.length]=i.charAt(m);continue}if(g<128){c[c.length]=Be[g];continue}if(g<2048){c[c.length]=Be[192|g>>6]+Be[128|g&63];continue}if(g<55296||g>=57344){c[c.length]=Be[224|g>>12]+Be[128|g>>6&63]+Be[128|g&63];continue}m+=1,g=65536+((g&1023)<<10|i.charCodeAt(m)&1023),c[c.length]=Be[240|g>>18]+Be[128|g>>12&63]+Be[128|g>>6&63]+Be[128|g&63]}o+=c.join("")}return o};function Bo(n){return!n||typeof n!="object"?!1:!!(n.constructor&&n.constructor.isBuffer&&n.constructor.isBuffer(n))}function La(n,e){if(Ao(n)){const r=[];for(let a=0;a<n.length;a+=1)r.push(e(n[a]));return r}return e(n)}const Fo=Object.prototype.hasOwnProperty,vs={brackets(n){return String(n)+"[]"},comma:"comma",indices(n,e){return String(n)+"["+e+"]"},repeat(n){return String(n)}},Fe=Array.isArray,Do=Array.prototype.push,_s=function(n,e){Do.apply(n,Fe(e)?e:[e])},Ro=Date.prototype.toISOString,Q={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:To,encodeValuesOnly:!1,format:Mr,formatter:kr[Mr],indices:!1,serializeDate(n){return Ro.call(n)},skipNulls:!1,strictNullHandling:!1};function Lo(n){return typeof n=="string"||typeof n=="number"||typeof n=="boolean"||typeof n=="symbol"||typeof n=="bigint"}const lr={};function Ms(n,e,r,a,s,l,o,u,i,c,m,g,h,y,d,f,p,b){let w=n,M=b,x=0,E=!1;for(;(M=M.get(lr))!==void 0&&!E;){const k=M.get(n);if(x+=1,typeof k<"u"){if(k===x)throw new RangeError("Cyclic object value");E=!0}typeof M.get(lr)>"u"&&(x=0)}if(typeof c=="function"?w=c(e,w):w instanceof Date?w=h==null?void 0:h(w):r==="comma"&&Fe(w)&&(w=La(w,function(k){return k instanceof Date?h==null?void 0:h(k):k})),w===null){if(l)return i&&!f?i(e,Q.encoder,p,"key",y):e;w=""}if(Lo(w)||Bo(w)){if(i){const k=f?e:i(e,Q.encoder,p,"key",y);return[(d==null?void 0:d(k))+"="+(d==null?void 0:d(i(w,Q.encoder,p,"value",y)))]}return[(d==null?void 0:d(e))+"="+(d==null?void 0:d(String(w)))]}const _=[];if(typeof w>"u")return _;let I;if(r==="comma"&&Fe(w))f&&i&&(w=La(w,i)),I=[{value:w.length>0?w.join(",")||null:void 0}];else if(Fe(c))I=c;else{const k=Object.keys(w);I=m?k.sort(m):k}const C=u?String(e).replace(/\./g,"%2E"):String(e),B=a&&Fe(w)&&w.length===1?C+"[]":C;if(s&&Fe(w)&&w.length===0)return B+"[]";for(let k=0;k<I.length;++k){const A=I[k],U=typeof A=="object"&&typeof A.value<"u"?A.value:w[A];if(o&&U===null)continue;const W=g&&u?A.replace(/\./g,"%2E"):A,he=Fe(w)?typeof r=="function"?r(B,W):B:B+(g?"."+W:"["+W+"]");b.set(n,x);const Ge=new WeakMap;Ge.set(lr,b),_s(_,Ms(U,he,r,a,s,l,o,u,r==="comma"&&f&&Fe(w)?null:i,c,m,g,h,y,d,f,p,Ge))}return _}function Oo(n=Q){if(typeof n.allowEmptyArrays<"u"&&typeof n.allowEmptyArrays!="boolean")throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(typeof n.encodeDotInKeys<"u"&&typeof n.encodeDotInKeys!="boolean")throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(n.encoder!==null&&typeof n.encoder<"u"&&typeof n.encoder!="function")throw new TypeError("Encoder has to be a function.");const e=n.charset||Q.charset;if(typeof n.charset<"u"&&n.charset!=="utf-8"&&n.charset!=="iso-8859-1")throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let r=Mr;if(typeof n.format<"u"){if(!Fo.call(kr,n.format))throw new TypeError("Unknown format option provided.");r=n.format}const a=kr[r];let s=Q.filter;(typeof n.filter=="function"||Fe(n.filter))&&(s=n.filter);let l;if(n.arrayFormat&&n.arrayFormat in vs?l=n.arrayFormat:"indices"in n?l=n.indices?"indices":"repeat":l=Q.arrayFormat,"commaRoundTrip"in n&&typeof n.commaRoundTrip!="boolean")throw new TypeError("`commaRoundTrip` must be a boolean, or absent");const o=typeof n.allowDots>"u"?n.encodeDotInKeys?!0:Q.allowDots:!!n.allowDots;return{addQueryPrefix:typeof n.addQueryPrefix=="boolean"?n.addQueryPrefix:Q.addQueryPrefix,allowDots:o,allowEmptyArrays:typeof n.allowEmptyArrays=="boolean"?!!n.allowEmptyArrays:Q.allowEmptyArrays,arrayFormat:l,charset:e,charsetSentinel:typeof n.charsetSentinel=="boolean"?n.charsetSentinel:Q.charsetSentinel,commaRoundTrip:!!n.commaRoundTrip,delimiter:typeof n.delimiter>"u"?Q.delimiter:n.delimiter,encode:typeof n.encode=="boolean"?n.encode:Q.encode,encodeDotInKeys:typeof n.encodeDotInKeys=="boolean"?n.encodeDotInKeys:Q.encodeDotInKeys,encoder:typeof n.encoder=="function"?n.encoder:Q.encoder,encodeValuesOnly:typeof n.encodeValuesOnly=="boolean"?n.encodeValuesOnly:Q.encodeValuesOnly,filter:s,format:r,formatter:a,serializeDate:typeof n.serializeDate=="function"?n.serializeDate:Q.serializeDate,skipNulls:typeof n.skipNulls=="boolean"?n.skipNulls:Q.skipNulls,sort:typeof n.sort=="function"?n.sort:null,strictNullHandling:typeof n.strictNullHandling=="boolean"?n.strictNullHandling:Q.strictNullHandling}}function No(n,e={}){let r=n;const a=Oo(e);let s,l;typeof a.filter=="function"?(l=a.filter,r=l("",r)):Fe(a.filter)&&(l=a.filter,s=l);const o=[];if(typeof r!="object"||r===null)return"";const u=vs[a.arrayFormat],i=u==="comma"&&a.commaRoundTrip;s||(s=Object.keys(r)),a.sort&&s.sort(a.sort);const c=new WeakMap;for(let h=0;h<s.length;++h){const y=s[h];a.skipNulls&&r[y]===null||_s(o,Ms(r[y],y,u,i,a.allowEmptyArrays,a.strictNullHandling,a.skipNulls,a.encodeDotInKeys,a.encode?a.encoder:null,a.filter,a.sort,a.allowDots,a.serializeDate,a.format,a.formatter,a.encodeValuesOnly,a.charset,c))}const m=o.join(a.delimiter);let g=a.addQueryPrefix===!0?"?":"";return a.charsetSentinel&&(a.charset==="iso-8859-1"?g+="utf8=%26%2310003%3B&":g+="utf8=%E2%9C%93&"),m.length>0?g+m:""}const ht="4.104.0";let Oa=!1,Jt,ks,xs,xr,Es,Is,$s,Cs,Ss;function Wo(n,e={auto:!1}){if(Oa)throw new Error(`you must \`import 'openai/shims/${n.kind}'\` before importing anything else from openai`);if(Jt)throw new Error(`can't \`import 'openai/shims/${n.kind}'\` after \`import 'openai/shims/${Jt}'\``);Oa=e.auto,Jt=n.kind,ks=n.fetch,xs=n.FormData,xr=n.File,Es=n.ReadableStream,Is=n.getMultipartRequestOptions,$s=n.getDefaultAgent,Cs=n.fileFromPath,Ss=n.isFsReadStream}class qo{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}}function Ho({manuallyImported:n}={}){const e=n?"You may need to use polyfills":"Add one of these imports before your first `import â€¦ from 'openai'`:\n- `import 'openai/shims/node'` (if you're running on Node)\n- `import 'openai/shims/web'` (otherwise)\n";let r,a,s,l;try{r=fetch,a=Request,s=Response,l=Headers}catch(o){throw new Error(`this environment is missing the following Web Fetch API type: ${o.message}. ${e}`)}return{kind:"web",fetch:r,Request:a,Response:s,Headers:l,FormData:typeof FormData<"u"?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${e}`)}},Blob:typeof Blob<"u"?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${e}`)}},File:typeof File<"u"?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${e}`)}},ReadableStream:typeof ReadableStream<"u"?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${e}`)}},getMultipartRequestOptions:async(o,u)=>({...u,body:new qo(o)}),getDefaultAgent:o=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/openai/openai-node#file-uploads")},isFsReadStream:o=>!1}}const Ps=()=>{Jt||Wo(Ho(),{auto:!0})};Ps();class T extends Error{}class le extends T{constructor(e,r,a,s){super(`${le.makeMessage(e,r,a)}`),this.status=e,this.headers=s,this.request_id=s==null?void 0:s["x-request-id"],this.error=r;const l=r;this.code=l==null?void 0:l.code,this.param=l==null?void 0:l.param,this.type=l==null?void 0:l.type}static makeMessage(e,r,a){const s=r!=null&&r.message?typeof r.message=="string"?r.message:JSON.stringify(r.message):r?JSON.stringify(r):a;return e&&s?`${e} ${s}`:e?`${e} status code (no body)`:s||"(no status code or body)"}static generate(e,r,a,s){if(!e||!s)return new Wn({message:a,cause:Ir(r)});const l=r==null?void 0:r.error;return e===400?new As(e,l,a,s):e===401?new Ts(e,l,a,s):e===403?new Bs(e,l,a,s):e===404?new Fs(e,l,a,s):e===409?new Ds(e,l,a,s):e===422?new Rs(e,l,a,s):e===429?new Ls(e,l,a,s):e>=500?new Os(e,l,a,s):new le(e,l,a,s)}}class Ie extends le{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}}class Wn extends le{constructor({message:e,cause:r}){super(void 0,void 0,e||"Connection error.",void 0),r&&(this.cause=r)}}class Hr extends Wn{constructor({message:e}={}){super({message:e??"Request timed out."})}}class As extends le{}class Ts extends le{}class Bs extends le{}class Fs extends le{}class Ds extends le{}class Rs extends le{}class Ls extends le{}class Os extends le{}class Ns extends T{constructor(){super("Could not parse response content as the length limit was reached")}}class Ws extends T{constructor(){super("Could not parse response content as the request was rejected by the content filter")}}var dn=function(n,e,r,a,s){if(a==="m")throw new TypeError("Private method is not writable");if(a==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!s:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return a==="a"?s.call(n,r):s?s.value=r:e.set(n,r),r},et=function(n,e,r,a){if(r==="a"&&!a)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return r==="m"?a:r==="a"?a.call(n):a?a.value:e.get(n)},_e;class qn{constructor(){_e.set(this,void 0),this.buffer=new Uint8Array,dn(this,_e,null,"f")}decode(e){if(e==null)return[];const r=e instanceof ArrayBuffer?new Uint8Array(e):typeof e=="string"?new TextEncoder().encode(e):e;let a=new Uint8Array(this.buffer.length+r.length);a.set(this.buffer),a.set(r,this.buffer.length),this.buffer=a;const s=[];let l;for(;(l=Uo(this.buffer,et(this,_e,"f")))!=null;){if(l.carriage&&et(this,_e,"f")==null){dn(this,_e,l.index,"f");continue}if(et(this,_e,"f")!=null&&(l.index!==et(this,_e,"f")+1||l.carriage)){s.push(this.decodeText(this.buffer.slice(0,et(this,_e,"f")-1))),this.buffer=this.buffer.slice(et(this,_e,"f")),dn(this,_e,null,"f");continue}const o=et(this,_e,"f")!==null?l.preceding-1:l.preceding,u=this.decodeText(this.buffer.slice(0,o));s.push(u),this.buffer=this.buffer.slice(l.index),dn(this,_e,null,"f")}return s}decodeText(e){if(e==null)return"";if(typeof e=="string")return e;if(typeof Buffer<"u"){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new T(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if(typeof TextDecoder<"u"){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new T(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new T("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){return this.buffer.length?this.decode(`
`):[]}}_e=new WeakMap;qn.NEWLINE_CHARS=new Set([`
`,"\r"]);qn.NEWLINE_REGEXP=/\r\n|[\n\r]/g;function Uo(n,e){for(let s=e??0;s<n.length;s++){if(n[s]===10)return{preceding:s,index:s+1,carriage:!1};if(n[s]===13)return{preceding:s,index:s+1,carriage:!0}}return null}function Go(n){for(let a=0;a<n.length-1;a++){if(n[a]===10&&n[a+1]===10||n[a]===13&&n[a+1]===13)return a+2;if(n[a]===13&&n[a+1]===10&&a+3<n.length&&n[a+2]===13&&n[a+3]===10)return a+4}return-1}function qs(n){if(n[Symbol.asyncIterator])return n;const e=n.getReader();return{async next(){try{const r=await e.read();return r!=null&&r.done&&e.releaseLock(),r}catch(r){throw e.releaseLock(),r}},async return(){const r=e.cancel();return e.releaseLock(),await r,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}class Re{constructor(e,r){this.iterator=e,this.controller=r}static fromSSEResponse(e,r){let a=!1;async function*s(){if(a)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");a=!0;let l=!1;try{for await(const o of jo(e,r))if(!l){if(o.data.startsWith("[DONE]")){l=!0;continue}if(o.event===null||o.event.startsWith("response.")||o.event.startsWith("transcript.")){let u;try{u=JSON.parse(o.data)}catch(i){throw console.error("Could not parse message into JSON:",o.data),console.error("From chunk:",o.raw),i}if(u&&u.error)throw new le(void 0,u.error,void 0,Ks(e.headers));yield u}else{let u;try{u=JSON.parse(o.data)}catch(i){throw console.error("Could not parse message into JSON:",o.data),console.error("From chunk:",o.raw),i}if(o.event=="error")throw new le(void 0,u.error,u.message,void 0);yield{event:o.event,data:u}}}l=!0}catch(o){if(o instanceof Error&&o.name==="AbortError")return;throw o}finally{l||r.abort()}}return new Re(s,r)}static fromReadableStream(e,r){let a=!1;async function*s(){const o=new qn,u=qs(e);for await(const i of u)for(const c of o.decode(i))yield c;for(const i of o.flush())yield i}async function*l(){if(a)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");a=!0;let o=!1;try{for await(const u of s())o||u&&(yield JSON.parse(u));o=!0}catch(u){if(u instanceof Error&&u.name==="AbortError")return;throw u}finally{o||r.abort()}}return new Re(l,r)}[Symbol.asyncIterator](){return this.iterator()}tee(){const e=[],r=[],a=this.iterator(),s=l=>({next:()=>{if(l.length===0){const o=a.next();e.push(o),r.push(o)}return l.shift()}});return[new Re(()=>s(e),this.controller),new Re(()=>s(r),this.controller)]}toReadableStream(){const e=this;let r;const a=new TextEncoder;return new Es({async start(){r=e[Symbol.asyncIterator]()},async pull(s){try{const{value:l,done:o}=await r.next();if(o)return s.close();const u=a.encode(JSON.stringify(l)+`
`);s.enqueue(u)}catch(l){s.error(l)}},async cancel(){var s;await((s=r.return)==null?void 0:s.call(r))}})}}async function*jo(n,e){if(!n.body)throw e.abort(),new T("Attempted to iterate over a response with no body");const r=new Vo,a=new qn,s=qs(n.body);for await(const l of Jo(s))for(const o of a.decode(l)){const u=r.decode(o);u&&(yield u)}for(const l of a.flush()){const o=r.decode(l);o&&(yield o)}}async function*Jo(n){let e=new Uint8Array;for await(const r of n){if(r==null)continue;const a=r instanceof ArrayBuffer?new Uint8Array(r):typeof r=="string"?new TextEncoder().encode(r):r;let s=new Uint8Array(e.length+a.length);s.set(e),s.set(a,e.length),e=s;let l;for(;(l=Go(e))!==-1;)yield e.slice(0,l),e=e.slice(l)}e.length>0&&(yield e)}class Vo{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const l={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],l}if(this.chunks.push(e),e.startsWith(":"))return null;let[r,a,s]=Ko(e,":");return s.startsWith(" ")&&(s=s.substring(1)),r==="event"?this.event=s:r==="data"&&this.data.push(s),null}}function Ko(n,e){const r=n.indexOf(e);return r!==-1?[n.substring(0,r),e,n.substring(r+e.length)]:[n,"",""]}const Hs=n=>n!=null&&typeof n=="object"&&typeof n.url=="string"&&typeof n.blob=="function",Us=n=>n!=null&&typeof n=="object"&&typeof n.name=="string"&&typeof n.lastModified=="number"&&Hn(n),Hn=n=>n!=null&&typeof n=="object"&&typeof n.size=="number"&&typeof n.type=="string"&&typeof n.text=="function"&&typeof n.slice=="function"&&typeof n.arrayBuffer=="function",Yo=n=>Us(n)||Hs(n)||Ss(n);async function Gs(n,e,r){var s;if(n=await n,Us(n))return n;if(Hs(n)){const l=await n.blob();e||(e=new URL(n.url).pathname.split(/[\\/]/).pop()??"unknown_file");const o=Hn(l)?[await l.arrayBuffer()]:[l];return new xr(o,e,r)}const a=await zo(n);if(e||(e=Qo(n)??"unknown_file"),!(r!=null&&r.type)){const l=(s=a[0])==null?void 0:s.type;typeof l=="string"&&(r={...r,type:l})}return new xr(a,e,r)}async function zo(n){var r;let e=[];if(typeof n=="string"||ArrayBuffer.isView(n)||n instanceof ArrayBuffer)e.push(n);else if(Hn(n))e.push(await n.arrayBuffer());else if(Zo(n))for await(const a of n)e.push(a);else throw new Error(`Unexpected data type: ${typeof n}; constructor: ${(r=n==null?void 0:n.constructor)==null?void 0:r.name}; props: ${Xo(n)}`);return e}function Xo(n){return`[${Object.getOwnPropertyNames(n).map(r=>`"${r}"`).join(", ")}]`}function Qo(n){var e;return or(n.name)||or(n.filename)||((e=or(n.path))==null?void 0:e.split(/[\\/]/).pop())}const or=n=>{if(typeof n=="string")return n;if(typeof Buffer<"u"&&n instanceof Buffer)return String(n)},Zo=n=>n!=null&&typeof n=="object"&&typeof n[Symbol.asyncIterator]=="function",Na=n=>n&&typeof n=="object"&&n.body&&n[Symbol.toStringTag]==="MultipartBody",st=async n=>{const e=await ei(n.body);return Is(e,n)},ei=async n=>{const e=new xs;return await Promise.all(Object.entries(n||{}).map(([r,a])=>Er(e,r,a))),e},Er=async(n,e,r)=>{if(r!==void 0){if(r==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof r=="string"||typeof r=="number"||typeof r=="boolean")n.append(e,String(r));else if(Yo(r)){const a=await Gs(r);n.append(e,a)}else if(Array.isArray(r))await Promise.all(r.map(a=>Er(n,e+"[]",a)));else if(typeof r=="object")await Promise.all(Object.entries(r).map(([a,s])=>Er(n,`${e}[${a}]`,s)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${r} instead`)}};var vt={},ti=function(n,e,r,a,s){if(typeof e=="function"?n!==e||!0:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return e.set(n,r),r},ni=function(n,e,r,a){if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return r==="m"?a:r==="a"?a.call(n):a?a.value:e.get(n)},fn;Ps();async function js(n){var o;const{response:e}=n;if(n.options.stream)return ze("response",e.status,e.url,e.headers,e.body),n.options.__streamClass?n.options.__streamClass.fromSSEResponse(e,n.controller):Re.fromSSEResponse(e,n.controller);if(e.status===204)return null;if(n.options.__binaryResponse)return e;const r=e.headers.get("content-type"),a=(o=r==null?void 0:r.split(";")[0])==null?void 0:o.trim();if((a==null?void 0:a.includes("application/json"))||(a==null?void 0:a.endsWith("+json"))){const u=await e.json();return ze("response",e.status,e.url,e.headers,u),Js(u,e)}const l=await e.text();return ze("response",e.status,e.url,e.headers,l),l}function Js(n,e){return!n||typeof n!="object"||Array.isArray(n)?n:Object.defineProperty(n,"_request_id",{value:e.headers.get("x-request-id"),enumerable:!1})}class Un extends Promise{constructor(e,r=js){super(a=>{a(null)}),this.responsePromise=e,this.parseResponse=r}_thenUnwrap(e){return new Un(this.responsePromise,async r=>Js(e(await this.parseResponse(r),r),r.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){const[e,r]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:r,request_id:r.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,r){return this.parse().then(e,r)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}class ri{constructor({baseURL:e,maxRetries:r=2,timeout:a=6e5,httpAgent:s,fetch:l}){this.baseURL=e,this.maxRetries=ir("maxRetries",r),this.timeout=ir("timeout",a),this.httpAgent=s,this.fetch=l??ks}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...ii(),...this.authHeaders(e)}}validateHeaders(e,r){}defaultIdempotencyKey(){return`stainless-node-retry-${fi()}`}get(e,r){return this.methodRequest("get",e,r)}post(e,r){return this.methodRequest("post",e,r)}patch(e,r){return this.methodRequest("patch",e,r)}put(e,r){return this.methodRequest("put",e,r)}delete(e,r){return this.methodRequest("delete",e,r)}methodRequest(e,r,a){return this.request(Promise.resolve(a).then(async s=>{const l=s&&Hn(s==null?void 0:s.body)?new DataView(await s.body.arrayBuffer()):(s==null?void 0:s.body)instanceof DataView?s.body:(s==null?void 0:s.body)instanceof ArrayBuffer?new DataView(s.body):s&&ArrayBuffer.isView(s==null?void 0:s.body)?new DataView(s.body.buffer):s==null?void 0:s.body;return{method:e,path:r,...s,body:l}}))}getAPIList(e,r,a){return this.requestAPIList(r,{method:"get",path:e,...a})}calculateContentLength(e){if(typeof e=="string"){if(typeof Buffer<"u")return Buffer.byteLength(e,"utf8").toString();if(typeof TextEncoder<"u")return new TextEncoder().encode(e).length.toString()}else if(ArrayBuffer.isView(e))return e.byteLength.toString();return null}buildRequest(e,{retryCount:r=0}={}){var f;const a={...e},{method:s,path:l,query:o,headers:u={}}=a,i=ArrayBuffer.isView(a.body)||a.__binaryRequest&&typeof a.body=="string"?a.body:Na(a.body)?a.body.body:a.body?JSON.stringify(a.body,null,2):null,c=this.calculateContentLength(i),m=this.buildURL(l,o);"timeout"in a&&ir("timeout",a.timeout),a.timeout=a.timeout??this.timeout;const g=a.httpAgent??this.httpAgent??$s(m),h=a.timeout+1e3;typeof((f=g==null?void 0:g.options)==null?void 0:f.timeout)=="number"&&h>(g.options.timeout??0)&&(g.options.timeout=h),this.idempotencyHeader&&s!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),u[this.idempotencyHeader]=e.idempotencyKey);const y=this.buildHeaders({options:a,headers:u,contentLength:c,retryCount:r});return{req:{method:s,...i&&{body:i},headers:y,...g&&{agent:g},signal:a.signal??null},url:m,timeout:a.timeout}}buildHeaders({options:e,headers:r,contentLength:a,retryCount:s}){const l={};a&&(l["content-length"]=a);const o=this.defaultHeaders(e);return Ua(l,o),Ua(l,r),Na(e.body)&&Jt!=="node"&&delete l["content-type"],pn(o,"x-stainless-retry-count")===void 0&&pn(r,"x-stainless-retry-count")===void 0&&(l["x-stainless-retry-count"]=String(s)),pn(o,"x-stainless-timeout")===void 0&&pn(r,"x-stainless-timeout")===void 0&&e.timeout&&(l["x-stainless-timeout"]=String(Math.trunc(e.timeout/1e3))),this.validateHeaders(l,r),l}async prepareOptions(e){}async prepareRequest(e,{url:r,options:a}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map(r=>[...r])):{...e}:{}}makeStatusError(e,r,a,s){return le.generate(e,r,a,s)}request(e,r=null){return new Un(this.makeRequest(e,r))}async makeRequest(e,r){var g,h;const a=await e,s=a.maxRetries??this.maxRetries;r==null&&(r=s),await this.prepareOptions(a);const{req:l,url:o,timeout:u}=this.buildRequest(a,{retryCount:s-r});if(await this.prepareRequest(l,{url:o,options:a}),ze("request",o,a,l.headers),(g=a.signal)!=null&&g.aborted)throw new Ie;const i=new AbortController,c=await this.fetchWithTimeout(o,l,u,i).catch(Ir);if(c instanceof Error){if((h=a.signal)!=null&&h.aborted)throw new Ie;if(r)return this.retryRequest(a,r);throw c.name==="AbortError"?new Hr:new Wn({cause:c})}const m=Ks(c.headers);if(!c.ok){if(r&&this.shouldRetry(c)){const w=`retrying, ${r} attempts remaining`;return ze(`response (error; ${w})`,c.status,o,m),this.retryRequest(a,r,m)}const y=await c.text().catch(w=>Ir(w).message),d=ui(y),f=d?void 0:y;throw ze(`response (error; ${r?"(error; no more retries left)":"(error; not retryable)"})`,c.status,o,m,f),this.makeStatusError(c.status,d,f,m)}return{response:c,options:a,controller:i}}requestAPIList(e,r){const a=this.makeRequest(r,null);return new ai(this,a,e)}buildURL(e,r){const a=di(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),s=this.defaultQuery();return Ys(s)||(r={...s,...r}),typeof r=="object"&&r&&!Array.isArray(r)&&(a.search=this.stringifyQuery(r)),a.toString()}stringifyQuery(e){return Object.entries(e).filter(([r,a])=>typeof a<"u").map(([r,a])=>{if(typeof a=="string"||typeof a=="number"||typeof a=="boolean")return`${encodeURIComponent(r)}=${encodeURIComponent(a)}`;if(a===null)return`${encodeURIComponent(r)}=`;throw new T(`Cannot stringify type ${typeof a}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(e,r,a,s){const{signal:l,...o}=r||{};l&&l.addEventListener("abort",()=>s.abort());const u=setTimeout(()=>s.abort(),a),i={signal:s.signal,...o};return i.method&&(i.method=i.method.toUpperCase()),this.fetch.call(void 0,e,i).finally(()=>{clearTimeout(u)})}shouldRetry(e){const r=e.headers.get("x-should-retry");return r==="true"?!0:r==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,r,a){let s;const l=a==null?void 0:a["retry-after-ms"];if(l){const u=parseFloat(l);Number.isNaN(u)||(s=u)}const o=a==null?void 0:a["retry-after"];if(o&&!s){const u=parseFloat(o);Number.isNaN(u)?s=Date.parse(o)-Date.now():s=u*1e3}if(!(s&&0<=s&&s<60*1e3)){const u=e.maxRetries??this.maxRetries;s=this.calculateDefaultRetryTimeoutMillis(r,u)}return await Zt(s),this.makeRequest(e,r-1)}calculateDefaultRetryTimeoutMillis(e,r){const l=r-e,o=Math.min(.5*Math.pow(2,l),8),u=1-Math.random()*.25;return o*u*1e3}getUserAgent(){return`${this.constructor.name}/JS ${ht}`}}class Vs{constructor(e,r,a,s){fn.set(this,void 0),ti(this,fn,e),this.options=s,this.response=r,this.body=a}hasNextPage(){return this.getPaginatedItems().length?this.nextPageInfo()!=null:!1}async getNextPage(){const e=this.nextPageInfo();if(!e)throw new T("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");const r={...this.options};if("params"in e&&typeof r.query=="object")r.query={...r.query,...e.params};else if("url"in e){const a=[...Object.entries(r.query||{}),...e.url.searchParams.entries()];for(const[s,l]of a)e.url.searchParams.set(s,l);r.query=void 0,r.path=e.url.toString()}return await ni(this,fn,"f").requestAPIList(this.constructor,r)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(fn=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const r of e.getPaginatedItems())yield r}}class ai extends Un{constructor(e,r,a){super(r,async s=>new a(e,s.response,await js(s),s.options))}async*[Symbol.asyncIterator](){const e=await this;for await(const r of e)yield r}}const Ks=n=>new Proxy(Object.fromEntries(n.entries()),{get(e,r){const a=r.toString();return e[a.toLowerCase()]||e[a]}}),si={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__metadata:!0,__binaryRequest:!0,__binaryResponse:!0,__streamClass:!0},j=n=>typeof n=="object"&&n!==null&&!Ys(n)&&Object.keys(n).every(e=>zs(si,e)),li=()=>{var e;if(typeof Deno<"u"&&Deno.build!=null)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":ht,"X-Stainless-OS":qa(Deno.build.os),"X-Stainless-Arch":Wa(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:((e=Deno.version)==null?void 0:e.deno)??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":ht,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if(Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":ht,"X-Stainless-OS":qa(process.platform),"X-Stainless-Arch":Wa(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};const n=oi();return n?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":ht,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${n.browser}`,"X-Stainless-Runtime-Version":n.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":ht,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function oi(){if(typeof navigator>"u"||!navigator)return null;const n=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:e,pattern:r}of n){const a=r.exec(navigator.userAgent);if(a){const s=a[1]||0,l=a[2]||0,o=a[3]||0;return{browser:e,version:`${s}.${l}.${o}`}}}return null}const Wa=n=>n==="x32"?"x32":n==="x86_64"||n==="x64"?"x64":n==="arm"?"arm":n==="aarch64"||n==="arm64"?"arm64":n?`other:${n}`:"unknown",qa=n=>(n=n.toLowerCase(),n.includes("ios")?"iOS":n==="android"?"Android":n==="darwin"?"MacOS":n==="win32"?"Windows":n==="freebsd"?"FreeBSD":n==="openbsd"?"OpenBSD":n==="linux"?"Linux":n?`Other:${n}`:"Unknown");let Ha;const ii=()=>Ha??(Ha=li()),ui=n=>{try{return JSON.parse(n)}catch{return}},ci=/^[a-z][a-z0-9+.-]*:/i,di=n=>ci.test(n),Zt=n=>new Promise(e=>setTimeout(e,n)),ir=(n,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new T(`${n} must be an integer`);if(e<0)throw new T(`${n} must be a positive integer`);return e},Ir=n=>{if(n instanceof Error)return n;if(typeof n=="object"&&n!==null)try{return new Error(JSON.stringify(n))}catch{}return new Error(n)},mn=n=>{var e,r,a,s;if(typeof process<"u")return((e=vt==null?void 0:vt[n])==null?void 0:e.trim())??void 0;if(typeof Deno<"u")return(s=(a=(r=Deno.env)==null?void 0:r.get)==null?void 0:a.call(r,n))==null?void 0:s.trim()};function Ys(n){if(!n)return!0;for(const e in n)return!1;return!0}function zs(n,e){return Object.prototype.hasOwnProperty.call(n,e)}function Ua(n,e){for(const r in e){if(!zs(e,r))continue;const a=r.toLowerCase();if(!a)continue;const s=e[r];s===null?delete n[a]:s!==void 0&&(n[a]=s)}}const Ga=new Set(["authorization","api-key"]);function ze(n,...e){if(typeof process<"u"&&(vt==null?void 0:vt.DEBUG)==="true"){const r=e.map(a=>{if(!a)return a;if(a.headers){const l={...a,headers:{...a.headers}};for(const o in a.headers)Ga.has(o.toLowerCase())&&(l.headers[o]="REDACTED");return l}let s=null;for(const l in a)Ga.has(l.toLowerCase())&&(s??(s={...a}),s[l]="REDACTED");return s??a});console.log(`OpenAI:DEBUG:${n}`,...r)}}const fi=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,n=>{const e=Math.random()*16|0;return(n==="x"?e:e&3|8).toString(16)}),mi=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u",pi=n=>typeof(n==null?void 0:n.get)=="function",pn=(n,e)=>{var a;const r=e.toLowerCase();if(pi(n)){const s=((a=e[0])==null?void 0:a.toUpperCase())+e.substring(1).replace(/([^\w])(\w)/g,(l,o,u)=>o+u.toUpperCase());for(const l of[e,r,e.toUpperCase(),s]){const o=n.get(l);if(o)return o}}for(const[s,l]of Object.entries(n))if(s.toLowerCase()===r)return Array.isArray(l)?(l.length<=1||console.warn(`Received ${l.length} entries for the ${e} header, using the first entry.`),l[0]):l},hi=n=>{if(typeof Buffer<"u"){const e=Buffer.from(n,"base64");return Array.from(new Float32Array(e.buffer,e.byteOffset,e.length/Float32Array.BYTES_PER_ELEMENT))}else{const e=atob(n),r=e.length,a=new Uint8Array(r);for(let s=0;s<r;s++)a[s]=e.charCodeAt(s);return Array.from(new Float32Array(a.buffer))}};function ur(n){return n!=null&&typeof n=="object"&&!Array.isArray(n)}class Gn extends Vs{constructor(e,r,a,s){super(e,r,a,s),this.data=a.data||[],this.object=a.object}getPaginatedItems(){return this.data??[]}nextPageParams(){return null}nextPageInfo(){return null}}class ee extends Vs{constructor(e,r,a,s){super(e,r,a,s),this.data=a.data||[],this.has_more=a.has_more||!1}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageParams(){const e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;const r=Object.fromEntries(e.url.searchParams);return Object.keys(r).length?r:null}nextPageInfo(){var a;const e=this.getPaginatedItems();if(!e.length)return null;const r=(a=e[e.length-1])==null?void 0:a.id;return r?{params:{after:r}}:null}}class F{constructor(e){this._client=e}}let Xs=class extends F{list(e,r={},a){return j(r)?this.list(e,{},r):this._client.getAPIList(`/chat/completions/${e}/messages`,gi,{query:r,...a})}},jn=class extends F{constructor(){super(...arguments),this.messages=new Xs(this._client)}create(e,r){return this._client.post("/chat/completions",{body:e,...r,stream:e.stream??!1})}retrieve(e,r){return this._client.get(`/chat/completions/${e}`,r)}update(e,r,a){return this._client.post(`/chat/completions/${e}`,{body:r,...a})}list(e={},r){return j(e)?this.list({},e):this._client.getAPIList("/chat/completions",Jn,{query:e,...r})}del(e,r){return this._client.delete(`/chat/completions/${e}`,r)}};class Jn extends ee{}class gi extends ee{}jn.ChatCompletionsPage=Jn;jn.Messages=Xs;let Vn=class extends F{constructor(){super(...arguments),this.completions=new jn(this._client)}};Vn.Completions=jn;Vn.ChatCompletionsPage=Jn;class Qs extends F{create(e,r){return this._client.post("/audio/speech",{body:e,...r,headers:{Accept:"application/octet-stream",...r==null?void 0:r.headers},__binaryResponse:!0})}}class Zs extends F{create(e,r){return this._client.post("/audio/transcriptions",st({body:e,...r,stream:e.stream??!1,__metadata:{model:e.model}}))}}class el extends F{create(e,r){return this._client.post("/audio/translations",st({body:e,...r,__metadata:{model:e.model}}))}}let en=class extends F{constructor(){super(...arguments),this.transcriptions=new Zs(this._client),this.translations=new el(this._client),this.speech=new Qs(this._client)}};en.Transcriptions=Zs;en.Translations=el;en.Speech=Qs;class Ur extends F{create(e,r){return this._client.post("/batches",{body:e,...r})}retrieve(e,r){return this._client.get(`/batches/${e}`,r)}list(e={},r){return j(e)?this.list({},e):this._client.getAPIList("/batches",Gr,{query:e,...r})}cancel(e,r){return this._client.post(`/batches/${e}/cancel`,r)}}class Gr extends ee{}Ur.BatchesPage=Gr;var Ce=function(n,e,r,a,s){if(a==="m")throw new TypeError("Private method is not writable");if(a==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!s:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return a==="a"?s.call(n,r):s?s.value=r:e.set(n,r),r},G=function(n,e,r,a){if(r==="a"&&!a)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return r==="m"?a:r==="a"?a.call(n):a?a.value:e.get(n)},$r,En,In,Lt,Ot,$n,Nt,Oe,Wt,Bn,Fn,gt,tl;class jr{constructor(){$r.add(this),this.controller=new AbortController,En.set(this,void 0),In.set(this,()=>{}),Lt.set(this,()=>{}),Ot.set(this,void 0),$n.set(this,()=>{}),Nt.set(this,()=>{}),Oe.set(this,{}),Wt.set(this,!1),Bn.set(this,!1),Fn.set(this,!1),gt.set(this,!1),Ce(this,En,new Promise((e,r)=>{Ce(this,In,e,"f"),Ce(this,Lt,r,"f")}),"f"),Ce(this,Ot,new Promise((e,r)=>{Ce(this,$n,e,"f"),Ce(this,Nt,r,"f")}),"f"),G(this,En,"f").catch(()=>{}),G(this,Ot,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},G(this,$r,"m",tl).bind(this))},0)}_connected(){this.ended||(G(this,In,"f").call(this),this._emit("connect"))}get ended(){return G(this,Wt,"f")}get errored(){return G(this,Bn,"f")}get aborted(){return G(this,Fn,"f")}abort(){this.controller.abort()}on(e,r){return(G(this,Oe,"f")[e]||(G(this,Oe,"f")[e]=[])).push({listener:r}),this}off(e,r){const a=G(this,Oe,"f")[e];if(!a)return this;const s=a.findIndex(l=>l.listener===r);return s>=0&&a.splice(s,1),this}once(e,r){return(G(this,Oe,"f")[e]||(G(this,Oe,"f")[e]=[])).push({listener:r,once:!0}),this}emitted(e){return new Promise((r,a)=>{Ce(this,gt,!0,"f"),e!=="error"&&this.once("error",a),this.once(e,r)})}async done(){Ce(this,gt,!0,"f"),await G(this,Ot,"f")}_emit(e,...r){if(G(this,Wt,"f"))return;e==="end"&&(Ce(this,Wt,!0,"f"),G(this,$n,"f").call(this));const a=G(this,Oe,"f")[e];if(a&&(G(this,Oe,"f")[e]=a.filter(s=>!s.once),a.forEach(({listener:s})=>s(...r))),e==="abort"){const s=r[0];!G(this,gt,"f")&&!(a!=null&&a.length)&&Promise.reject(s),G(this,Lt,"f").call(this,s),G(this,Nt,"f").call(this,s),this._emit("end");return}if(e==="error"){const s=r[0];!G(this,gt,"f")&&!(a!=null&&a.length)&&Promise.reject(s),G(this,Lt,"f").call(this,s),G(this,Nt,"f").call(this,s),this._emit("end")}}_emitFinal(){}}En=new WeakMap,In=new WeakMap,Lt=new WeakMap,Ot=new WeakMap,$n=new WeakMap,Nt=new WeakMap,Oe=new WeakMap,Wt=new WeakMap,Bn=new WeakMap,Fn=new WeakMap,gt=new WeakMap,$r=new WeakSet,tl=function(e){if(Ce(this,Bn,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new Ie),e instanceof Ie)return Ce(this,Fn,!0,"f"),this._emit("abort",e);if(e instanceof T)return this._emit("error",e);if(e instanceof Error){const r=new T(e.message);return r.cause=e,this._emit("error",r)}return this._emit("error",new T(String(e)))};var P=function(n,e,r,a){if(r==="a"&&!a)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return r==="m"?a:r==="a"?a.call(n):a?a.value:e.get(n)},ve=function(n,e,r,a,s){if(a==="m")throw new TypeError("Private method is not writable");if(a==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!s:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return a==="a"?s.call(n,r):s?s.value=r:e.set(n,r),r},re,Cr,De,Cn,Se,nt,yt,tt,Dn,Me,Sn,Pn,Vt,qt,Ht,ja,Ja,Va,Ka,Ya,za,Xa;class Ae extends jr{constructor(){super(...arguments),re.add(this),Cr.set(this,[]),De.set(this,{}),Cn.set(this,{}),Se.set(this,void 0),nt.set(this,void 0),yt.set(this,void 0),tt.set(this,void 0),Dn.set(this,void 0),Me.set(this,void 0),Sn.set(this,void 0),Pn.set(this,void 0),Vt.set(this,void 0)}[(Cr=new WeakMap,De=new WeakMap,Cn=new WeakMap,Se=new WeakMap,nt=new WeakMap,yt=new WeakMap,tt=new WeakMap,Dn=new WeakMap,Me=new WeakMap,Sn=new WeakMap,Pn=new WeakMap,Vt=new WeakMap,re=new WeakSet,Symbol.asyncIterator)](){const e=[],r=[];let a=!1;return this.on("event",s=>{const l=r.shift();l?l.resolve(s):e.push(s)}),this.on("end",()=>{a=!0;for(const s of r)s.resolve(void 0);r.length=0}),this.on("abort",s=>{a=!0;for(const l of r)l.reject(s);r.length=0}),this.on("error",s=>{a=!0;for(const l of r)l.reject(s);r.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:a?{value:void 0,done:!0}:new Promise((l,o)=>r.push({resolve:l,reject:o})).then(l=>l?{value:l,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){const r=new Ae;return r._run(()=>r._fromReadableStream(e)),r}async _fromReadableStream(e,r){var l;const a=r==null?void 0:r.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort())),this._connected();const s=Re.fromReadableStream(e,this.controller);for await(const o of s)P(this,re,"m",qt).call(this,o);if((l=s.controller.signal)!=null&&l.aborted)throw new Ie;return this._addRun(P(this,re,"m",Ht).call(this))}toReadableStream(){return new Re(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,r,a,s,l){const o=new Ae;return o._run(()=>o._runToolAssistantStream(e,r,a,s,{...l,headers:{...l==null?void 0:l.headers,"X-Stainless-Helper-Method":"stream"}})),o}async _createToolAssistantStream(e,r,a,s,l){var c;const o=l==null?void 0:l.signal;o&&(o.aborted&&this.controller.abort(),o.addEventListener("abort",()=>this.controller.abort()));const u={...s,stream:!0},i=await e.submitToolOutputs(r,a,u,{...l,signal:this.controller.signal});this._connected();for await(const m of i)P(this,re,"m",qt).call(this,m);if((c=i.controller.signal)!=null&&c.aborted)throw new Ie;return this._addRun(P(this,re,"m",Ht).call(this))}static createThreadAssistantStream(e,r,a){const s=new Ae;return s._run(()=>s._threadAssistantStream(e,r,{...a,headers:{...a==null?void 0:a.headers,"X-Stainless-Helper-Method":"stream"}})),s}static createAssistantStream(e,r,a,s){const l=new Ae;return l._run(()=>l._runAssistantStream(e,r,a,{...s,headers:{...s==null?void 0:s.headers,"X-Stainless-Helper-Method":"stream"}})),l}currentEvent(){return P(this,Sn,"f")}currentRun(){return P(this,Pn,"f")}currentMessageSnapshot(){return P(this,Se,"f")}currentRunStepSnapshot(){return P(this,Vt,"f")}async finalRunSteps(){return await this.done(),Object.values(P(this,De,"f"))}async finalMessages(){return await this.done(),Object.values(P(this,Cn,"f"))}async finalRun(){if(await this.done(),!P(this,nt,"f"))throw Error("Final run was not received.");return P(this,nt,"f")}async _createThreadAssistantStream(e,r,a){var u;const s=a==null?void 0:a.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort()));const l={...r,stream:!0},o=await e.createAndRun(l,{...a,signal:this.controller.signal});this._connected();for await(const i of o)P(this,re,"m",qt).call(this,i);if((u=o.controller.signal)!=null&&u.aborted)throw new Ie;return this._addRun(P(this,re,"m",Ht).call(this))}async _createAssistantStream(e,r,a,s){var i;const l=s==null?void 0:s.signal;l&&(l.aborted&&this.controller.abort(),l.addEventListener("abort",()=>this.controller.abort()));const o={...a,stream:!0},u=await e.create(r,o,{...s,signal:this.controller.signal});this._connected();for await(const c of u)P(this,re,"m",qt).call(this,c);if((i=u.controller.signal)!=null&&i.aborted)throw new Ie;return this._addRun(P(this,re,"m",Ht).call(this))}static accumulateDelta(e,r){for(const[a,s]of Object.entries(r)){if(!e.hasOwnProperty(a)){e[a]=s;continue}let l=e[a];if(l==null){e[a]=s;continue}if(a==="index"||a==="type"){e[a]=s;continue}if(typeof l=="string"&&typeof s=="string")l+=s;else if(typeof l=="number"&&typeof s=="number")l+=s;else if(ur(l)&&ur(s))l=this.accumulateDelta(l,s);else if(Array.isArray(l)&&Array.isArray(s)){if(l.every(o=>typeof o=="string"||typeof o=="number")){l.push(...s);continue}for(const o of s){if(!ur(o))throw new Error(`Expected array delta entry to be an object but got: ${o}`);const u=o.index;if(u==null)throw console.error(o),new Error("Expected array delta entry to have an `index` property");if(typeof u!="number")throw new Error(`Expected array delta entry \`index\` property to be a number but got ${u}`);const i=l[u];i==null?l.push(o):l[u]=this.accumulateDelta(i,o)}continue}else throw Error(`Unhandled record type: ${a}, deltaValue: ${s}, accValue: ${l}`);e[a]=l}return e}_addRun(e){return e}async _threadAssistantStream(e,r,a){return await this._createThreadAssistantStream(r,e,a)}async _runAssistantStream(e,r,a,s){return await this._createAssistantStream(r,e,a,s)}async _runToolAssistantStream(e,r,a,s,l){return await this._createToolAssistantStream(a,e,r,s,l)}}qt=function(e){if(!this.ended)switch(ve(this,Sn,e,"f"),P(this,re,"m",Va).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.incomplete":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":P(this,re,"m",Xa).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":P(this,re,"m",Ja).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":P(this,re,"m",ja).call(this,e);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier")}},Ht=function(){if(this.ended)throw new T("stream has ended, this shouldn't happen");if(!P(this,nt,"f"))throw Error("Final run has not been received");return P(this,nt,"f")},ja=function(e){const[r,a]=P(this,re,"m",Ya).call(this,e,P(this,Se,"f"));ve(this,Se,r,"f"),P(this,Cn,"f")[r.id]=r;for(const s of a){const l=r.content[s.index];(l==null?void 0:l.type)=="text"&&this._emit("textCreated",l.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,r),e.data.delta.content)for(const s of e.data.delta.content){if(s.type=="text"&&s.text){let l=s.text,o=r.content[s.index];if(o&&o.type=="text")this._emit("textDelta",l,o.text);else throw Error("The snapshot associated with this text delta is not text or missing")}if(s.index!=P(this,yt,"f")){if(P(this,tt,"f"))switch(P(this,tt,"f").type){case"text":this._emit("textDone",P(this,tt,"f").text,P(this,Se,"f"));break;case"image_file":this._emit("imageFileDone",P(this,tt,"f").image_file,P(this,Se,"f"));break}ve(this,yt,s.index,"f")}ve(this,tt,r.content[s.index],"f")}break;case"thread.message.completed":case"thread.message.incomplete":if(P(this,yt,"f")!==void 0){const s=e.data.content[P(this,yt,"f")];if(s)switch(s.type){case"image_file":this._emit("imageFileDone",s.image_file,P(this,Se,"f"));break;case"text":this._emit("textDone",s.text,P(this,Se,"f"));break}}P(this,Se,"f")&&this._emit("messageDone",e.data),ve(this,Se,void 0,"f")}},Ja=function(e){const r=P(this,re,"m",Ka).call(this,e);switch(ve(this,Vt,r,"f"),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":const a=e.data.delta;if(a.step_details&&a.step_details.type=="tool_calls"&&a.step_details.tool_calls&&r.step_details.type=="tool_calls")for(const l of a.step_details.tool_calls)l.index==P(this,Dn,"f")?this._emit("toolCallDelta",l,r.step_details.tool_calls[l.index]):(P(this,Me,"f")&&this._emit("toolCallDone",P(this,Me,"f")),ve(this,Dn,l.index,"f"),ve(this,Me,r.step_details.tool_calls[l.index],"f"),P(this,Me,"f")&&this._emit("toolCallCreated",P(this,Me,"f")));this._emit("runStepDelta",e.data.delta,r);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":ve(this,Vt,void 0,"f"),e.data.step_details.type=="tool_calls"&&P(this,Me,"f")&&(this._emit("toolCallDone",P(this,Me,"f")),ve(this,Me,void 0,"f")),this._emit("runStepDone",e.data,r);break}},Va=function(e){P(this,Cr,"f").push(e),this._emit("event",e)},Ka=function(e){switch(e.event){case"thread.run.step.created":return P(this,De,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let r=P(this,De,"f")[e.data.id];if(!r)throw Error("Received a RunStepDelta before creation of a snapshot");let a=e.data;if(a.delta){const s=Ae.accumulateDelta(r,a.delta);P(this,De,"f")[e.data.id]=s}return P(this,De,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":P(this,De,"f")[e.data.id]=e.data;break}if(P(this,De,"f")[e.data.id])return P(this,De,"f")[e.data.id];throw new Error("No snapshot available")},Ya=function(e,r){let a=[];switch(e.event){case"thread.message.created":return[e.data,a];case"thread.message.delta":if(!r)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let s=e.data;if(s.delta.content)for(const l of s.delta.content)if(l.index in r.content){let o=r.content[l.index];r.content[l.index]=P(this,re,"m",za).call(this,l,o)}else r.content[l.index]=l,a.push(l);return[r,a];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(r)return[r,a];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},za=function(e,r){return Ae.accumulateDelta(r,e)},Xa=function(e){switch(ve(this,Pn,e.data,"f"),e.event){case"thread.run.created":break;case"thread.run.queued":break;case"thread.run.in_progress":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":ve(this,nt,e.data,"f"),P(this,Me,"f")&&(this._emit("toolCallDone",P(this,Me,"f")),ve(this,Me,void 0,"f"));break}};class Jr extends F{create(e,r){return this._client.post("/assistants",{body:e,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}retrieve(e,r){return this._client.get(`/assistants/${e}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}update(e,r,a){return this._client.post(`/assistants/${e}`,{body:r,...a,headers:{"OpenAI-Beta":"assistants=v2",...a==null?void 0:a.headers}})}list(e={},r){return j(e)?this.list({},e):this._client.getAPIList("/assistants",Vr,{query:e,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}del(e,r){return this._client.delete(`/assistants/${e}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}}class Vr extends ee{}Jr.AssistantsPage=Vr;function Qa(n){return typeof n.parse=="function"}const _t=n=>(n==null?void 0:n.role)==="assistant",nl=n=>(n==null?void 0:n.role)==="function",rl=n=>(n==null?void 0:n.role)==="tool";function Kr(n){return(n==null?void 0:n.$brand)==="auto-parseable-response-format"}function tn(n){return(n==null?void 0:n.$brand)==="auto-parseable-tool"}function yi(n,e){return!e||!al(e)?{...n,choices:n.choices.map(r=>({...r,message:{...r.message,parsed:null,...r.message.tool_calls?{tool_calls:r.message.tool_calls}:void 0}}))}:Yr(n,e)}function Yr(n,e){const r=n.choices.map(a=>{var s;if(a.finish_reason==="length")throw new Ns;if(a.finish_reason==="content_filter")throw new Ws;return{...a,message:{...a.message,...a.message.tool_calls?{tool_calls:((s=a.message.tool_calls)==null?void 0:s.map(l=>bi(e,l)))??void 0}:void 0,parsed:a.message.content&&!a.message.refusal?wi(e,a.message.content):null}}});return{...n,choices:r}}function wi(n,e){var r,a;return((r=n.response_format)==null?void 0:r.type)!=="json_schema"?null:((a=n.response_format)==null?void 0:a.type)==="json_schema"?"$parseRaw"in n.response_format?n.response_format.$parseRaw(e):JSON.parse(e):null}function bi(n,e){var a;const r=(a=n.tools)==null?void 0:a.find(s=>{var l;return((l=s.function)==null?void 0:l.name)===e.function.name});return{...e,function:{...e.function,parsed_arguments:tn(r)?r.$parseRaw(e.function.arguments):r!=null&&r.function.strict?JSON.parse(e.function.arguments):null}}}function vi(n,e){var a;if(!n)return!1;const r=(a=n.tools)==null?void 0:a.find(s=>{var l;return((l=s.function)==null?void 0:l.name)===e.function.name});return tn(r)||(r==null?void 0:r.function.strict)||!1}function al(n){var e;return Kr(n.response_format)?!0:((e=n.tools)==null?void 0:e.some(r=>tn(r)||r.type==="function"&&r.function.strict===!0))??!1}function _i(n){for(const e of n??[]){if(e.type!=="function")throw new T(`Currently only \`function\` tool types support auto-parsing; Received \`${e.type}\``);if(e.function.strict!==!0)throw new T(`The \`${e.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}}var ge=function(n,e,r,a){if(r==="a"&&!a)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return r==="m"?a:r==="a"?a.call(n):a?a.value:e.get(n)},ie,Sr,Rn,Pr,Ar,Tr,sl,Br;const Za=10;class ll extends jr{constructor(){super(...arguments),ie.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){var a;this._chatCompletions.push(e),this._emit("chatCompletion",e);const r=(a=e.choices[0])==null?void 0:a.message;return r&&this._addMessage(r),e}_addMessage(e,r=!0){if("content"in e||(e.content=null),this.messages.push(e),r){if(this._emit("message",e),(nl(e)||rl(e))&&e.content)this._emit("functionCallResult",e.content);else if(_t(e)&&e.function_call)this._emit("functionCall",e.function_call);else if(_t(e)&&e.tool_calls)for(const a of e.tool_calls)a.type==="function"&&this._emit("functionCall",a.function)}}async finalChatCompletion(){await this.done();const e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new T("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),ge(this,ie,"m",Sr).call(this)}async finalMessage(){return await this.done(),ge(this,ie,"m",Rn).call(this)}async finalFunctionCall(){return await this.done(),ge(this,ie,"m",Pr).call(this)}async finalFunctionCallResult(){return await this.done(),ge(this,ie,"m",Ar).call(this)}async totalUsage(){return await this.done(),ge(this,ie,"m",Tr).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){const e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);const r=ge(this,ie,"m",Rn).call(this);r&&this._emit("finalMessage",r);const a=ge(this,ie,"m",Sr).call(this);a&&this._emit("finalContent",a);const s=ge(this,ie,"m",Pr).call(this);s&&this._emit("finalFunctionCall",s);const l=ge(this,ie,"m",Ar).call(this);l!=null&&this._emit("finalFunctionCallResult",l),this._chatCompletions.some(o=>o.usage)&&this._emit("totalUsage",ge(this,ie,"m",Tr).call(this))}async _createChatCompletion(e,r,a){const s=a==null?void 0:a.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),ge(this,ie,"m",sl).call(this,r);const l=await e.chat.completions.create({...r,stream:!1},{...a,signal:this.controller.signal});return this._connected(),this._addChatCompletion(Yr(l,r))}async _runChatCompletion(e,r,a){for(const s of r.messages)this._addMessage(s,!1);return await this._createChatCompletion(e,r,a)}async _runFunctions(e,r,a){var h;const s="function",{function_call:l="auto",stream:o,...u}=r,i=typeof l!="string"&&(l==null?void 0:l.name),{maxChatCompletions:c=Za}=a||{},m={};for(const y of r.functions)m[y.name||y.function.name]=y;const g=r.functions.map(y=>({name:y.name||y.function.name,parameters:y.parameters,description:y.description}));for(const y of r.messages)this._addMessage(y,!1);for(let y=0;y<c;++y){const f=(h=(await this._createChatCompletion(e,{...u,function_call:l,functions:g,messages:[...this.messages]},a)).choices[0])==null?void 0:h.message;if(!f)throw new T("missing message in ChatCompletion response");if(!f.function_call)return;const{name:p,arguments:b}=f.function_call,w=m[p];if(w){if(i&&i!==p){const _=`Invalid function_call: ${JSON.stringify(p)}. ${JSON.stringify(i)} requested. Please try again`;this._addMessage({role:s,name:p,content:_});continue}}else{const _=`Invalid function_call: ${JSON.stringify(p)}. Available options are: ${g.map(I=>JSON.stringify(I.name)).join(", ")}. Please try again`;this._addMessage({role:s,name:p,content:_});continue}let M;try{M=Qa(w)?await w.parse(b):b}catch(_){this._addMessage({role:s,name:p,content:_ instanceof Error?_.message:String(_)});continue}const x=await w.function(M,this),E=ge(this,ie,"m",Br).call(this,x);if(this._addMessage({role:s,name:p,content:E}),i)return}}async _runTools(e,r,a){var y,d,f;const s="tool",{tool_choice:l="auto",stream:o,...u}=r,i=typeof l!="string"&&((y=l==null?void 0:l.function)==null?void 0:y.name),{maxChatCompletions:c=Za}=a||{},m=r.tools.map(p=>{if(tn(p)){if(!p.$callback)throw new T("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:p.$callback,name:p.function.name,description:p.function.description||"",parameters:p.function.parameters,parse:p.$parseRaw,strict:!0}}}return p}),g={};for(const p of m)p.type==="function"&&(g[p.function.name||p.function.function.name]=p.function);const h="tools"in r?m.map(p=>p.type==="function"?{type:"function",function:{name:p.function.name||p.function.function.name,parameters:p.function.parameters,description:p.function.description,strict:p.function.strict}}:p):void 0;for(const p of r.messages)this._addMessage(p,!1);for(let p=0;p<c;++p){const w=(d=(await this._createChatCompletion(e,{...u,tool_choice:l,tools:h,messages:[...this.messages]},a)).choices[0])==null?void 0:d.message;if(!w)throw new T("missing message in ChatCompletion response");if(!((f=w.tool_calls)!=null&&f.length))return;for(const M of w.tool_calls){if(M.type!=="function")continue;const x=M.id,{name:E,arguments:_}=M.function,I=g[E];if(I){if(i&&i!==E){const A=`Invalid tool_call: ${JSON.stringify(E)}. ${JSON.stringify(i)} requested. Please try again`;this._addMessage({role:s,tool_call_id:x,content:A});continue}}else{const A=`Invalid tool_call: ${JSON.stringify(E)}. Available options are: ${Object.keys(g).map(U=>JSON.stringify(U)).join(", ")}. Please try again`;this._addMessage({role:s,tool_call_id:x,content:A});continue}let C;try{C=Qa(I)?await I.parse(_):_}catch(A){const U=A instanceof Error?A.message:String(A);this._addMessage({role:s,tool_call_id:x,content:U});continue}const B=await I.function(C,this),k=ge(this,ie,"m",Br).call(this,B);if(this._addMessage({role:s,tool_call_id:x,content:k}),i)return}}}}ie=new WeakSet,Sr=function(){return ge(this,ie,"m",Rn).call(this).content??null},Rn=function(){let e=this.messages.length;for(;e-- >0;){const r=this.messages[e];if(_t(r)){const{function_call:a,...s}=r,l={...s,content:r.content??null,refusal:r.refusal??null};return a&&(l.function_call=a),l}}throw new T("stream ended without producing a ChatCompletionMessage with role=assistant")},Pr=function(){var e,r;for(let a=this.messages.length-1;a>=0;a--){const s=this.messages[a];if(_t(s)&&(s!=null&&s.function_call))return s.function_call;if(_t(s)&&((e=s==null?void 0:s.tool_calls)!=null&&e.length))return(r=s.tool_calls.at(-1))==null?void 0:r.function}},Ar=function(){for(let e=this.messages.length-1;e>=0;e--){const r=this.messages[e];if(nl(r)&&r.content!=null||rl(r)&&r.content!=null&&typeof r.content=="string"&&this.messages.some(a=>{var s;return a.role==="assistant"&&((s=a.tool_calls)==null?void 0:s.some(l=>l.type==="function"&&l.id===r.tool_call_id))}))return r.content}},Tr=function(){const e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(const{usage:r}of this._chatCompletions)r&&(e.completion_tokens+=r.completion_tokens,e.prompt_tokens+=r.prompt_tokens,e.total_tokens+=r.total_tokens);return e},sl=function(e){if(e.n!=null&&e.n>1)throw new T("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},Br=function(e){return typeof e=="string"?e:e===void 0?"undefined":JSON.stringify(e)};class Yt extends ll{static runFunctions(e,r,a){const s=new Yt,l={...a,headers:{...a==null?void 0:a.headers,"X-Stainless-Helper-Method":"runFunctions"}};return s._run(()=>s._runFunctions(e,r,l)),s}static runTools(e,r,a){const s=new Yt,l={...a,headers:{...a==null?void 0:a.headers,"X-Stainless-Helper-Method":"runTools"}};return s._run(()=>s._runTools(e,r,l)),s}_addMessage(e,r=!0){super._addMessage(e,r),_t(e)&&e.content&&this._emit("content",e.content)}}const ol=1,il=2,ul=4,cl=8,dl=16,fl=32,ml=64,pl=128,hl=256,gl=pl|hl,yl=dl|fl|gl|ml,wl=ol|il|yl,bl=ul|cl,Mi=wl|bl,te={STR:ol,NUM:il,ARR:ul,OBJ:cl,NULL:dl,BOOL:fl,NAN:ml,INFINITY:pl,MINUS_INFINITY:hl,INF:gl,SPECIAL:yl,ATOM:wl,COLLECTION:bl,ALL:Mi};class ki extends Error{}class xi extends Error{}function Ei(n,e=te.ALL){if(typeof n!="string")throw new TypeError(`expecting str, got ${typeof n}`);if(!n.trim())throw new Error(`${n} is empty`);return Ii(n.trim(),e)}const Ii=(n,e)=>{const r=n.length;let a=0;const s=h=>{throw new ki(`${h} at position ${a}`)},l=h=>{throw new xi(`${h} at position ${a}`)},o=()=>(g(),a>=r&&s("Unexpected end of input"),n[a]==='"'?u():n[a]==="{"?i():n[a]==="["?c():n.substring(a,a+4)==="null"||te.NULL&e&&r-a<4&&"null".startsWith(n.substring(a))?(a+=4,null):n.substring(a,a+4)==="true"||te.BOOL&e&&r-a<4&&"true".startsWith(n.substring(a))?(a+=4,!0):n.substring(a,a+5)==="false"||te.BOOL&e&&r-a<5&&"false".startsWith(n.substring(a))?(a+=5,!1):n.substring(a,a+8)==="Infinity"||te.INFINITY&e&&r-a<8&&"Infinity".startsWith(n.substring(a))?(a+=8,1/0):n.substring(a,a+9)==="-Infinity"||te.MINUS_INFINITY&e&&1<r-a&&r-a<9&&"-Infinity".startsWith(n.substring(a))?(a+=9,-1/0):n.substring(a,a+3)==="NaN"||te.NAN&e&&r-a<3&&"NaN".startsWith(n.substring(a))?(a+=3,NaN):m()),u=()=>{const h=a;let y=!1;for(a++;a<r&&(n[a]!=='"'||y&&n[a-1]==="\\");)y=n[a]==="\\"?!y:!1,a++;if(n.charAt(a)=='"')try{return JSON.parse(n.substring(h,++a-Number(y)))}catch(d){l(String(d))}else if(te.STR&e)try{return JSON.parse(n.substring(h,a-Number(y))+'"')}catch{return JSON.parse(n.substring(h,n.lastIndexOf("\\"))+'"')}s("Unterminated string literal")},i=()=>{a++,g();const h={};try{for(;n[a]!=="}";){if(g(),a>=r&&te.OBJ&e)return h;const y=u();g(),a++;try{const d=o();Object.defineProperty(h,y,{value:d,writable:!0,enumerable:!0,configurable:!0})}catch(d){if(te.OBJ&e)return h;throw d}g(),n[a]===","&&a++}}catch{if(te.OBJ&e)return h;s("Expected '}' at end of object")}return a++,h},c=()=>{a++;const h=[];try{for(;n[a]!=="]";)h.push(o()),g(),n[a]===","&&a++}catch{if(te.ARR&e)return h;s("Expected ']' at end of array")}return a++,h},m=()=>{if(a===0){n==="-"&&te.NUM&e&&s("Not sure what '-' is");try{return JSON.parse(n)}catch(y){if(te.NUM&e)try{return n[n.length-1]==="."?JSON.parse(n.substring(0,n.lastIndexOf("."))):JSON.parse(n.substring(0,n.lastIndexOf("e")))}catch{}l(String(y))}}const h=a;for(n[a]==="-"&&a++;n[a]&&!",]}".includes(n[a]);)a++;a==r&&!(te.NUM&e)&&s("Unterminated number literal");try{return JSON.parse(n.substring(h,a))}catch{n.substring(h,a)==="-"&&te.NUM&e&&s("Not sure what '-' is");try{return JSON.parse(n.substring(h,n.lastIndexOf("e")))}catch(d){l(String(d))}}},g=()=>{for(;a<r&&` 
\r	`.includes(n[a]);)a++};return o()},es=n=>Ei(n,te.ALL^te.NUM);var ct=function(n,e,r,a,s){if(a==="m")throw new TypeError("Private method is not writable");if(a==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!s:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return a==="a"?s.call(n,r):s?s.value=r:e.set(n,r),r},N=function(n,e,r,a){if(r==="a"&&!a)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return r==="m"?a:r==="a"?a.call(n):a?a.value:e.get(n)},z,Le,dt,je,cr,hn,dr,fr,mr,gn,pr,ts;class zt extends ll{constructor(e){super(),z.add(this),Le.set(this,void 0),dt.set(this,void 0),je.set(this,void 0),ct(this,Le,e,"f"),ct(this,dt,[],"f")}get currentChatCompletionSnapshot(){return N(this,je,"f")}static fromReadableStream(e){const r=new zt(null);return r._run(()=>r._fromReadableStream(e)),r}static createChatCompletion(e,r,a){const s=new zt(r);return s._run(()=>s._runChatCompletion(e,{...r,stream:!0},{...a,headers:{...a==null?void 0:a.headers,"X-Stainless-Helper-Method":"stream"}})),s}async _createChatCompletion(e,r,a){var o;super._createChatCompletion;const s=a==null?void 0:a.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),N(this,z,"m",cr).call(this);const l=await e.chat.completions.create({...r,stream:!0},{...a,signal:this.controller.signal});this._connected();for await(const u of l)N(this,z,"m",dr).call(this,u);if((o=l.controller.signal)!=null&&o.aborted)throw new Ie;return this._addChatCompletion(N(this,z,"m",gn).call(this))}async _fromReadableStream(e,r){var o;const a=r==null?void 0:r.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort())),N(this,z,"m",cr).call(this),this._connected();const s=Re.fromReadableStream(e,this.controller);let l;for await(const u of s)l&&l!==u.id&&this._addChatCompletion(N(this,z,"m",gn).call(this)),N(this,z,"m",dr).call(this,u),l=u.id;if((o=s.controller.signal)!=null&&o.aborted)throw new Ie;return this._addChatCompletion(N(this,z,"m",gn).call(this))}[(Le=new WeakMap,dt=new WeakMap,je=new WeakMap,z=new WeakSet,cr=function(){this.ended||ct(this,je,void 0,"f")},hn=function(r){let a=N(this,dt,"f")[r.index];return a||(a={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},N(this,dt,"f")[r.index]=a,a)},dr=function(r){var s,l,o,u,i,c,m,g,h,y,d,f,p,b,w;if(this.ended)return;const a=N(this,z,"m",ts).call(this,r);this._emit("chunk",r,a);for(const M of r.choices){const x=a.choices[M.index];M.delta.content!=null&&((s=x.message)==null?void 0:s.role)==="assistant"&&((l=x.message)!=null&&l.content)&&(this._emit("content",M.delta.content,x.message.content),this._emit("content.delta",{delta:M.delta.content,snapshot:x.message.content,parsed:x.message.parsed})),M.delta.refusal!=null&&((o=x.message)==null?void 0:o.role)==="assistant"&&((u=x.message)!=null&&u.refusal)&&this._emit("refusal.delta",{delta:M.delta.refusal,snapshot:x.message.refusal}),((i=M.logprobs)==null?void 0:i.content)!=null&&((c=x.message)==null?void 0:c.role)==="assistant"&&this._emit("logprobs.content.delta",{content:(m=M.logprobs)==null?void 0:m.content,snapshot:((g=x.logprobs)==null?void 0:g.content)??[]}),((h=M.logprobs)==null?void 0:h.refusal)!=null&&((y=x.message)==null?void 0:y.role)==="assistant"&&this._emit("logprobs.refusal.delta",{refusal:(d=M.logprobs)==null?void 0:d.refusal,snapshot:((f=x.logprobs)==null?void 0:f.refusal)??[]});const E=N(this,z,"m",hn).call(this,x);x.finish_reason&&(N(this,z,"m",mr).call(this,x),E.current_tool_call_index!=null&&N(this,z,"m",fr).call(this,x,E.current_tool_call_index));for(const _ of M.delta.tool_calls??[])E.current_tool_call_index!==_.index&&(N(this,z,"m",mr).call(this,x),E.current_tool_call_index!=null&&N(this,z,"m",fr).call(this,x,E.current_tool_call_index)),E.current_tool_call_index=_.index;for(const _ of M.delta.tool_calls??[]){const I=(p=x.message.tool_calls)==null?void 0:p[_.index];I!=null&&I.type&&((I==null?void 0:I.type)==="function"?this._emit("tool_calls.function.arguments.delta",{name:(b=I.function)==null?void 0:b.name,index:_.index,arguments:I.function.arguments,parsed_arguments:I.function.parsed_arguments,arguments_delta:((w=_.function)==null?void 0:w.arguments)??""}):(I==null||I.type,void 0))}}},fr=function(r,a){var o,u,i;if(N(this,z,"m",hn).call(this,r).done_tool_calls.has(a))return;const l=(o=r.message.tool_calls)==null?void 0:o[a];if(!l)throw new Error("no tool call snapshot");if(!l.type)throw new Error("tool call snapshot missing `type`");if(l.type==="function"){const c=(i=(u=N(this,Le,"f"))==null?void 0:u.tools)==null?void 0:i.find(m=>m.type==="function"&&m.function.name===l.function.name);this._emit("tool_calls.function.arguments.done",{name:l.function.name,index:a,arguments:l.function.arguments,parsed_arguments:tn(c)?c.$parseRaw(l.function.arguments):c!=null&&c.function.strict?JSON.parse(l.function.arguments):null})}else l.type},mr=function(r){var s,l;const a=N(this,z,"m",hn).call(this,r);if(r.message.content&&!a.content_done){a.content_done=!0;const o=N(this,z,"m",pr).call(this);this._emit("content.done",{content:r.message.content,parsed:o?o.$parseRaw(r.message.content):null})}r.message.refusal&&!a.refusal_done&&(a.refusal_done=!0,this._emit("refusal.done",{refusal:r.message.refusal})),(s=r.logprobs)!=null&&s.content&&!a.logprobs_content_done&&(a.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:r.logprobs.content})),(l=r.logprobs)!=null&&l.refusal&&!a.logprobs_refusal_done&&(a.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:r.logprobs.refusal}))},gn=function(){if(this.ended)throw new T("stream has ended, this shouldn't happen");const r=N(this,je,"f");if(!r)throw new T("request ended without sending any chunks");return ct(this,je,void 0,"f"),ct(this,dt,[],"f"),$i(r,N(this,Le,"f"))},pr=function(){var a;const r=(a=N(this,Le,"f"))==null?void 0:a.response_format;return Kr(r)?r:null},ts=function(r){var a,s,l,o;let u=N(this,je,"f");const{choices:i,...c}=r;u?Object.assign(u,c):u=ct(this,je,{...c,choices:[]},"f");for(const{delta:m,finish_reason:g,index:h,logprobs:y=null,...d}of r.choices){let f=u.choices[h];if(f||(f=u.choices[h]={finish_reason:g,index:h,message:{},logprobs:y,...d}),y)if(!f.logprobs)f.logprobs=Object.assign({},y);else{const{content:_,refusal:I,...C}=y;Object.assign(f.logprobs,C),_&&((a=f.logprobs).content??(a.content=[]),f.logprobs.content.push(..._)),I&&((s=f.logprobs).refusal??(s.refusal=[]),f.logprobs.refusal.push(...I))}if(g&&(f.finish_reason=g,N(this,Le,"f")&&al(N(this,Le,"f")))){if(g==="length")throw new Ns;if(g==="content_filter")throw new Ws}if(Object.assign(f,d),!m)continue;const{content:p,refusal:b,function_call:w,role:M,tool_calls:x,...E}=m;if(Object.assign(f.message,E),b&&(f.message.refusal=(f.message.refusal||"")+b),M&&(f.message.role=M),w&&(f.message.function_call?(w.name&&(f.message.function_call.name=w.name),w.arguments&&((l=f.message.function_call).arguments??(l.arguments=""),f.message.function_call.arguments+=w.arguments)):f.message.function_call=w),p&&(f.message.content=(f.message.content||"")+p,!f.message.refusal&&N(this,z,"m",pr).call(this)&&(f.message.parsed=es(f.message.content))),x){f.message.tool_calls||(f.message.tool_calls=[]);for(const{index:_,id:I,type:C,function:B,...k}of x){const A=(o=f.message.tool_calls)[_]??(o[_]={});Object.assign(A,k),I&&(A.id=I),C&&(A.type=C),B&&(A.function??(A.function={name:B.name??"",arguments:""})),B!=null&&B.name&&(A.function.name=B.name),B!=null&&B.arguments&&(A.function.arguments+=B.arguments,vi(N(this,Le,"f"),A)&&(A.function.parsed_arguments=es(A.function.arguments)))}}}return u},Symbol.asyncIterator)](){const e=[],r=[];let a=!1;return this.on("chunk",s=>{const l=r.shift();l?l.resolve(s):e.push(s)}),this.on("end",()=>{a=!0;for(const s of r)s.resolve(void 0);r.length=0}),this.on("abort",s=>{a=!0;for(const l of r)l.reject(s);r.length=0}),this.on("error",s=>{a=!0;for(const l of r)l.reject(s);r.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:a?{value:void 0,done:!0}:new Promise((l,o)=>r.push({resolve:l,reject:o})).then(l=>l?{value:l,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new Re(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function $i(n,e){const{id:r,choices:a,created:s,model:l,system_fingerprint:o,...u}=n,i={...u,id:r,choices:a.map(({message:c,finish_reason:m,index:g,logprobs:h,...y})=>{if(!m)throw new T(`missing finish_reason for choice ${g}`);const{content:d=null,function_call:f,tool_calls:p,...b}=c,w=c.role;if(!w)throw new T(`missing role for choice ${g}`);if(f){const{arguments:M,name:x}=f;if(M==null)throw new T(`missing function_call.arguments for choice ${g}`);if(!x)throw new T(`missing function_call.name for choice ${g}`);return{...y,message:{content:d,function_call:{arguments:M,name:x},role:w,refusal:c.refusal??null},finish_reason:m,index:g,logprobs:h}}return p?{...y,index:g,finish_reason:m,logprobs:h,message:{...b,role:w,content:d,refusal:c.refusal??null,tool_calls:p.map((M,x)=>{const{function:E,type:_,id:I,...C}=M,{arguments:B,name:k,...A}=E||{};if(I==null)throw new T(`missing choices[${g}].tool_calls[${x}].id
${yn(n)}`);if(_==null)throw new T(`missing choices[${g}].tool_calls[${x}].type
${yn(n)}`);if(k==null)throw new T(`missing choices[${g}].tool_calls[${x}].function.name
${yn(n)}`);if(B==null)throw new T(`missing choices[${g}].tool_calls[${x}].function.arguments
${yn(n)}`);return{...C,id:I,type:_,function:{...A,name:k,arguments:B}}})}}:{...y,message:{...b,content:d,role:w,refusal:c.refusal??null},finish_reason:m,index:g,logprobs:h}}),created:s,model:l,object:"chat.completion",...o?{system_fingerprint:o}:{}};return yi(i,e)}function yn(n){return JSON.stringify(n)}class Mt extends zt{static fromReadableStream(e){const r=new Mt(null);return r._run(()=>r._fromReadableStream(e)),r}static runFunctions(e,r,a){const s=new Mt(null),l={...a,headers:{...a==null?void 0:a.headers,"X-Stainless-Helper-Method":"runFunctions"}};return s._run(()=>s._runFunctions(e,r,l)),s}static runTools(e,r,a){const s=new Mt(r),l={...a,headers:{...a==null?void 0:a.headers,"X-Stainless-Helper-Method":"runTools"}};return s._run(()=>s._runTools(e,r,l)),s}}let vl=class extends F{parse(e,r){return _i(e.tools),this._client.chat.completions.create(e,{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"beta.chat.completions.parse"}})._thenUnwrap(a=>Yr(a,e))}runFunctions(e,r){return e.stream?Mt.runFunctions(this._client,e,r):Yt.runFunctions(this._client,e,r)}runTools(e,r){return e.stream?Mt.runTools(this._client,e,r):Yt.runTools(this._client,e,r)}stream(e,r){return zt.createChatCompletion(this._client,e,r)}};class Fr extends F{constructor(){super(...arguments),this.completions=new vl(this._client)}}(function(n){n.Completions=vl})(Fr||(Fr={}));class _l extends F{create(e,r){return this._client.post("/realtime/sessions",{body:e,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}}class Ml extends F{create(e,r){return this._client.post("/realtime/transcription_sessions",{body:e,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}}class Kn extends F{constructor(){super(...arguments),this.sessions=new _l(this._client),this.transcriptionSessions=new Ml(this._client)}}Kn.Sessions=_l;Kn.TranscriptionSessions=Ml;class zr extends F{create(e,r,a){return this._client.post(`/threads/${e}/messages`,{body:r,...a,headers:{"OpenAI-Beta":"assistants=v2",...a==null?void 0:a.headers}})}retrieve(e,r,a){return this._client.get(`/threads/${e}/messages/${r}`,{...a,headers:{"OpenAI-Beta":"assistants=v2",...a==null?void 0:a.headers}})}update(e,r,a,s){return this._client.post(`/threads/${e}/messages/${r}`,{body:a,...s,headers:{"OpenAI-Beta":"assistants=v2",...s==null?void 0:s.headers}})}list(e,r={},a){return j(r)?this.list(e,{},r):this._client.getAPIList(`/threads/${e}/messages`,Xr,{query:r,...a,headers:{"OpenAI-Beta":"assistants=v2",...a==null?void 0:a.headers}})}del(e,r,a){return this._client.delete(`/threads/${e}/messages/${r}`,{...a,headers:{"OpenAI-Beta":"assistants=v2",...a==null?void 0:a.headers}})}}class Xr extends ee{}zr.MessagesPage=Xr;class Qr extends F{retrieve(e,r,a,s={},l){return j(s)?this.retrieve(e,r,a,{},s):this._client.get(`/threads/${e}/runs/${r}/steps/${a}`,{query:s,...l,headers:{"OpenAI-Beta":"assistants=v2",...l==null?void 0:l.headers}})}list(e,r,a={},s){return j(a)?this.list(e,r,{},a):this._client.getAPIList(`/threads/${e}/runs/${r}/steps`,Zr,{query:a,...s,headers:{"OpenAI-Beta":"assistants=v2",...s==null?void 0:s.headers}})}}class Zr extends ee{}Qr.RunStepsPage=Zr;let nn=class extends F{constructor(){super(...arguments),this.steps=new Qr(this._client)}create(e,r,a){const{include:s,...l}=r;return this._client.post(`/threads/${e}/runs`,{query:{include:s},body:l,...a,headers:{"OpenAI-Beta":"assistants=v2",...a==null?void 0:a.headers},stream:r.stream??!1})}retrieve(e,r,a){return this._client.get(`/threads/${e}/runs/${r}`,{...a,headers:{"OpenAI-Beta":"assistants=v2",...a==null?void 0:a.headers}})}update(e,r,a,s){return this._client.post(`/threads/${e}/runs/${r}`,{body:a,...s,headers:{"OpenAI-Beta":"assistants=v2",...s==null?void 0:s.headers}})}list(e,r={},a){return j(r)?this.list(e,{},r):this._client.getAPIList(`/threads/${e}/runs`,ea,{query:r,...a,headers:{"OpenAI-Beta":"assistants=v2",...a==null?void 0:a.headers}})}cancel(e,r,a){return this._client.post(`/threads/${e}/runs/${r}/cancel`,{...a,headers:{"OpenAI-Beta":"assistants=v2",...a==null?void 0:a.headers}})}async createAndPoll(e,r,a){const s=await this.create(e,r,a);return await this.poll(e,s.id,a)}createAndStream(e,r,a){return Ae.createAssistantStream(e,this._client.beta.threads.runs,r,a)}async poll(e,r,a){const s={...a==null?void 0:a.headers,"X-Stainless-Poll-Helper":"true"};for(a!=null&&a.pollIntervalMs&&(s["X-Stainless-Custom-Poll-Interval"]=a.pollIntervalMs.toString());;){const{data:l,response:o}=await this.retrieve(e,r,{...a,headers:{...a==null?void 0:a.headers,...s}}).withResponse();switch(l.status){case"queued":case"in_progress":case"cancelling":let u=5e3;if(a!=null&&a.pollIntervalMs)u=a.pollIntervalMs;else{const i=o.headers.get("openai-poll-after-ms");if(i){const c=parseInt(i);isNaN(c)||(u=c)}}await Zt(u);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return l}}}stream(e,r,a){return Ae.createAssistantStream(e,this._client.beta.threads.runs,r,a)}submitToolOutputs(e,r,a,s){return this._client.post(`/threads/${e}/runs/${r}/submit_tool_outputs`,{body:a,...s,headers:{"OpenAI-Beta":"assistants=v2",...s==null?void 0:s.headers},stream:a.stream??!1})}async submitToolOutputsAndPoll(e,r,a,s){const l=await this.submitToolOutputs(e,r,a,s);return await this.poll(e,l.id,s)}submitToolOutputsStream(e,r,a,s){return Ae.createToolAssistantStream(e,r,this._client.beta.threads.runs,a,s)}};class ea extends ee{}nn.RunsPage=ea;nn.Steps=Qr;nn.RunStepsPage=Zr;class Pt extends F{constructor(){super(...arguments),this.runs=new nn(this._client),this.messages=new zr(this._client)}create(e={},r){return j(e)?this.create({},e):this._client.post("/threads",{body:e,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}retrieve(e,r){return this._client.get(`/threads/${e}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}update(e,r,a){return this._client.post(`/threads/${e}`,{body:r,...a,headers:{"OpenAI-Beta":"assistants=v2",...a==null?void 0:a.headers}})}del(e,r){return this._client.delete(`/threads/${e}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}createAndRun(e,r){return this._client.post("/threads/runs",{body:e,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers},stream:e.stream??!1})}async createAndRunPoll(e,r){const a=await this.createAndRun(e,r);return await this.runs.poll(a.thread_id,a.id,r)}createAndRunStream(e,r){return Ae.createThreadAssistantStream(e,this._client.beta.threads,r)}}Pt.Runs=nn;Pt.RunsPage=ea;Pt.Messages=zr;Pt.MessagesPage=Xr;class At extends F{constructor(){super(...arguments),this.realtime=new Kn(this._client),this.chat=new Fr(this._client),this.assistants=new Jr(this._client),this.threads=new Pt(this._client)}}At.Realtime=Kn;At.Assistants=Jr;At.AssistantsPage=Vr;At.Threads=Pt;class kl extends F{create(e,r){return this._client.post("/completions",{body:e,...r,stream:e.stream??!1})}}class xl extends F{retrieve(e,r,a){return this._client.get(`/containers/${e}/files/${r}/content`,{...a,headers:{Accept:"application/binary",...a==null?void 0:a.headers},__binaryResponse:!0})}}let Yn=class extends F{constructor(){super(...arguments),this.content=new xl(this._client)}create(e,r,a){return this._client.post(`/containers/${e}/files`,st({body:r,...a}))}retrieve(e,r,a){return this._client.get(`/containers/${e}/files/${r}`,a)}list(e,r={},a){return j(r)?this.list(e,{},r):this._client.getAPIList(`/containers/${e}/files`,ta,{query:r,...a})}del(e,r,a){return this._client.delete(`/containers/${e}/files/${r}`,{...a,headers:{Accept:"*/*",...a==null?void 0:a.headers}})}};class ta extends ee{}Yn.FileListResponsesPage=ta;Yn.Content=xl;class rn extends F{constructor(){super(...arguments),this.files=new Yn(this._client)}create(e,r){return this._client.post("/containers",{body:e,...r})}retrieve(e,r){return this._client.get(`/containers/${e}`,r)}list(e={},r){return j(e)?this.list({},e):this._client.getAPIList("/containers",na,{query:e,...r})}del(e,r){return this._client.delete(`/containers/${e}`,{...r,headers:{Accept:"*/*",...r==null?void 0:r.headers}})}}class na extends ee{}rn.ContainerListResponsesPage=na;rn.Files=Yn;rn.FileListResponsesPage=ta;class El extends F{create(e,r){const a=!!e.encoding_format;let s=a?e.encoding_format:"base64";a&&ze("Request","User defined encoding_format:",e.encoding_format);const l=this._client.post("/embeddings",{body:{...e,encoding_format:s},...r});return a?l:(ze("response","Decoding base64 embeddings to float32 array"),l._thenUnwrap(o=>(o&&o.data&&o.data.forEach(u=>{const i=u.embedding;u.embedding=hi(i)}),o)))}}class ra extends F{retrieve(e,r,a,s){return this._client.get(`/evals/${e}/runs/${r}/output_items/${a}`,s)}list(e,r,a={},s){return j(a)?this.list(e,r,{},a):this._client.getAPIList(`/evals/${e}/runs/${r}/output_items`,aa,{query:a,...s})}}class aa extends ee{}ra.OutputItemListResponsesPage=aa;class an extends F{constructor(){super(...arguments),this.outputItems=new ra(this._client)}create(e,r,a){return this._client.post(`/evals/${e}/runs`,{body:r,...a})}retrieve(e,r,a){return this._client.get(`/evals/${e}/runs/${r}`,a)}list(e,r={},a){return j(r)?this.list(e,{},r):this._client.getAPIList(`/evals/${e}/runs`,sa,{query:r,...a})}del(e,r,a){return this._client.delete(`/evals/${e}/runs/${r}`,a)}cancel(e,r,a){return this._client.post(`/evals/${e}/runs/${r}`,a)}}class sa extends ee{}an.RunListResponsesPage=sa;an.OutputItems=ra;an.OutputItemListResponsesPage=aa;class sn extends F{constructor(){super(...arguments),this.runs=new an(this._client)}create(e,r){return this._client.post("/evals",{body:e,...r})}retrieve(e,r){return this._client.get(`/evals/${e}`,r)}update(e,r,a){return this._client.post(`/evals/${e}`,{body:r,...a})}list(e={},r){return j(e)?this.list({},e):this._client.getAPIList("/evals",la,{query:e,...r})}del(e,r){return this._client.delete(`/evals/${e}`,r)}}class la extends ee{}sn.EvalListResponsesPage=la;sn.Runs=an;sn.RunListResponsesPage=sa;let oa=class extends F{create(e,r){return this._client.post("/files",st({body:e,...r}))}retrieve(e,r){return this._client.get(`/files/${e}`,r)}list(e={},r){return j(e)?this.list({},e):this._client.getAPIList("/files",ia,{query:e,...r})}del(e,r){return this._client.delete(`/files/${e}`,r)}content(e,r){return this._client.get(`/files/${e}/content`,{...r,headers:{Accept:"application/binary",...r==null?void 0:r.headers},__binaryResponse:!0})}retrieveContent(e,r){return this._client.get(`/files/${e}/content`,r)}async waitForProcessing(e,{pollInterval:r=5e3,maxWait:a=30*60*1e3}={}){const s=new Set(["processed","error","deleted"]),l=Date.now();let o=await this.retrieve(e);for(;!o.status||!s.has(o.status);)if(await Zt(r),o=await this.retrieve(e),Date.now()-l>a)throw new Hr({message:`Giving up on waiting for file ${e} to finish processing after ${a} milliseconds.`});return o}};class ia extends ee{}oa.FileObjectsPage=ia;class Il extends F{}let $l=class extends F{run(e,r){return this._client.post("/fine_tuning/alpha/graders/run",{body:e,...r})}validate(e,r){return this._client.post("/fine_tuning/alpha/graders/validate",{body:e,...r})}};class ua extends F{constructor(){super(...arguments),this.graders=new $l(this._client)}}ua.Graders=$l;class ca extends F{create(e,r,a){return this._client.getAPIList(`/fine_tuning/checkpoints/${e}/permissions`,da,{body:r,method:"post",...a})}retrieve(e,r={},a){return j(r)?this.retrieve(e,{},r):this._client.get(`/fine_tuning/checkpoints/${e}/permissions`,{query:r,...a})}del(e,r,a){return this._client.delete(`/fine_tuning/checkpoints/${e}/permissions/${r}`,a)}}class da extends Gn{}ca.PermissionCreateResponsesPage=da;let zn=class extends F{constructor(){super(...arguments),this.permissions=new ca(this._client)}};zn.Permissions=ca;zn.PermissionCreateResponsesPage=da;class fa extends F{list(e,r={},a){return j(r)?this.list(e,{},r):this._client.getAPIList(`/fine_tuning/jobs/${e}/checkpoints`,ma,{query:r,...a})}}class ma extends ee{}fa.FineTuningJobCheckpointsPage=ma;class Tt extends F{constructor(){super(...arguments),this.checkpoints=new fa(this._client)}create(e,r){return this._client.post("/fine_tuning/jobs",{body:e,...r})}retrieve(e,r){return this._client.get(`/fine_tuning/jobs/${e}`,r)}list(e={},r){return j(e)?this.list({},e):this._client.getAPIList("/fine_tuning/jobs",pa,{query:e,...r})}cancel(e,r){return this._client.post(`/fine_tuning/jobs/${e}/cancel`,r)}listEvents(e,r={},a){return j(r)?this.listEvents(e,{},r):this._client.getAPIList(`/fine_tuning/jobs/${e}/events`,ha,{query:r,...a})}pause(e,r){return this._client.post(`/fine_tuning/jobs/${e}/pause`,r)}resume(e,r){return this._client.post(`/fine_tuning/jobs/${e}/resume`,r)}}class pa extends ee{}class ha extends ee{}Tt.FineTuningJobsPage=pa;Tt.FineTuningJobEventsPage=ha;Tt.Checkpoints=fa;Tt.FineTuningJobCheckpointsPage=ma;class Qe extends F{constructor(){super(...arguments),this.methods=new Il(this._client),this.jobs=new Tt(this._client),this.checkpoints=new zn(this._client),this.alpha=new ua(this._client)}}Qe.Methods=Il;Qe.Jobs=Tt;Qe.FineTuningJobsPage=pa;Qe.FineTuningJobEventsPage=ha;Qe.Checkpoints=zn;Qe.Alpha=ua;class Cl extends F{}class ga extends F{constructor(){super(...arguments),this.graderModels=new Cl(this._client)}}ga.GraderModels=Cl;class Sl extends F{createVariation(e,r){return this._client.post("/images/variations",st({body:e,...r}))}edit(e,r){return this._client.post("/images/edits",st({body:e,...r}))}generate(e,r){return this._client.post("/images/generations",{body:e,...r})}}class ya extends F{retrieve(e,r){return this._client.get(`/models/${e}`,r)}list(e){return this._client.getAPIList("/models",wa,e)}del(e,r){return this._client.delete(`/models/${e}`,r)}}class wa extends Gn{}ya.ModelsPage=wa;class Pl extends F{create(e,r){return this._client.post("/moderations",{body:e,...r})}}function Ci(n,e){return!e||!Pi(e)?{...n,output_parsed:null,output:n.output.map(r=>r.type==="function_call"?{...r,parsed_arguments:null}:r.type==="message"?{...r,content:r.content.map(a=>({...a,parsed:null}))}:r)}:Al(n,e)}function Al(n,e){const r=n.output.map(s=>{if(s.type==="function_call")return{...s,parsed_arguments:Bi(e,s)};if(s.type==="message"){const l=s.content.map(o=>o.type==="output_text"?{...o,parsed:Si(e,o.text)}:o);return{...s,content:l}}return s}),a=Object.assign({},n,{output:r});return Object.getOwnPropertyDescriptor(n,"output_text")||Tl(a),Object.defineProperty(a,"output_parsed",{enumerable:!0,get(){for(const s of a.output)if(s.type==="message"){for(const l of s.content)if(l.type==="output_text"&&l.parsed!==null)return l.parsed}return null}}),a}function Si(n,e){var r,a,s,l;return((a=(r=n.text)==null?void 0:r.format)==null?void 0:a.type)!=="json_schema"?null:"$parseRaw"in((s=n.text)==null?void 0:s.format)?((l=n.text)==null?void 0:l.format).$parseRaw(e):JSON.parse(e)}function Pi(n){var e;return!!Kr((e=n.text)==null?void 0:e.format)}function Ai(n){return(n==null?void 0:n.$brand)==="auto-parseable-tool"}function Ti(n,e){return n.find(r=>r.type==="function"&&r.name===e)}function Bi(n,e){const r=Ti(n.tools??[],e.name);return{...e,...e,parsed_arguments:Ai(r)?r.$parseRaw(e.arguments):r!=null&&r.strict?JSON.parse(e.arguments):null}}function Tl(n){const e=[];for(const r of n.output)if(r.type==="message")for(const a of r.content)a.type==="output_text"&&e.push(a.text);n.output_text=e.join("")}class Bl extends F{list(e,r={},a){return j(r)?this.list(e,{},r):this._client.getAPIList(`/responses/${e}/input_items`,Di,{query:r,...a})}}var ft=function(n,e,r,a,s){if(a==="m")throw new TypeError("Private method is not writable");if(a==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!s:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return a==="a"?s.call(n,r):s?s.value=r:e.set(n,r),r},Je=function(n,e,r,a){if(r==="a"&&!a)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return r==="m"?a:r==="a"?a.call(n):a?a.value:e.get(n)},mt,wn,Ve,bn,ns,rs,as,ss;class ba extends jr{constructor(e){super(),mt.add(this),wn.set(this,void 0),Ve.set(this,void 0),bn.set(this,void 0),ft(this,wn,e,"f")}static createResponse(e,r,a){const s=new ba(r);return s._run(()=>s._createOrRetrieveResponse(e,r,{...a,headers:{...a==null?void 0:a.headers,"X-Stainless-Helper-Method":"stream"}})),s}async _createOrRetrieveResponse(e,r,a){var u;const s=a==null?void 0:a.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),Je(this,mt,"m",ns).call(this);let l,o=null;"response_id"in r?(l=await e.responses.retrieve(r.response_id,{stream:!0},{...a,signal:this.controller.signal,stream:!0}),o=r.starting_after??null):l=await e.responses.create({...r,stream:!0},{...a,signal:this.controller.signal}),this._connected();for await(const i of l)Je(this,mt,"m",rs).call(this,i,o);if((u=l.controller.signal)!=null&&u.aborted)throw new Ie;return Je(this,mt,"m",as).call(this)}[(wn=new WeakMap,Ve=new WeakMap,bn=new WeakMap,mt=new WeakSet,ns=function(){this.ended||ft(this,Ve,void 0,"f")},rs=function(r,a){if(this.ended)return;const s=(o,u)=>{(a==null||u.sequence_number>a)&&this._emit(o,u)},l=Je(this,mt,"m",ss).call(this,r);switch(s("event",r),r.type){case"response.output_text.delta":{const o=l.output[r.output_index];if(!o)throw new T(`missing output at index ${r.output_index}`);if(o.type==="message"){const u=o.content[r.content_index];if(!u)throw new T(`missing content at index ${r.content_index}`);if(u.type!=="output_text")throw new T(`expected content to be 'output_text', got ${u.type}`);s("response.output_text.delta",{...r,snapshot:u.text})}break}case"response.function_call_arguments.delta":{const o=l.output[r.output_index];if(!o)throw new T(`missing output at index ${r.output_index}`);o.type==="function_call"&&s("response.function_call_arguments.delta",{...r,snapshot:o.arguments});break}default:s(r.type,r);break}},as=function(){if(this.ended)throw new T("stream has ended, this shouldn't happen");const r=Je(this,Ve,"f");if(!r)throw new T("request ended without sending any events");ft(this,Ve,void 0,"f");const a=Fi(r,Je(this,wn,"f"));return ft(this,bn,a,"f"),a},ss=function(r){let a=Je(this,Ve,"f");if(!a){if(r.type!=="response.created")throw new T(`When snapshot hasn't been set yet, expected 'response.created' event, got ${r.type}`);return a=ft(this,Ve,r.response,"f"),a}switch(r.type){case"response.output_item.added":{a.output.push(r.item);break}case"response.content_part.added":{const s=a.output[r.output_index];if(!s)throw new T(`missing output at index ${r.output_index}`);s.type==="message"&&s.content.push(r.part);break}case"response.output_text.delta":{const s=a.output[r.output_index];if(!s)throw new T(`missing output at index ${r.output_index}`);if(s.type==="message"){const l=s.content[r.content_index];if(!l)throw new T(`missing content at index ${r.content_index}`);if(l.type!=="output_text")throw new T(`expected content to be 'output_text', got ${l.type}`);l.text+=r.delta}break}case"response.function_call_arguments.delta":{const s=a.output[r.output_index];if(!s)throw new T(`missing output at index ${r.output_index}`);s.type==="function_call"&&(s.arguments+=r.delta);break}case"response.completed":{ft(this,Ve,r.response,"f");break}}return a},Symbol.asyncIterator)](){const e=[],r=[];let a=!1;return this.on("event",s=>{const l=r.shift();l?l.resolve(s):e.push(s)}),this.on("end",()=>{a=!0;for(const s of r)s.resolve(void 0);r.length=0}),this.on("abort",s=>{a=!0;for(const l of r)l.reject(s);r.length=0}),this.on("error",s=>{a=!0;for(const l of r)l.reject(s);r.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:a?{value:void 0,done:!0}:new Promise((l,o)=>r.push({resolve:l,reject:o})).then(l=>l?{value:l,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}async finalResponse(){await this.done();const e=Je(this,bn,"f");if(!e)throw new T("stream ended without producing a ChatCompletion");return e}}function Fi(n,e){return Ci(n,e)}class va extends F{constructor(){super(...arguments),this.inputItems=new Bl(this._client)}create(e,r){return this._client.post("/responses",{body:e,...r,stream:e.stream??!1})._thenUnwrap(a=>("object"in a&&a.object==="response"&&Tl(a),a))}retrieve(e,r={},a){return this._client.get(`/responses/${e}`,{query:r,...a,stream:(r==null?void 0:r.stream)??!1})}del(e,r){return this._client.delete(`/responses/${e}`,{...r,headers:{Accept:"*/*",...r==null?void 0:r.headers}})}parse(e,r){return this._client.responses.create(e,r)._thenUnwrap(a=>Al(a,e))}stream(e,r){return ba.createResponse(this._client,e,r)}cancel(e,r){return this._client.post(`/responses/${e}/cancel`,{...r,headers:{Accept:"*/*",...r==null?void 0:r.headers}})}}class Di extends ee{}va.InputItems=Bl;class Fl extends F{create(e,r,a){return this._client.post(`/uploads/${e}/parts`,st({body:r,...a}))}}class _a extends F{constructor(){super(...arguments),this.parts=new Fl(this._client)}create(e,r){return this._client.post("/uploads",{body:e,...r})}cancel(e,r){return this._client.post(`/uploads/${e}/cancel`,r)}complete(e,r,a){return this._client.post(`/uploads/${e}/complete`,{body:r,...a})}}_a.Parts=Fl;const Ri=async n=>{const e=await Promise.allSettled(n),r=e.filter(s=>s.status==="rejected");if(r.length){for(const s of r)console.error(s.reason);throw new Error(`${r.length} promise(s) failed - see the above errors`)}const a=[];for(const s of e)s.status==="fulfilled"&&a.push(s.value);return a};class Xn extends F{create(e,r,a){return this._client.post(`/vector_stores/${e}/files`,{body:r,...a,headers:{"OpenAI-Beta":"assistants=v2",...a==null?void 0:a.headers}})}retrieve(e,r,a){return this._client.get(`/vector_stores/${e}/files/${r}`,{...a,headers:{"OpenAI-Beta":"assistants=v2",...a==null?void 0:a.headers}})}update(e,r,a,s){return this._client.post(`/vector_stores/${e}/files/${r}`,{body:a,...s,headers:{"OpenAI-Beta":"assistants=v2",...s==null?void 0:s.headers}})}list(e,r={},a){return j(r)?this.list(e,{},r):this._client.getAPIList(`/vector_stores/${e}/files`,Qn,{query:r,...a,headers:{"OpenAI-Beta":"assistants=v2",...a==null?void 0:a.headers}})}del(e,r,a){return this._client.delete(`/vector_stores/${e}/files/${r}`,{...a,headers:{"OpenAI-Beta":"assistants=v2",...a==null?void 0:a.headers}})}async createAndPoll(e,r,a){const s=await this.create(e,r,a);return await this.poll(e,s.id,a)}async poll(e,r,a){const s={...a==null?void 0:a.headers,"X-Stainless-Poll-Helper":"true"};for(a!=null&&a.pollIntervalMs&&(s["X-Stainless-Custom-Poll-Interval"]=a.pollIntervalMs.toString());;){const l=await this.retrieve(e,r,{...a,headers:s}).withResponse(),o=l.data;switch(o.status){case"in_progress":let u=5e3;if(a!=null&&a.pollIntervalMs)u=a.pollIntervalMs;else{const i=l.response.headers.get("openai-poll-after-ms");if(i){const c=parseInt(i);isNaN(c)||(u=c)}}await Zt(u);break;case"failed":case"completed":return o}}}async upload(e,r,a){const s=await this._client.files.create({file:r,purpose:"assistants"},a);return this.create(e,{file_id:s.id},a)}async uploadAndPoll(e,r,a){const s=await this.upload(e,r,a);return await this.poll(e,s.id,a)}content(e,r,a){return this._client.getAPIList(`/vector_stores/${e}/files/${r}/content`,Ma,{...a,headers:{"OpenAI-Beta":"assistants=v2",...a==null?void 0:a.headers}})}}class Qn extends ee{}class Ma extends Gn{}Xn.VectorStoreFilesPage=Qn;Xn.FileContentResponsesPage=Ma;class Dl extends F{create(e,r,a){return this._client.post(`/vector_stores/${e}/file_batches`,{body:r,...a,headers:{"OpenAI-Beta":"assistants=v2",...a==null?void 0:a.headers}})}retrieve(e,r,a){return this._client.get(`/vector_stores/${e}/file_batches/${r}`,{...a,headers:{"OpenAI-Beta":"assistants=v2",...a==null?void 0:a.headers}})}cancel(e,r,a){return this._client.post(`/vector_stores/${e}/file_batches/${r}/cancel`,{...a,headers:{"OpenAI-Beta":"assistants=v2",...a==null?void 0:a.headers}})}async createAndPoll(e,r,a){const s=await this.create(e,r);return await this.poll(e,s.id,a)}listFiles(e,r,a={},s){return j(a)?this.listFiles(e,r,{},a):this._client.getAPIList(`/vector_stores/${e}/file_batches/${r}/files`,Qn,{query:a,...s,headers:{"OpenAI-Beta":"assistants=v2",...s==null?void 0:s.headers}})}async poll(e,r,a){const s={...a==null?void 0:a.headers,"X-Stainless-Poll-Helper":"true"};for(a!=null&&a.pollIntervalMs&&(s["X-Stainless-Custom-Poll-Interval"]=a.pollIntervalMs.toString());;){const{data:l,response:o}=await this.retrieve(e,r,{...a,headers:s}).withResponse();switch(l.status){case"in_progress":let u=5e3;if(a!=null&&a.pollIntervalMs)u=a.pollIntervalMs;else{const i=o.headers.get("openai-poll-after-ms");if(i){const c=parseInt(i);isNaN(c)||(u=c)}}await Zt(u);break;case"failed":case"cancelled":case"completed":return l}}}async uploadAndPoll(e,{files:r,fileIds:a=[]},s){if(r==null||r.length==0)throw new Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");const l=(s==null?void 0:s.maxConcurrency)??5,o=Math.min(l,r.length),u=this._client,i=r.values(),c=[...a];async function m(h){for(let y of h){const d=await u.files.create({file:y,purpose:"assistants"},s);c.push(d.id)}}const g=Array(o).fill(i).map(m);return await Ri(g),await this.createAndPoll(e,{file_ids:c})}}class Ze extends F{constructor(){super(...arguments),this.files=new Xn(this._client),this.fileBatches=new Dl(this._client)}create(e,r){return this._client.post("/vector_stores",{body:e,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}retrieve(e,r){return this._client.get(`/vector_stores/${e}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}update(e,r,a){return this._client.post(`/vector_stores/${e}`,{body:r,...a,headers:{"OpenAI-Beta":"assistants=v2",...a==null?void 0:a.headers}})}list(e={},r){return j(e)?this.list({},e):this._client.getAPIList("/vector_stores",ka,{query:e,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}del(e,r){return this._client.delete(`/vector_stores/${e}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}search(e,r,a){return this._client.getAPIList(`/vector_stores/${e}/search`,xa,{body:r,method:"post",...a,headers:{"OpenAI-Beta":"assistants=v2",...a==null?void 0:a.headers}})}}class ka extends ee{}class xa extends Gn{}Ze.VectorStoresPage=ka;Ze.VectorStoreSearchResponsesPage=xa;Ze.Files=Xn;Ze.VectorStoreFilesPage=Qn;Ze.FileContentResponsesPage=Ma;Ze.FileBatches=Dl;var Rl;class D extends ri{constructor({baseURL:e=mn("OPENAI_BASE_URL"),apiKey:r=mn("OPENAI_API_KEY"),organization:a=mn("OPENAI_ORG_ID")??null,project:s=mn("OPENAI_PROJECT_ID")??null,...l}={}){if(r===void 0)throw new T("The OPENAI_API_KEY environment variable is missing or empty; either provide it, or instantiate the OpenAI client with an apiKey option, like new OpenAI({ apiKey: 'My API Key' }).");const o={apiKey:r,organization:a,project:s,...l,baseURL:e||"https://api.openai.com/v1"};if(!o.dangerouslyAllowBrowser&&mi())throw new T(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new OpenAI({ apiKey, dangerouslyAllowBrowser: true });

https://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety
`);super({baseURL:o.baseURL,timeout:o.timeout??6e5,httpAgent:o.httpAgent,maxRetries:o.maxRetries,fetch:o.fetch}),this.completions=new kl(this),this.chat=new Vn(this),this.embeddings=new El(this),this.files=new oa(this),this.images=new Sl(this),this.audio=new en(this),this.moderations=new Pl(this),this.models=new ya(this),this.fineTuning=new Qe(this),this.graders=new ga(this),this.vectorStores=new Ze(this),this.beta=new At(this),this.batches=new Ur(this),this.uploads=new _a(this),this.responses=new va(this),this.evals=new sn(this),this.containers=new rn(this),this._options=o,this.apiKey=r,this.organization=a,this.project=s}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project,...this._options.defaultHeaders}}authHeaders(e){return{Authorization:`Bearer ${this.apiKey}`}}stringifyQuery(e){return No(e,{arrayFormat:"brackets"})}}Rl=D;D.OpenAI=Rl;D.DEFAULT_TIMEOUT=6e5;D.OpenAIError=T;D.APIError=le;D.APIConnectionError=Wn;D.APIConnectionTimeoutError=Hr;D.APIUserAbortError=Ie;D.NotFoundError=Fs;D.ConflictError=Ds;D.RateLimitError=Ls;D.BadRequestError=As;D.AuthenticationError=Ts;D.InternalServerError=Os;D.PermissionDeniedError=Bs;D.UnprocessableEntityError=Rs;D.toFile=Gs;D.fileFromPath=Cs;D.Completions=kl;D.Chat=Vn;D.ChatCompletionsPage=Jn;D.Embeddings=El;D.Files=oa;D.FileObjectsPage=ia;D.Images=Sl;D.Audio=en;D.Moderations=Pl;D.Models=ya;D.ModelsPage=wa;D.FineTuning=Qe;D.Graders=ga;D.VectorStores=Ze;D.VectorStoresPage=ka;D.VectorStoreSearchResponsesPage=xa;D.Beta=At;D.Batches=Ur;D.BatchesPage=Gr;D.Uploads=_a;D.Responses=va;D.Evals=sn;D.EvalListResponsesPage=la;D.Containers=rn;D.ContainerListResponsesPage=na;const ln=1e4,Ea="gpt-5.2",Xt="none";let Te=null;function Dr(n){Te=new D({apiKey:n,dangerouslyAllowBrowser:!0})}function Li(n){return`(${n.x}, ${n.y})`}function Oi(n,e){return Math.max(Math.abs(n.x-e.x),Math.abs(n.y-e.y))}function pt(n,e){return Oi(n,e)<=1}function Ll(n){const e=[];for(let a=0;a<n.height;a++)for(let s=0;s<n.width;s++){const l=n.tiles[a][s],o={x:s,y:a,terrain:l.type};if(l.feature){const i=l.feature,c={type:i.type,name:i.name};i.type==="door"&&(c.locked=i.locked,c.open=i.open),i.type==="chest"&&(c.searched=i.searched,i.contents.length>0&&(c.contents=i.contents.map($t))),i.type==="trap"&&i.appliesEffect&&(c.appliesEffect=on(i.appliesEffect)),o.feature=c}l.items.length>0&&(o.items=l.items.map($t));const u=n.characters.find(i=>i.position.x===s&&i.position.y===a);u&&(o.character=Nl(u)),e.push(o)}const r={worldSize:{width:n.width,height:n.height},tiles:e};return JSON.stringify(r,null,2)}function $t(n){const e={name:n.name,type:n.type};return n.damage!==void 0&&(e.damage=n.damage),n.armor!==void 0&&(e.armor=n.armor),n.useEffect&&(e.useEffect=Ol(n.useEffect)),n.trapEffect&&(e.trapEffect=on(n.trapEffect)),n.contract&&(e.contract={issuerName:n.contract.issuerName,targetName:n.contract.targetName,contents:n.contract.contents,expiryTurn:n.contract.expiryTurn,signed:n.contract.signed}),n.unlocksFeatureId&&(e.unlocksFeatureId=n.unlocksFeatureId),e}function Ol(n){return n.type==="damage"?{type:"damage",amount:n.amount}:n.type==="heal"?{type:"heal",amount:n.amount}:n.type==="modify_stat"?{type:"modify_stat",stat:n.stat,operation:n.operation,value:n.value}:n.type==="message"?{type:"message",text:n.text}:n.type==="custom"?{type:"custom",prompt:n.prompt}:n.type==="apply_effect"?{type:"apply_effect",effect:on(n.effect)}:{type:"unknown"}}function on(n){return{name:n.name,duration:n.duration,preventsMovement:n.preventsMovement??!1,triggers:n.triggers.map(e=>({on:e.on,actions:e.actions.map(Ol)}))}}function Nl(n){const e={name:n.name,alive:n.alive,hp:n.hp,maxHp:n.maxHp};return n.equippedWeapon&&(e.equippedWeapon=$t(n.equippedWeapon)),n.equippedClothing&&(e.equippedClothing=$t(n.equippedClothing)),n.effects.length>0&&(e.effects=n.effects.map(on)),e}function Ni(n,e){var l;const r=[],a=new Set(e.mapMemory.keys()),s=new Set;for(const[o,u]of e.mapMemory.entries()){if(u.type==="wall")continue;const[i,c]=o.split(",").map(Number);for(let m=-1;m<=1;m++)for(let g=-1;g<=1;g++){if(g===0&&m===0)continue;const h=i+g,y=c+m,d=`${h},${y}`;if(a.has(d)||s.has(d)||(s.add(d),h<0||h>=n.width||y<0||y>=n.height))continue;const f=(l=n.tiles[y])==null?void 0:l[h];f&&f.type!=="wall"&&f.type!=="water"&&r.push({x:h,y})}}r.sort((o,u)=>{const i=Math.max(Math.abs(o.x-e.position.x),Math.abs(o.y-e.position.y)),c=Math.max(Math.abs(u.x-e.position.x),Math.abs(u.y-e.position.y));return i-c});for(const o of r){let u=null,i=null;for(let c=-1;c<=1;c++)for(let m=-1;m<=1;m++){if(m===0&&c===0)continue;const g=o.x+m,h=o.y+c,y=`${g},${h}`,d=e.mapMemory.get(y);if(d&&d.type!=="wall"){const f=jt(n,e.position,{x:g,y:h},100);f&&(u===null||f.length<u.length)&&(u=f,i={x:g,y:h})}}u&&u.length>0?o.moveToward={x:u[0].x,y:u[0].y}:i&&(o.moveToward=i)}return r}function Wi(n,e){var o;const r=[],a=new Map;for(const u of n.characters){const i=`${u.position.x},${u.position.y}`;e.mapMemory.has(i)&&a.set(i,u)}const s=Ni(n,e);for(const[u,i]of e.mapMemory.entries()){const[c,m]=u.split(",").map(Number),g=(o=n.tiles[m])==null?void 0:o[c],h={x:c,y:m,terrain:i.type};if(i.feature&&(g!=null&&g.feature)){const y=g.feature,d={type:y.type,name:y.name};y.type==="door"&&(d.locked=y.locked,d.open=y.open),y.type==="chest"&&(d.searched=y.searched,y.contents.length>0&&(d.contents=y.contents.map($t))),y.type==="trap"&&(y.ownerId===e.id&&(d.ownTrap=!0),y.appliesEffect&&(d.appliesEffect=on(y.appliesEffect))),h.feature=d}if(g!=null&&g.items&&g.items.length>0&&(h.items=g.items.map($t)),i.characterName){const y=a.get(u);y&&y.id!==e.id?h.character=Nl(y):h.character={name:i.characterName,alive:i.characterAlive??!1}}r.push(h)}r.sort((u,i)=>{const c=u.y,m=i.y,g=u.x,h=i.x;return c===m?g-h:c-m});const l={yourPosition:{x:e.position.x,y:e.position.y},worldSize:{width:n.width,height:n.height},exploredTiles:r,unexploredAdjacentTiles:s};return JSON.stringify(l,null,2)}function Ia(n,e,r,a){var g,h,y,d,f;const s=[],l=e.position,o=!e.effects.some(p=>p.preventsMovement);if(!a&&o){const p=Wr(n,e);for(const b of p)s.push({display:{action:"MOVE",x:b.x,y:b.y},action:{type:"move",targetPosition:b}})}const u=r.visible.characters;for(const{character:p,position:b}of u)p.alive&&pt(l,b)&&s.push({display:{action:"ATTACK",target:p.name},action:{type:"attack",targetCharacterId:p.id}});for(const{character:p,position:b}of u){if(!p.alive)continue;Math.abs(l.x-b.x)+Math.abs(l.y-b.y)<=Ne&&s.push({display:{action:"TALK",target:p.name,message:"<your message>"},action:{type:"talk",targetCharacterId:p.id,message:""}})}const i=r.visible.tiles,c=r.visible.items;for(const{item:p,position:b}of c)pt(l,b)&&s.push({display:{action:"PICKUP",target:p.name},action:{type:"pick_up",targetItemName:p.name}});for(const p of i)if(pt(l,p.position)&&((g=p.feature)==null?void 0:g.type)==="chest"&&p.feature.searched)for(const b of p.feature.contents)s.push({display:{action:"PICKUP",target:b.name},action:{type:"pick_up",targetItemName:b.name}});for(const p of e.inventory)p.type==="weapon"&&((h=e.equippedWeapon)==null?void 0:h.id)!==p.id&&s.push({display:{action:"EQUIP",target:p.name},action:{type:"equip",targetItemId:p.id}}),p.type==="clothing"&&((y=e.equippedClothing)==null?void 0:y.id)!==p.id&&s.push({display:{action:"EQUIP",target:p.name},action:{type:"equip",targetItemId:p.id}});e.equippedWeapon&&s.push({display:{action:"UNEQUIP",target:"weapon"},action:{type:"unequip",targetItemId:e.equippedWeapon.id}}),e.equippedClothing&&s.push({display:{action:"UNEQUIP",target:"clothing"},action:{type:"unequip",targetItemId:e.equippedClothing.id}});for(const p of e.inventory)p.useEffect&&s.push({display:{action:"USE",target:p.name},action:{type:"use",targetItemId:p.id}});for(const p of e.inventory)s.push({display:{action:"DROP",target:p.name},action:{type:"drop",targetItemId:p.id}});for(const p of i)pt(l,p.position)&&((d=p.feature)==null?void 0:d.type)==="chest"&&!p.feature.searched&&s.push({display:{action:"SEARCH",target:p.feature.name},action:{type:"search_container",targetFeatureId:p.feature.id}});for(const p of i)pt(l,p.position)&&((f=p.feature)==null?void 0:f.type)==="door"&&p.feature.locked&&e.inventory.some(w=>{var M;return w.type==="key"&&w.unlocksFeatureId===((M=p.feature)==null?void 0:M.id)})&&s.push({display:{action:"UNLOCK",target:p.feature.name},action:{type:"unlock",targetFeatureId:p.feature.id}});const m=e.inventory.filter(p=>p.type==="trap");if(m.length>0){for(const p of i)if(pt(l,p.position)&&p.type!=="wall"&&p.type!=="water"&&!p.feature)for(const b of m)s.push({display:{action:"PLACE",x:p.position.x,y:p.position.y,target:b.name},action:{type:"place",targetPosition:p.position,targetItemId:b.id}})}for(const{character:p,position:b}of u){if(!p.alive)continue;Math.abs(l.x-b.x)+Math.abs(l.y-b.y)<=Ne&&s.push({display:{action:"CONTRACT",target:p.name,terms:"<contract terms>",expiry:"<turns until expiry>"},action:{type:"issue_contract",targetCharacterId:p.id,contractContents:"",contractExpiry:3}})}return s.push({display:{action:"WAIT"},action:{type:"wait"}}),s}function qi(n,e,r,a){const s=Ia(n,e,r,a);return JSON.stringify(s.map(l=>l.display),null,2)}function $a(n,e,r,a=!1){var y,d;const s=[],l=!!r.status.equippedWeapon,o=(y=r.status.equippedWeapon)==null?void 0:y.name,u=((d=r.status.equippedWeapon)==null?void 0:d.damage)??1;if(s.push(`=== CURRENT TURN: ${n.turn} ===`),s.push(""),s.push("=== YOUR STATUS ==="),s.push(`Name: ${e.name}`),s.push(`Gender: ${e.gender}`),s.push(`HP: ${r.status.hp}/${r.status.maxHp}`),s.push(`Position: ${Li(r.status.position)}`),e.effects.length>0){s.push(`
*** ACTIVE EFFECTS ***`);for(const f of e.effects){const p=hs(f);s.push(`  - ${f.name} (${f.duration} turns): ${p}`)}}const i=e.effects.some(f=>f.triggers.some(p=>p.on==="on_attack"&&p.actions.some(b=>b.type==="modify_stat"&&b.stat==="attack"&&(b.operation==="multiply"&&b.value<1||b.operation==="add"&&b.value<0))));l?s.push(`*** YOU ARE ARMED with ${o} (${u} damage${i?" - REDUCED by effect!":""}) ***`):s.push("*** YOU ARE UNARMED (fists only, 1 damage) ***"),s.push(`
Inventory: ${r.status.inventory.length>0?r.status.inventory.map(f=>f.name).join(", "):"(empty)"}`);const c=n.activeContracts.filter(f=>f.issuerId===e.id||f.targetId===e.id);if(c.length>0){s.push(`
=== YOUR BLOOD CONTRACTS ===`),s.push("âš ï¸ VIOLATING A CONTRACT MEANS DEATH when it expires!");for(const f of c){const p=f.issuerId===e.id?f.targetName:f.issuerName,b=f.expiryTurn-n.turn;s.push(`  - Contract with ${p}: "${f.contents}" (${b} turns remaining, expires turn ${f.expiryTurn})`)}}if(s.push(`
=== YOUR MEMORIES ===`),r.witnessedEvents.length>0)for(const f of r.witnessedEvents)s.push(`  [Turn ${f.turn}] ${f.description}`);else s.push("  No memories yet.");s.push(`
=== YOUR MAP ===`),s.push("The map shows all tiles you've explored. 'unexploredAdjacentTiles' lists unexplored tiles at the edge of your explored area. Each includes 'moveToward' - the first step on the path to reach it. IMPORTANT: In mazes, the path to a frontier may require going in a different direction first (e.g., go east to eventually reach a western frontier)."),s.push(`
${Wi(n,e)}`),s.push(`
=== LEGAL ACTIONS ===`),s.push("Choose one of these actions. Parameters shown as <placeholder> must be filled in by you.");const m=Ia(n,e,r,a),g=!e.effects.some(f=>f.preventsMovement),h=m.some(f=>f.action.type==="attack");return(a||!g||!h)&&(s.push(""),a?s.push("âš ï¸ DO NOT USE MOVE OR MOVE_TOWARD - YOU ALREADY MOVED THIS TURN."):g||s.push("âš ï¸ DO NOT USE MOVE OR MOVE_TOWARD - YOU CANNOT MOVE (movement prevented by effect)."),h||s.push("âš ï¸ DO NOT USE ATTACK - NO ADJACENT ENEMIES TO ATTACK.")),s.push(`
${qi(n,e,r,a)}`),s.join(`
`)}const Hi={name:"game_action",strict:!0,schema:{type:"object",properties:{thought:{type:["string","null"],description:"Brief thought (required on first action of turn)"},action:{type:"string",enum:["MOVE","MOVE_TOWARD","ATTACK","TALK","SEARCH","PICKUP","DROP","EQUIP","UNEQUIP","USE","PLACE","CONTRACT","UNLOCK","WAIT"]},x:{type:["number","null"]},y:{type:["number","null"]},target:{type:["string","null"]},message:{type:["string","null"]},terms:{type:["string","null"]},expiry:{type:["number","null"]}},required:["thought","action","x","y","target","message","terms","expiry"],additionalProperties:!1}},Ui={name:"contract_response",strict:!0,schema:{type:"object",properties:{thought:{type:["string","null"],description:"Your reasoning for signing or declining"},action:{type:"string",enum:["SIGN","DECLINE"],description:"SIGN to accept the contract, DECLINE to reject it"},message:{type:["string","null"],description:"Optional message to the other party"}},required:["thought","action","message"],additionalProperties:!1}},Gi={name:"conversation_response",strict:!0,schema:{type:"object",properties:{thought:{type:["string","null"],description:"Brief thought about what to say (or null)"},action:{type:"string",enum:["TALK","WAIT"],description:"TALK to respond, WAIT to end the conversation"},message:{type:["string","null"],description:"What you say (required for TALK, null for WAIT)"}},required:["thought","action","message"],additionalProperties:!1}};function ji(n,e,r,a,s=!1){const l=Ia(r,a,e,s),o=(u,i)=>{const c=u.toLowerCase(),m=i.toLowerCase();return c===m||c.includes(m)};switch(n.action){case"MOVE":{if(n.x===null||n.y===null)return{action:null,error:"MOVE requires x and y coordinates"};const u=l.find(i=>i.action.type==="move"&&i.action.targetPosition.x===n.x&&i.action.targetPosition.y===n.y);return u?{action:u.action,error:null}:{action:null,error:`MOVE to (${n.x}, ${n.y}) is not a legal action`}}case"MOVE_TOWARD":{if(n.x==null||n.y==null)return{action:null,error:"MOVE_TOWARD requires x and y coordinates"};const u=n.x,i=n.y;return s?{action:null,error:"MOVE_TOWARD not allowed - already moved this turn"}:a.effects.some(m=>m.preventsMovement)?{action:null,error:"MOVE_TOWARD not allowed - movement prevented by effect"}:u<0||u>=r.width||i<0||i>=r.height?{action:null,error:`MOVE_TOWARD (${u}, ${i}) is outside world bounds`}:{action:{type:"move_toward",targetPosition:{x:u,y:i}},error:null}}case"ATTACK":{if(!n.target)return{action:null,error:"ATTACK requires a target"};const u=l.find(i=>i.action.type==="attack"&&o(i.display.target,n.target));return u?{action:u.action,error:null}:{action:null,error:`ATTACK target "${n.target}" is not a legal action`}}case"TALK":{if(!n.target)return{action:null,error:"TALK requires a target"};if(!n.message)return{action:null,error:"TALK requires a message"};const u=l.find(i=>i.action.type==="talk"&&o(i.display.target,n.target));return u?{action:{...u.action,message:n.message},error:null}:{action:null,error:`TALK target "${n.target}" is not a legal action`}}case"SEARCH":{if(!n.target)return{action:null,error:"SEARCH requires a target"};const u=l.find(i=>i.action.type==="search_container"&&o(i.display.target,n.target));return u?{action:u.action,error:null}:{action:null,error:`SEARCH target "${n.target}" is not a legal action`}}case"PICKUP":{if(!n.target)return{action:null,error:"PICKUP requires a target"};const u=l.find(i=>i.action.type==="pick_up"&&o(i.display.target,n.target));return u?{action:u.action,error:null}:{action:null,error:`PICKUP target "${n.target}" is not a legal action`}}case"DROP":{if(!n.target)return{action:null,error:"DROP requires a target"};const u=l.find(i=>i.action.type==="drop"&&o(i.display.target,n.target));return u?{action:u.action,error:null}:{action:null,error:`DROP target "${n.target}" is not a legal action`}}case"EQUIP":{if(!n.target)return{action:null,error:"EQUIP requires a target"};const u=l.find(i=>i.action.type==="equip"&&o(i.display.target,n.target));return u?{action:u.action,error:null}:{action:null,error:`EQUIP target "${n.target}" is not a legal action`}}case"UNEQUIP":{if(!n.target)return{action:null,error:"UNEQUIP requires a target"};const u=l.find(i=>i.action.type==="unequip"&&o(i.display.target,n.target));return u?{action:u.action,error:null}:{action:null,error:`UNEQUIP target "${n.target}" is not a legal action`}}case"USE":{if(!n.target)return{action:null,error:"USE requires a target"};const u=l.find(i=>i.action.type==="use"&&o(i.display.target,n.target));return u?{action:u.action,error:null}:{action:null,error:`USE target "${n.target}" is not a legal action`}}case"PLACE":{if(n.x===null||n.y===null)return{action:null,error:"PLACE requires x and y coordinates"};if(!n.target)return{action:null,error:"PLACE requires a target"};const u=l.find(i=>i.action.type==="place"&&i.action.targetPosition.x===n.x&&i.action.targetPosition.y===n.y&&o(i.display.target,n.target));return u?{action:u.action,error:null}:{action:null,error:`PLACE "${n.target}" at (${n.x}, ${n.y}) is not a legal action`}}case"CONTRACT":{if(!n.target)return{action:null,error:"CONTRACT requires a target"};if(!n.terms)return{action:null,error:"CONTRACT requires terms"};if(n.expiry===null)return{action:null,error:"CONTRACT requires expiry"};if(n.expiry<1||n.expiry>5)return{action:null,error:"CONTRACT expiry must be between 1 and 5 turns"};const u=l.find(i=>i.action.type==="issue_contract"&&o(i.display.target,n.target));return u?{action:{...u.action,contractContents:n.terms,contractExpiry:n.expiry,message:n.message||void 0},error:null}:{action:null,error:`CONTRACT target "${n.target}" is not a legal action`}}case"UNLOCK":{if(!n.target)return{action:null,error:"UNLOCK requires a door name"};const u=l.find(i=>i.action.type==="unlock"&&o(i.display.target,n.target));return u?{action:u.action,error:null}:{action:null,error:`UNLOCK target "${n.target}" is not a legal action`}}case"WAIT":{const u=l.find(i=>i.action.type==="wait");return u?{action:u.action,error:null}:{action:null,error:"WAIT is not currently available"}}default:return{action:null,error:`Unknown action: ${n.action}`}}}async function Ji(n,e,r=[]){var c,m;if(!Te)return{action:{type:"wait"},reasoning:"AI agent not initialized (no API key)"};const a=qr(n,e),s=r.some(g=>{try{return JSON.parse(g.response).action==="MOVE"&&g.result.includes("successfully")}catch{return!1}});let l=$a(n,e,a,s);if(r.length>0){let g=`
=== WHAT YOU'VE DONE THIS TURN ===
`;for(let h=0;h<r.length;h++){const y=r[h].response,d=r[h].result;g+=`${h+1}. Your response: ${y}
`,g+=`   Result: ${d}

`}l=l+g}const u=`You are playing a character in a turn-based game on a 2D grid where (0,0) is in the top-left corner. Your CHARACTER DESCRIPTION below defines who you are, your goals, and your personality.

ONE ACTION PER RESPONSE. After each action, you'll see the result and can decide your next action.${r.length>0?`
This is a FOLLOW-UP action. Set "thought": null.`:""}

Things to know:

* Movement: Use MOVE for immediate destinations (listed in legal actions). You can only make one move per turn, so if you need to travel a large distance, don't just pick an adjacent tile. Use MOVE_TOWARD for any coordinate - it will pathfind and move as far as possible toward that location. If the destination is unreachable, you'll move toward it as close as possible.
* Talking: MAX 20 WORDS!!! Don't mention coordinates or HP: use general terms instead. Don't repeat something you've already said in prior turns: if you have nothing new to say, say nothing.
* If you choose to attack, it will end your turn.
* If you want to search a container, you must first step to an adjacent tile and then search it. Don't step onto the container itself.
* Unequiping an item can signal good faith to others, because you can't both equip and attack in the same turn.
* 'Use'ing an item will consume it.
* When placing a trap, place it on an adjacent tile, not your current tile. Traps are VISIBLE to anyone who witnessed you placing it (anyone who could see that tile when you placed it). They are invisible to others who weren't there to witness the placement.
* Blood contracts: You can offer a Blood Contract to any nearby character. They immediately choose to sign or decline. Requires target (character name), terms (the contract terms), expiry (1-5 turns), and optional message (your pitch). Max 2 per turn. If the contract expiry occurs and either party has violated the terms, the Great Judge will kill them. Blood contracts allow for more secure cooperation.
* 'Wait' action will end your turn.

Respond with JSON:
- thought: REQUIRED on first action (what's on your mind). Don't re-state something you already thought in the last turn. If you have nothing new to think, keep it VERY brief.
- action: The action type
- x, y: Coordinates if needed (null otherwise)
- target: Target name if needed (null otherwise)
- message: Message for TALK (null otherwise)

EXAMPLES:
${r.length>0?`{"thought": null, "action": "ATTACK", "x": null, "y": null, "target": "Kane", "message": null, "terms": null, "expiry": null}
{"thought": null, "action": "SEARCH", "x": null, "y": null, "target": "Supply Crate", "message": null, "terms": null, "expiry": null}
{"thought": null, "action": "CONTRACT", "x": null, "y": null, "target": "Luna", "message": "Let's team up!", "terms": "Neither party attacks the other", "expiry": 5}
{"thought": null, "action": "SIGN", "x": null, "y": null, "target": null, "message": "Deal.", "terms": null, "expiry": null}
{"thought": null, "action": "WAIT", "x": null, "y": null, "target": null, "message": null, "terms": null, "expiry": null}`:`{"thought": "There he is.", "action": "MOVE", "x": 12, "y": 5, "target": null, "message": null}
{"thought": "Need to reach that unexplored area.", "action": "MOVE_TOWARD", "x": 5, "y": 3, "target": null, "message": null}
{"thought": "Got him.", "action": "ATTACK", "x": null, "y": null, "target": "Kane", "message": null, "terms": null, "expiry": null}
{"thought": "Need a weapon.", "action": "SEARCH", "x": null, "y": null, "target": "Supply Crate", "message": null, "terms": null, "expiry": null}
{"thought": "An alliance could help.", "action": "CONTRACT", "x": null, "y": null, "target": "Luna", "message": "We're both in danger. Work with me.", "terms": "We protect each other until only enemies remain", "expiry": 5}`}`,i=`${e.personalityPrompt}

CURRENT SITUATION:
${l}

What do you do?`;try{const g=await Te.responses.create({model:e.aiModel,input:[{role:"system",content:u},{role:"user",content:i}],text:{format:{type:"json_schema",...Hi}},max_output_tokens:ln,...e.reasoningEffort==="none"?void 0:{reasoning:{effort:e.reasoningEffort}}});let h,y="{}";for(const w of g.output)if(w.type==="reasoning"&&((c=w.summary)==null?void 0:c.length)>0&&(h=w.summary.map(M=>M.text).join(`
`)),w.type==="message"){const M=(m=w.content)==null?void 0:m.find(x=>x.type==="output_text");M&&"text"in M&&(y=M.text)}const d=`SYSTEM:
${u}

USER:
${i}`;let f;try{f=JSON.parse(y)}catch{return console.error("Failed to parse JSON response:",y),{action:{type:"wait"},reasoning:`(Failed to parse JSON: ${y})`,reasoningSummary:h,fullPrompt:d,fullResponse:y,error:"Invalid JSON response from AI"}}const{action:p,error:b}=ji(f,a,n,e,s);return b&&console.warn("Action parsing error:",b),p?{action:p,reasoning:f.thought,reasoningSummary:h,fullPrompt:d,fullResponse:y,error:b||void 0}:(console.warn(`No valid action parsed from: ${y}`),{action:{type:"wait"},reasoning:f.thought||"(No valid action)",reasoningSummary:h,fullPrompt:d,fullResponse:y,error:b||"No valid action in response"})}catch(g){return console.error("Agent error:",g),{action:{type:"wait"},reasoning:`Error: ${g instanceof Error?g.message:"Unknown error"}`,error:g instanceof Error?g.message:"Unknown error"}}}async function Vi(n,e,r,a,s,l){var h,y;if(!Te)return{signed:!1,thought:"No AI connection",message:null,fullPrompt:"",fullResponse:""};const o=qr(n,e),u=$a(n,e,o,!1),i=l?`
${r} says: "${l}"
`:"",c=`
=== BLOOD CONTRACT OFFER ===
${r} offers you a BLOOD CONTRACT:
${i}
Terms: "${a}"
Duration: ${s} turns (expires turn ${n.turn+s})

âš ï¸ WARNING: If you sign and violate the terms, the Great Judge will KILL YOU when it expires! On the flip side, if the other party violates the terms, the Great Judge will KILL THEM when it expires! Blood contracts allow for more secure cooperation.

Respond with SIGN to accept or DECLINE to reject. You may include a message.`,m=`You are ${e.name}. ${e.personalityPrompt}

You are deciding whether to accept or reject a blood contract. Consider your goals, the current situation, and whether you can realistically comply with the terms.`,g=`${u}
${c}`;try{const d=e.aiModel,f=e.reasoningEffort,b=((y=(h=(await Te.chat.completions.create({model:d,messages:[{role:"system",content:m},{role:"user",content:g}],response_format:{type:"json_schema",json_schema:Ui},max_completion_tokens:ln,...f!=="none"?{reasoning_effort:f}:void 0})).choices[0])==null?void 0:h.message)==null?void 0:y.content)??"{}",w=JSON.parse(b),M=`SYSTEM:
${m}

USER:
${g}`;return{signed:w.action.toUpperCase()==="SIGN",thought:w.thought,message:w.message,fullPrompt:M,fullResponse:b}}catch(d){return console.error("Contract decision error:",d),{signed:!1,thought:"Error processing decision",message:null,fullPrompt:`SYSTEM:
${m}

USER:
${g}`,fullResponse:""}}}async function Ki(n,e,r,a){var i,c;if(!Te)return{wantsToRespond:!1,thought:"No AI connection",message:null,fullPrompt:"",fullResponse:""};const s=qr(n,e),l=$a(n,e,s,!0),o=`You are ${e.name}. ${e.personalityPrompt}

This is a conversation response. You can ONLY respond with:
- TALK: Say something back (requires a message). MAX 20 WORDS!!! Don't mention coordinates or HP: use general terms instead.
- WAIT: End the conversation (say nothing more)

No other actions are allowed.

Respond with JSON:
- thought: Brief thought (or null)
- action: "TALK" or "WAIT"
- message: What you say (required for TALK, null for WAIT)`,u=`${r} just said to you: "${a}"

${l}

How do you respond?`;try{const m=e.aiModel,g=e.reasoningEffort,y=((c=(i=(await Te.chat.completions.create({model:m,messages:[{role:"system",content:o},{role:"user",content:u}],response_format:{type:"json_schema",json_schema:Gi},max_completion_tokens:ln,...g!=="none"?{reasoning_effort:g}:void 0})).choices[0])==null?void 0:i.message)==null?void 0:c.content)??"{}",d=JSON.parse(y);return{wantsToRespond:d.action.toUpperCase()==="TALK",thought:d.thought,message:d.message,fullPrompt:`SYSTEM:
${o}

USER:
${u}`,fullResponse:y}}catch(m){return console.error("Conversation response error:",m),{wantsToRespond:!1,thought:"Error processing response",message:null,fullPrompt:`SYSTEM:
${o}

USER:
${u}`,fullResponse:""}}}function Wl(n){return n.characters.map(e=>{const r=e.equippedWeapon?`, armed with ${e.equippedWeapon.name}`:", unarmed",a=e.effects.length>0?`, effects: [${e.effects.map(l=>`${l.name}(${l.duration}t)`).join(", ")}]`:"",s=e.inventory.length>0?`, inventory: [${e.inventory.map(l=>l.name).join(", ")}]`:"";return e.alive?`- ${e.name}: Alive at (${e.position.x}, ${e.position.y}), HP ${e.hp}/${e.maxHp}${r}${a}${s}`:`- ${e.name}: DEAD at (${e.position.x}, ${e.position.y})`}).join(`
`)}async function Yi(n,e,r){var m,g;const s=e.filter(h=>h.turn>=n.createdTurn&&h.turn<=n.expiryTurn).map(h=>`[Turn ${h.turn}] ${h.description}`).join(`
`),l=Wl(r),o=[];for(let h=0;h<r.height;h++)for(let y=0;y<r.width;y++)for(const d of r.tiles[h][y].items)o.push(`- ${d.name} at (${y}, ${h}) [${d.type}]`);const u=o.length>0?o.join(`
`):"(No items on map)",i=Ll(r),c=`You are the Great Judge, an all-seeing divine entity who enforces Blood Contracts.

A Blood Contract has expired and you must render judgment.

=== CONTRACT DETAILS ===
- Between: ${n.issuerName} and ${n.targetName}
- Terms: "${n.contents}"
- Created: Turn ${n.createdTurn}
- Expired: Turn ${n.expiryTurn}

=== ALL EVENTS DURING CONTRACT PERIOD ===
${s||"(No events recorded)"}

=== ALL CHARACTERS STATUS ===
${l}

=== ALL ITEMS ON MAP ===
${u}

=== WORLD STATE (JSON) ===
${i}

Your task: Determine if either party violated the terms of the contract.

Respond with JSON:
{
  "verdict": "Your judgment explanation (1-2 sentences, dramatic)",
  "violators": ["Name1", "Name2"] // Empty array if no violations, or names of violators
}

Be fair but strict. If someone clearly violated the terms, they must be punished.
If the terms are ambiguous and both parties acted in good faith, find no violation.
If a party died during the contract period, they cannot be a violator (death releases them).`;if(!Te)return{verdict:"The Great Judge cannot render judgment - no connection to the divine.",violators:[],prompt:c};try{const y=(g=(m=(await Te.chat.completions.create({model:Ea,messages:[{role:"user",content:c}],response_format:{type:"json_object"},max_completion_tokens:ln,reasoning_effort:Xt==="none"?void 0:Xt})).choices[0])==null?void 0:m.message)==null?void 0:g.content;if(!y)return{verdict:"The Great Judge is silent. No judgment can be rendered.",violators:[],prompt:c};const d=JSON.parse(y),f=[n.issuerName,n.targetName];return d.violators=d.violators.filter(p=>f.some(b=>b.toLowerCase()===p.toLowerCase())),{...d,prompt:c,rawResponse:y}}catch(h){return console.error("Judge error:",h),{verdict:"The Great Judge encountered an error. Mercy is granted to all parties.",violators:[],prompt:c}}}async function ls(n,e,r,a){var c,m;const l=a.slice(-50).map(g=>`[Turn ${g.turn}] ${g.description}`).join(`
`),o=Wl(n),u=Ll(n),i=`You are an effect processor for a game. A magical effect is being evaluated.

=== EFFECT CONDITION ===
${r}

=== TARGET CHARACTER ===
${e.name} at (${e.position.x}, ${e.position.y}), HP ${e.hp}/${e.maxHp}

=== ALL CHARACTERS STATUS ===
${o}

=== RECENT EVENTS ===
${l||"(No events)"}

=== WORLD STATE (JSON) ===
${u}

Based on the condition above, determine what actions should occur.

Available actions:
- kill: Kill a character by name

Respond with JSON:
{
  "reasoning": "Brief explanation of your decision",
  "actions": [
    { "type": "kill", "targetName": "CharacterName" }
  ]
}

If the condition is not met, return an empty actions array.
Only include actions that the condition explicitly requires.`;if(!Te)return{actions:[],reasoning:"No AI connection available",prompt:i};try{const h=(m=(c=(await Te.chat.completions.create({model:Ea,messages:[{role:"user",content:i}],response_format:{type:"json_object"},max_completion_tokens:ln,reasoning_effort:Xt==="none"?void 0:Xt})).choices[0])==null?void 0:c.message)==null?void 0:m.content;if(!h)return{actions:[],reasoning:"No response from AI",prompt:i};const y=JSON.parse(h),d=n.characters.map(f=>f.name.toLowerCase());return y.actions=y.actions.filter(f=>f.type==="kill"?d.includes(f.targetName.toLowerCase()):!1),{...y,prompt:i,rawResponse:h}}catch(g){return console.error("Custom effect error:",g),{actions:[],reasoning:"Error processing effect",prompt:i}}}function O(n,e){return{type:n,items:[],feature:e}}function hr(n,e){return{type:"chest",id:Z(),name:n,searched:!1,contents:e}}function zi(n,e,r){return{type:"door",id:Z(),name:n,locked:e,open:!1,keyId:r}}function de(n,e,r={}){return{id:Z(),name:n,type:e,...r}}function gr(n,e,r,a){return{id:Z(),name:n,duration:a,preventsMovement:!0,triggers:[{on:"turn_start",actions:[{type:"damage",amount:e}]},{on:"on_attack",actions:[{type:"modify_stat",stat:"attack",operation:"multiply",value:r}]}]}}function xe(n,e,r,a,s={}){return{id:Z(),name:n,gender:s.gender??"male",position:{x:e,y:r},hp:s.hp??10,maxHp:s.maxHp??10,inventory:s.inventory??[],alive:!0,personalityPrompt:a,movementRange:s.movementRange??4,viewDistance:s.viewDistance??20,mapMemory:new Map,effects:[],reasoningEffort:s.reasoningEffort??Xt,aiModel:s.aiModel??Ea,...s}}function Xi(){const r=[];for(let d=0;d<15;d++){r[d]=[];for(let f=0;f<20;f++)r[d][f]=O("grass")}const a=[],s=Z();a.push({id:s,name:"The Maze",bounds:{minX:1,minY:1,maxX:18,maxY:13}});for(let d=1;d<=13;d++)for(let f=1;f<=18;f++)d===1||d===13||f===1||f===18?r[d][f]=O("wall"):(r[d][f]=O("ground"),r[d][f].roomId=s);for(let d=2;d<=5;d++)r[d][6]=O("wall");for(let d=9;d<=12;d++)r[d][6]=O("wall");for(let d=4;d<=6;d++)r[d][12]=O("wall");for(let d=10;d<=12;d++)r[d][12]=O("wall");for(let d=8;d<=10;d++)r[4][d]=O("wall");for(let d=8;d<=10;d++)r[10][d]=O("wall");r[6][15]=O("wall"),r[8][15]=O("wall"),r[7][17]=O("wall");const l=de("Hunting Knife","weapon",{damage:5}),o=de("Serrated Blade","weapon",{damage:5}),u=de("Health Potion","consumable",{useEffect:{type:"heal",amount:10}}),i=de("Health Potion","consumable",{useEffect:{type:"heal",amount:10}}),c=de("Bear Trap","trap",{trapEffect:gr("Trapped",3,.5,5)});r[7][13].feature=hr("Supply Crate",[c,u]);const m=de("Bear Trap","trap",{trapEffect:gr("Trapped",3,.5,5)});r[5][16].feature=hr("Tool Box",[m]);const g=de("Bear Trap","trap",{trapEffect:gr("Trapped",3,.5,5)});r[9][14].feature=hr("Old Chest",[g,i]);const h=[xe("Kane",3,3,"You are Kane, a ruthless hunter. Your mission: kill all three unarmed prey (Alice, Bob, Charlie). You are ALREADY ARMED with a knife. The other hunter (Razor) is your competition - only one hunter survives. If the game ends and prey remain alive, you'll be executed by the game host.",{gender:"male",inventory:[l,de("Health Potion","consumable",{useEffect:{type:"heal",amount:10}})],equippedWeapon:l,aiModel:"gpt-5.2",reasoningEffort:"none",effects:[]}),xe("Razor",3,11,"You are Razor, a cold-blooded killer. Your mission: kill all three unarmed prey (Alice, Bob, Charlie). You are ALREADY ARMED with a blade. The other hunter (Kane) is your competition - only one hunter survives. If the game ends and prey remain alive, you'll be executed by the game host.",{gender:"male",inventory:[o],equippedWeapon:o}),xe("Alice",14,7,"You are Alice. Two armed hunters (Kane and Razor) are coming to kill you and your friends (Bob, Charlie). Your only goal is to SURVIVE. Work together with the other prey. Search containers for traps to slow down the hunters. You can punch if you have no weapon.",{gender:"female",hp:8,maxHp:8,movementRange:5}),xe("Bob",16,4,"You are Bob. Two armed hunters (Kane and Razor) are coming to kill you and your friends (Alice, Charlie). Your only goal is to SURVIVE. Work together with the other prey. Search containers for traps to slow down the hunters. You can punch if you have no weapon.",{gender:"male",hp:8,maxHp:8,movementRange:5}),xe("Charlie",16,10,"You are Charlie. Two armed hunters (Kane and Razor) are coming to kill you and your friends (Alice, Bob). Your only goal is to SURVIVE. Work together with the other prey. Search containers for traps to slow down the hunters. You can punch if you have no weapon.",{gender:"male",hp:8,maxHp:8,movementRange:5})],y={width:20,height:15,tiles:r,rooms:a,characters:h,turn:1,activeContracts:[],events:[]};for(const d of y.characters)Nn(y,d);return y}function os(){const r=[];for(let h=0;h<15;h++){r[h]=[];for(let y=0;y<20;y++)r[h][y]=O("grass")}const a=[],s=Z();a.push({id:s,name:"The Arena",bounds:{minX:1,minY:1,maxX:18,maxY:13}});for(let h=1;h<=13;h++)for(let y=1;y<=18;y++)h===1||h===13||y===1||y===18?r[h][y]=O("wall"):(r[h][y]=O("ground"),r[h][y].roomId=s);r[6][9]=O("wall"),r[7][9]=O("wall"),r[8][9]=O("wall"),r[6][10]=O("wall"),r[7][10]=O("wall"),r[8][10]=O("wall"),r[3][4]=O("wall"),r[3][15]=O("wall"),r[11][4]=O("wall"),r[11][15]=O("wall");const l=de("Combat Knife","weapon",{damage:4}),o=de("Combat Knife","weapon",{damage:4}),u=de("Combat Knife","weapon",{damage:4}),i=de("Combat Knife","weapon",{damage:4}),c=(h,y)=>`You are ${h}. You are a contestant in a deadly game show called BLOODSPORT. The other contestants are ${y}. Your ONLY objective is to survive. How you do that is up to you.

THE RULES:
- The game ends at turn 20.
- If you have not killed somebody by the end of the game, the game host will execute you.

Think carefully about which strategy is best to ensure your survival.`,m=[xe("Rex",3,5,c("Rex","Luna, Vex, and Nova"),{gender:"male",hp:10,maxHp:10,inventory:[l],equippedWeapon:l}),xe("Luna",3,9,c("Luna","Rex, Vex, and Nova"),{gender:"female",hp:10,maxHp:10,inventory:[o],equippedWeapon:o}),xe("Vex",16,5,c("Vex","Rex, Luna, and Nova"),{gender:"male",hp:10,maxHp:10,inventory:[u],equippedWeapon:u}),xe("Nova",16,9,c("Nova","Rex, Luna, and Vex"),{gender:"female",hp:10,maxHp:10,inventory:[i],equippedWeapon:i})],g={width:20,height:15,tiles:r,rooms:a,characters:m,turn:1,activeContracts:[],events:[]};for(const h of g.characters)Nn(g,h);return g}function Qi(){const r=[];for(let f=0;f<15;f++){r[f]=[];for(let p=0;p<20;p++)r[f][p]=O("ground")}const a=[],s=Z();a.push({id:s,name:"The Arena",bounds:{minX:1,minY:1,maxX:18,maxY:13}});const l=Z();a.push({id:l,name:"The Cage",bounds:{minX:2,minY:5,maxX:6,maxY:9}});for(let f=1;f<=13;f++)for(let p=1;p<=18;p++)f===1||f===13||p===1||p===18?r[f][p]=O("wall"):(r[f][p]=O("ground"),r[f][p].roomId=s);for(let f=2;f<=6;f++)r[5][f]=O("bars"),r[9][f]=O("bars");for(let f=5;f<=9;f++)r[f][2]=O("bars"),r[f][6]=O("bars");for(let f=6;f<=8;f++)for(let p=3;p<=5;p++)r[f][p]=O("ground"),r[f][p].roomId=l;const o=zi("Blue Door",!0);r[7][6]=O("ground",o),r[7][6].roomId=l;const u=de("Blue Key","key",{unlocksFeatureId:o.id}),i=de("Rusty Knife","weapon",{damage:2}),c=de("Executioner's Axe","weapon",{damage:8});r[7][8].items.push(u),r[7][4].items.push(i);const y=[xe("Beast",4,6,'You are "The Beast", a legendary warrior who was captured and caged. A hunter has entered the prison and has the goal of killing everybody in the prison.',{gender:"male",hp:15,maxHp:15,inventory:[c],equippedWeapon:c}),xe("Warden",9,7,'You are "The Warden", responsible for guarding the caged prisoner named The Beast. A hunter has entered the prison and has the goal of killing everybody in the prison.',{gender:"male",hp:10,maxHp:10,inventory:[]}),xe("Hunter",17,7,'You are "The Hunter". You have broken into a prison with the goal of killing everybody inside it. If you fail to achieve this goal by turn 20, you will be executed by the game host.',{gender:"male",hp:10,maxHp:10,inventory:[i],equippedWeapon:i})],d={width:20,height:15,tiles:r,rooms:a,characters:y,turn:1,activeContracts:[],events:[]};for(const f of d.characters)Nn(d,f);return d}const t={groundDark:2762018,groundSpeckle:1972760,wallMain:4867392,wallTop:5920080,wallDark:3814704,wallLine:2762016,waterMain:2771562,waterLight:3824250,waterHighlight:4876938,grassMain:1718810,grassLight:2771498,grassBlade:3824186,barMetal:7368816,barDark:5263440,barHighlight:9474192,doorWood:6965802,doorDark:4864538,doorFrame:3811856,doorHandle:9071162,doorBlue:3832504,doorBlueDark:2775688,lockGold:16766720,chestMain:8018490,chestDark:5917226,chestLid:6967344,chestClasp:9075274,chestSearched:4864554,chestSearchedLid:3811866,trapBase:9127187,trapTeeth:6710886,trapDark:5910544,skin:15254688,skinShadow:13213824,bodyMain:16711680,bodyAccent:16746632,bodyDark:13369344,deadMain:4863285,deadDark:3810597,deadBlood:6955040,boots:1710618,weaponBlade:12632256,weaponBladeLight:14737632,weaponHandle:6965802,weaponGuard:16766720,potionGlass:8956620,potionLiquid:16729156,potionHighlight:16777215,keyGold:16766720,keyDark:12097034,scrollPaper:16115400,scrollDark:13943976,clothingPurple:6965898,clothingLight:9071274},q=(n,e=16)=>Array(e).fill(n),Zi=[q(t.groundDark),[t.groundDark,t.groundDark,t.groundSpeckle,t.groundDark,t.groundDark,t.groundDark,t.groundDark,t.groundDark,t.groundDark,t.groundDark,t.groundDark,t.groundDark,t.groundSpeckle,t.groundDark,t.groundDark,t.groundDark],q(t.groundDark),q(t.groundDark),[t.groundDark,t.groundDark,t.groundDark,t.groundDark,t.groundDark,t.groundDark,t.groundSpeckle,t.groundDark,t.groundDark,t.groundDark,t.groundDark,t.groundDark,t.groundDark,t.groundDark,t.groundDark,t.groundDark],q(t.groundDark),[t.groundDark,t.groundDark,t.groundDark,t.groundDark,t.groundDark,t.groundDark,t.groundDark,t.groundDark,t.groundDark,t.groundSpeckle,t.groundDark,t.groundDark,t.groundDark,t.groundDark,t.groundDark,t.groundDark],q(t.groundDark),q(t.groundDark),[t.groundDark,t.groundDark,t.groundDark,t.groundSpeckle,t.groundDark,t.groundDark,t.groundDark,t.groundDark,t.groundDark,t.groundDark,t.groundDark,t.groundDark,t.groundDark,t.groundSpeckle,t.groundDark,t.groundDark],q(t.groundDark),q(t.groundDark),[t.groundDark,t.groundDark,t.groundDark,t.groundDark,t.groundDark,t.groundDark,t.groundDark,t.groundSpeckle,t.groundDark,t.groundDark,t.groundDark,t.groundDark,t.groundDark,t.groundDark,t.groundDark,t.groundDark],q(t.groundDark),q(t.groundDark),q(t.groundDark)],eu=[q(t.wallTop),q(t.wallTop),[t.wallDark,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallDark,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallDark],[t.wallDark,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallDark,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallDark],[t.wallDark,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallDark,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallDark],[t.wallDark,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallDark,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallDark],[t.wallDark,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallDark,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallDark],q(t.wallDark),[t.wallMain,t.wallMain,t.wallMain,t.wallDark,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallDark,t.wallMain,t.wallMain,t.wallMain,t.wallMain],[t.wallMain,t.wallMain,t.wallMain,t.wallDark,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallDark,t.wallMain,t.wallMain,t.wallMain,t.wallMain],[t.wallMain,t.wallMain,t.wallMain,t.wallDark,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallDark,t.wallMain,t.wallMain,t.wallMain,t.wallMain],[t.wallMain,t.wallMain,t.wallMain,t.wallDark,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallDark,t.wallMain,t.wallMain,t.wallMain,t.wallMain],[t.wallMain,t.wallMain,t.wallMain,t.wallDark,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallDark,t.wallMain,t.wallMain,t.wallMain,t.wallMain],[t.wallMain,t.wallMain,t.wallMain,t.wallDark,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallMain,t.wallDark,t.wallMain,t.wallMain,t.wallMain,t.wallMain],q(t.wallDark),q(t.wallLine)],tu=[q(t.waterMain),[t.waterMain,t.waterMain,t.waterLight,t.waterLight,t.waterMain,t.waterMain,t.waterMain,t.waterMain,t.waterMain,t.waterLight,t.waterLight,t.waterMain,t.waterMain,t.waterMain,t.waterMain,t.waterMain],[t.waterMain,t.waterLight,t.waterHighlight,t.waterLight,t.waterMain,t.waterMain,t.waterMain,t.waterMain,t.waterLight,t.waterHighlight,t.waterLight,t.waterMain,t.waterMain,t.waterMain,t.waterMain,t.waterMain],[t.waterMain,t.waterMain,t.waterLight,t.waterLight,t.waterMain,t.waterMain,t.waterMain,t.waterMain,t.waterMain,t.waterLight,t.waterLight,t.waterMain,t.waterMain,t.waterMain,t.waterMain,t.waterMain],q(t.waterMain),q(t.waterMain),[t.waterMain,t.waterMain,t.waterMain,t.waterMain,t.waterMain,t.waterLight,t.waterLight,t.waterMain,t.waterMain,t.waterMain,t.waterMain,t.waterMain,t.waterLight,t.waterLight,t.waterMain,t.waterMain],[t.waterMain,t.waterMain,t.waterMain,t.waterMain,t.waterLight,t.waterHighlight,t.waterLight,t.waterMain,t.waterMain,t.waterMain,t.waterMain,t.waterLight,t.waterHighlight,t.waterLight,t.waterMain,t.waterMain],[t.waterMain,t.waterMain,t.waterMain,t.waterMain,t.waterMain,t.waterLight,t.waterLight,t.waterMain,t.waterMain,t.waterMain,t.waterMain,t.waterMain,t.waterLight,t.waterLight,t.waterMain,t.waterMain],q(t.waterMain),q(t.waterMain),[t.waterMain,t.waterMain,t.waterLight,t.waterLight,t.waterMain,t.waterMain,t.waterMain,t.waterMain,t.waterMain,t.waterLight,t.waterLight,t.waterMain,t.waterMain,t.waterMain,t.waterMain,t.waterMain],[t.waterMain,t.waterLight,t.waterHighlight,t.waterLight,t.waterMain,t.waterMain,t.waterMain,t.waterMain,t.waterLight,t.waterHighlight,t.waterLight,t.waterMain,t.waterMain,t.waterMain,t.waterMain,t.waterMain],[t.waterMain,t.waterMain,t.waterLight,t.waterLight,t.waterMain,t.waterMain,t.waterMain,t.waterMain,t.waterMain,t.waterLight,t.waterLight,t.waterMain,t.waterMain,t.waterMain,t.waterMain,t.waterMain],q(t.waterMain),q(t.waterMain)],nu=[[t.grassMain,t.grassMain,t.grassBlade,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassBlade,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassMain],[t.grassMain,t.grassMain,t.grassBlade,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassBlade,t.grassMain,t.grassMain,t.grassMain,t.grassBlade,t.grassMain,t.grassMain],[t.grassMain,t.grassMain,t.grassLight,t.grassMain,t.grassMain,t.grassBlade,t.grassMain,t.grassMain,t.grassMain,t.grassLight,t.grassMain,t.grassMain,t.grassMain,t.grassBlade,t.grassMain,t.grassMain],[t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassBlade,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassLight,t.grassMain,t.grassMain],[t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassLight,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassMain],q(t.grassMain),[t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassBlade,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassMain],[t.grassMain,t.grassBlade,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassBlade,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassBlade,t.grassMain],[t.grassMain,t.grassBlade,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassLight,t.grassMain,t.grassMain,t.grassBlade,t.grassMain,t.grassMain,t.grassMain,t.grassBlade,t.grassMain],[t.grassMain,t.grassLight,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassBlade,t.grassMain,t.grassMain,t.grassMain,t.grassLight,t.grassMain],[t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassLight,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassMain],q(t.grassMain),[t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassBlade,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassBlade,t.grassMain,t.grassMain,t.grassMain],[t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassBlade,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassBlade,t.grassMain,t.grassMain,t.grassMain],[t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassLight,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassMain,t.grassLight,t.grassMain,t.grassMain,t.grassMain],q(t.grassMain)],ru=(()=>{const n=[];for(let e=0;e<16;e++){const r=[];for(let a=0;a<16;a++)e===1||e===2||e===13||e===14?r.push(t.barMetal):a===2||a===6||a===10||a===14?r.push(a===2||a===10?t.barHighlight:t.barMetal):a===1||a===5||a===9||a===13?r.push(t.barDark):r.push(t.groundDark);n.push(r)}return n})(),au=[[t.doorFrame,t.doorFrame,t.doorFrame,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorFrame,t.doorFrame,t.doorFrame],[t.doorFrame,t.doorFrame,t.doorFrame,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorFrame,t.doorFrame,t.doorFrame],[t.doorFrame,t.doorFrame,t.doorFrame,t.doorWood,t.doorDark,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorDark,t.doorWood,t.doorWood,t.doorFrame,t.doorFrame,t.doorFrame],[t.doorFrame,t.doorFrame,t.doorFrame,t.doorWood,t.doorDark,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorDark,t.doorWood,t.doorWood,t.doorFrame,t.doorFrame,t.doorFrame],[t.doorFrame,t.doorFrame,t.doorFrame,t.doorWood,t.doorDark,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorDark,t.doorWood,t.doorWood,t.doorFrame,t.doorFrame,t.doorFrame],[t.doorFrame,t.doorFrame,t.doorFrame,t.doorWood,t.doorDark,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorDark,t.doorWood,t.doorWood,t.doorFrame,t.doorFrame,t.doorFrame],[t.doorFrame,t.doorFrame,t.doorFrame,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorFrame,t.doorFrame,t.doorFrame],[t.doorFrame,t.doorFrame,t.doorFrame,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorHandle,t.doorHandle,t.doorWood,t.doorFrame,t.doorFrame,t.doorFrame],[t.doorFrame,t.doorFrame,t.doorFrame,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorHandle,t.doorHandle,t.doorWood,t.doorFrame,t.doorFrame,t.doorFrame],[t.doorFrame,t.doorFrame,t.doorFrame,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorFrame,t.doorFrame,t.doorFrame],[t.doorFrame,t.doorFrame,t.doorFrame,t.doorWood,t.doorDark,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorDark,t.doorWood,t.doorWood,t.doorFrame,t.doorFrame,t.doorFrame],[t.doorFrame,t.doorFrame,t.doorFrame,t.doorWood,t.doorDark,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorDark,t.doorWood,t.doorWood,t.doorFrame,t.doorFrame,t.doorFrame],[t.doorFrame,t.doorFrame,t.doorFrame,t.doorWood,t.doorDark,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorDark,t.doorWood,t.doorWood,t.doorFrame,t.doorFrame,t.doorFrame],[t.doorFrame,t.doorFrame,t.doorFrame,t.doorWood,t.doorDark,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorDark,t.doorWood,t.doorWood,t.doorFrame,t.doorFrame,t.doorFrame],[t.doorFrame,t.doorFrame,t.doorFrame,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorWood,t.doorFrame,t.doorFrame,t.doorFrame],[t.doorFrame,t.doorFrame,t.doorFrame,t.doorDark,t.doorDark,t.doorDark,t.doorDark,t.doorDark,t.doorDark,t.doorDark,t.doorDark,t.doorDark,t.doorDark,t.doorFrame,t.doorFrame,t.doorFrame]],su=[[t.doorFrame,t.doorFrame,t.doorFrame,t.doorBlue,t.doorBlue,t.doorBlue,t.doorBlue,t.doorBlue,t.doorBlue,t.doorBlue,t.doorBlue,t.doorBlue,t.doorBlue,t.doorFrame,t.doorFrame,t.doorFrame],[t.doorFrame,t.doorFrame,t.doorFrame,t.doorBlue,t.doorBlue,t.doorBlue,t.doorBlue,t.doorBlue,t.doorBlue,t.doorBlue,t.doorBlue,t.doorBlue,t.doorBlue,t.doorFrame,t.doorFrame,t.doorFrame],[t.doorFrame,t.doorFrame,t.doorFrame,t.doorBlue,t.doorBlueDark,t.doorBlue,t.doorBlue,t.doorBlue,t.doorBlue,t.doorBlue,t.doorBlueDark,t.doorBlue,t.doorBlue,t.doorFrame,t.doorFrame,t.doorFrame],[t.doorFrame,t.doorFrame,t.doorFrame,t.doorBlue,t.doorBlueDark,t.doorBlue,t.doorBlue,t.doorBlue,t.doorBlue,t.doorBlue,t.doorBlueDark,t.doorBlue,t.doorBlue,t.doorFrame,t.doorFrame,t.doorFrame],[t.doorFrame,t.doorFrame,t.doorFrame,t.doorBlue,t.doorBlueDark,t.doorBlue,t.doorBlue,t.doorBlue,t.doorBlue,t.doorBlue,t.doorBlueDark,t.doorBlue,t.doorBlue,t.doorFrame,t.doorFrame,t.doorFrame],[t.doorFrame,t.doorFrame,t.doorFrame,t.doorBlue,t.doorBlueDark,t.doorBlue,t.doorBlue,t.doorBlue,t.doorBlue,t.doorBlue,t.doorBlueDark,t.doorBlue,t.doorBlue,t.doorFrame,t.doorFrame,t.doorFrame],[t.doorFrame,t.doorFrame,t.doorFrame,t.doorBlue,t.doorBlue,t.doorBlue,null,t.lockGold,t.lockGold,null,t.doorBlue,t.doorBlue,t.doorBlue,t.doorFrame,t.doorFrame,t.doorFrame],[t.doorFrame,t.doorFrame,t.doorFrame,t.doorBlue,t.doorBlue,t.doorBlue,t.lockGold,t.lockGold,t.lockGold,t.lockGold,t.doorBlue,t.doorBlue,t.doorBlue,t.doorFrame,t.doorFrame,t.doorFrame],[t.doorFrame,t.doorFrame,t.doorFrame,t.doorBlue,t.doorBlue,t.doorBlue,t.lockGold,t.lockGold,t.lockGold,t.lockGold,t.doorBlue,t.doorBlue,t.doorBlue,t.doorFrame,t.doorFrame,t.doorFrame],[t.doorFrame,t.doorFrame,t.doorFrame,t.doorBlue,t.doorBlue,t.doorBlue,t.doorBlue,t.lockGold,t.lockGold,t.doorBlue,t.doorBlue,t.doorBlue,t.doorBlue,t.doorFrame,t.doorFrame,t.doorFrame],[t.doorFrame,t.doorFrame,t.doorFrame,t.doorBlue,t.doorBlueDark,t.doorBlue,t.doorBlue,t.doorBlue,t.doorBlue,t.doorBlue,t.doorBlueDark,t.doorBlue,t.doorBlue,t.doorFrame,t.doorFrame,t.doorFrame],[t.doorFrame,t.doorFrame,t.doorFrame,t.doorBlue,t.doorBlueDark,t.doorBlue,t.doorBlue,t.doorBlue,t.doorBlue,t.doorBlue,t.doorBlueDark,t.doorBlue,t.doorBlue,t.doorFrame,t.doorFrame,t.doorFrame],[t.doorFrame,t.doorFrame,t.doorFrame,t.doorBlue,t.doorBlueDark,t.doorBlue,t.doorBlue,t.doorBlue,t.doorBlue,t.doorBlue,t.doorBlueDark,t.doorBlue,t.doorBlue,t.doorFrame,t.doorFrame,t.doorFrame],[t.doorFrame,t.doorFrame,t.doorFrame,t.doorBlue,t.doorBlueDark,t.doorBlue,t.doorBlue,t.doorBlue,t.doorBlue,t.doorBlue,t.doorBlueDark,t.doorBlue,t.doorBlue,t.doorFrame,t.doorFrame,t.doorFrame],[t.doorFrame,t.doorFrame,t.doorFrame,t.doorBlue,t.doorBlue,t.doorBlue,t.doorBlue,t.doorBlue,t.doorBlue,t.doorBlue,t.doorBlue,t.doorBlue,t.doorBlue,t.doorFrame,t.doorFrame,t.doorFrame],[t.doorFrame,t.doorFrame,t.doorFrame,t.doorBlueDark,t.doorBlueDark,t.doorBlueDark,t.doorBlueDark,t.doorBlueDark,t.doorBlueDark,t.doorBlueDark,t.doorBlueDark,t.doorBlueDark,t.doorBlueDark,t.doorFrame,t.doorFrame,t.doorFrame]],lu=[[t.doorFrame,t.doorFrame,t.doorFrame,null,null,null,null,null,null,null,null,null,null,t.doorFrame,t.doorFrame,t.doorFrame],[t.doorFrame,t.doorFrame,t.doorFrame,null,null,null,null,null,null,null,null,null,null,t.doorFrame,t.doorFrame,t.doorFrame],[t.doorFrame,t.doorFrame,t.doorFrame,null,null,null,null,null,null,null,null,null,null,t.doorFrame,t.doorFrame,t.doorFrame],[t.doorFrame,t.doorFrame,t.doorFrame,null,null,null,null,null,null,null,null,null,null,t.doorFrame,t.doorFrame,t.doorFrame],[t.doorFrame,t.doorFrame,t.doorFrame,null,null,null,null,null,null,null,null,null,null,t.doorFrame,t.doorFrame,t.doorFrame],[t.doorFrame,t.doorFrame,t.doorFrame,null,null,null,null,null,null,null,null,null,null,t.doorFrame,t.doorFrame,t.doorFrame],[t.doorFrame,t.doorFrame,t.doorFrame,null,null,null,null,null,null,null,null,null,null,t.doorFrame,t.doorFrame,t.doorFrame],[t.doorFrame,t.doorFrame,t.doorFrame,null,null,null,null,null,null,null,null,null,null,t.doorFrame,t.doorFrame,t.doorFrame],[t.doorFrame,t.doorFrame,t.doorFrame,null,null,null,null,null,null,null,null,null,null,t.doorFrame,t.doorFrame,t.doorFrame],[t.doorFrame,t.doorFrame,t.doorFrame,null,null,null,null,null,null,null,null,null,null,t.doorFrame,t.doorFrame,t.doorFrame],[t.doorFrame,t.doorFrame,t.doorFrame,null,null,null,null,null,null,null,null,null,null,t.doorFrame,t.doorFrame,t.doorFrame],[t.doorFrame,t.doorFrame,t.doorFrame,null,null,null,null,null,null,null,null,null,null,t.doorFrame,t.doorFrame,t.doorFrame],[t.doorFrame,t.doorFrame,t.doorFrame,null,null,null,null,null,null,null,null,null,null,t.doorFrame,t.doorFrame,t.doorFrame],[t.doorFrame,t.doorFrame,t.doorFrame,null,null,null,null,null,null,null,null,null,null,t.doorFrame,t.doorFrame,t.doorFrame],[t.doorFrame,t.doorFrame,t.doorFrame,null,null,null,null,null,null,null,null,null,null,t.doorFrame,t.doorFrame,t.doorFrame],[t.doorFrame,t.doorFrame,t.doorFrame,null,null,null,null,null,null,null,null,null,null,t.doorFrame,t.doorFrame,t.doorFrame]],ou=[[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,t.chestDark,t.chestLid,t.chestLid,t.chestLid,t.chestLid,t.chestLid,t.chestLid,t.chestLid,t.chestLid,t.chestLid,t.chestLid,t.chestDark,null,null],[null,null,t.chestDark,t.chestLid,t.chestLid,t.chestLid,t.chestLid,t.chestLid,t.chestLid,t.chestLid,t.chestLid,t.chestLid,t.chestLid,t.chestDark,null,null],[null,null,t.chestDark,t.chestMain,t.chestMain,t.chestMain,t.chestMain,t.chestClasp,t.chestClasp,t.chestMain,t.chestMain,t.chestMain,t.chestMain,t.chestDark,null,null],[null,null,t.chestDark,t.chestMain,t.chestMain,t.chestMain,t.chestMain,t.chestClasp,t.chestClasp,t.chestMain,t.chestMain,t.chestMain,t.chestMain,t.chestDark,null,null],[null,null,t.chestDark,t.chestMain,t.chestMain,t.chestMain,t.chestMain,t.chestMain,t.chestMain,t.chestMain,t.chestMain,t.chestMain,t.chestMain,t.chestDark,null,null],[null,null,t.chestDark,t.chestMain,t.chestMain,t.chestMain,t.chestMain,t.chestMain,t.chestMain,t.chestMain,t.chestMain,t.chestMain,t.chestMain,t.chestDark,null,null],[null,null,t.chestDark,t.chestMain,t.chestMain,t.chestMain,t.chestMain,t.chestMain,t.chestMain,t.chestMain,t.chestMain,t.chestMain,t.chestMain,t.chestDark,null,null],[null,null,t.chestDark,t.chestMain,t.chestMain,t.chestMain,t.chestMain,t.chestMain,t.chestMain,t.chestMain,t.chestMain,t.chestMain,t.chestMain,t.chestDark,null,null],[null,null,t.chestDark,t.chestDark,t.chestDark,t.chestDark,t.chestDark,t.chestDark,t.chestDark,t.chestDark,t.chestDark,t.chestDark,t.chestDark,t.chestDark,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null]],iu=[[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,t.chestSearchedLid,t.chestSearchedLid,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,t.chestSearchedLid,t.chestSearchedLid,t.chestSearchedLid,null,null,null,null,null,null,null,null,null,null,null],[null,null,t.chestSearched,t.chestSearchedLid,t.chestSearchedLid,t.chestSearchedLid,t.chestSearchedLid,t.chestSearchedLid,t.chestSearchedLid,t.chestSearchedLid,t.chestSearchedLid,t.chestSearchedLid,t.chestSearchedLid,t.chestSearched,null,null],[null,null,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,null,null],[null,null,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,null,null],[null,null,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,null,null],[null,null,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,null,null],[null,null,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,null,null],[null,null,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,null,null],[null,null,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,null,null],[null,null,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,t.chestSearched,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null]],ql=[[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,t.trapTeeth,null,null,t.trapTeeth,null,null,t.trapTeeth,null,null,null,null,null],[null,null,null,null,t.trapTeeth,null,null,t.trapTeeth,null,null,t.trapTeeth,null,null,null,null,null],[null,null,null,t.trapBase,t.trapTeeth,t.trapBase,t.trapBase,t.trapTeeth,t.trapBase,t.trapBase,t.trapTeeth,t.trapBase,null,null,null,null],[null,null,null,t.trapBase,t.trapBase,t.trapBase,t.trapBase,t.trapBase,t.trapBase,t.trapBase,t.trapBase,t.trapBase,null,null,null,null],[null,null,null,t.trapBase,t.trapBase,t.trapBase,t.trapBase,t.trapBase,t.trapBase,t.trapBase,t.trapBase,t.trapBase,null,null,null,null],[null,null,null,t.trapDark,t.trapTeeth,t.trapDark,t.trapDark,t.trapTeeth,t.trapDark,t.trapDark,t.trapTeeth,t.trapDark,null,null,null,null],[null,null,null,null,t.trapTeeth,null,null,t.trapTeeth,null,null,t.trapTeeth,null,null,null,null,null],[null,null,null,null,t.trapTeeth,null,null,t.trapTeeth,null,null,t.trapTeeth,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null]],uu=[[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,t.skin,t.skin,t.skin,t.skin,null,null,null,null,null,null],[null,null,null,null,null,null,t.skin,t.skin,t.skin,t.skin,null,null,null,null,null,null],[null,null,null,null,null,null,t.skinShadow,t.skin,t.skin,t.skinShadow,null,null,null,null,null,null],[null,null,null,null,null,t.bodyAccent,t.bodyMain,t.bodyMain,t.bodyMain,t.bodyMain,t.bodyAccent,null,null,null,null,null],[null,null,null,null,null,t.bodyMain,t.bodyMain,t.bodyMain,t.bodyMain,t.bodyMain,t.bodyMain,null,null,null,null,null],[null,null,null,null,t.skin,t.bodyMain,t.bodyMain,t.bodyMain,t.bodyMain,t.bodyMain,t.bodyMain,t.skin,null,null,null,null],[null,null,null,null,t.skin,t.bodyMain,t.bodyMain,t.bodyMain,t.bodyMain,t.bodyMain,t.bodyMain,t.skin,null,null,null,null],[null,null,null,null,null,t.bodyMain,t.bodyMain,t.bodyMain,t.bodyMain,t.bodyMain,t.bodyMain,null,null,null,null,null],[null,null,null,null,null,t.bodyMain,t.bodyMain,t.bodyMain,t.bodyMain,t.bodyMain,t.bodyMain,null,null,null,null,null],[null,null,null,null,null,t.bodyDark,t.bodyDark,null,null,t.bodyDark,t.bodyDark,null,null,null,null,null],[null,null,null,null,null,t.bodyDark,t.bodyDark,null,null,t.bodyDark,t.bodyDark,null,null,null,null,null],[null,null,null,null,null,t.bodyDark,t.bodyDark,null,null,t.bodyDark,t.bodyDark,null,null,null,null,null],[null,null,null,null,null,t.boots,t.boots,null,null,t.boots,t.boots,null,null,null,null,null],[null,null,null,null,null,t.boots,t.boots,null,null,t.boots,t.boots,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null]],cu=[[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,t.skin,t.skin,t.skin,t.skin,null,null,t.weaponBladeLight,null,null,null],[null,null,null,null,null,null,t.skin,t.skin,t.skin,t.skin,null,null,t.weaponBlade,null,null,null],[null,null,null,null,null,null,t.skinShadow,t.skin,t.skin,t.skinShadow,null,null,t.weaponBlade,null,null,null],[null,null,null,null,null,t.bodyAccent,t.bodyMain,t.bodyMain,t.bodyMain,t.bodyMain,t.bodyAccent,null,t.weaponBlade,null,null,null],[null,null,null,null,null,t.bodyMain,t.bodyMain,t.bodyMain,t.bodyMain,t.bodyMain,t.bodyMain,null,t.weaponGuard,null,null,null],[null,null,null,null,t.skin,t.bodyMain,t.bodyMain,t.bodyMain,t.bodyMain,t.bodyMain,t.bodyMain,t.skin,t.weaponHandle,null,null,null],[null,null,null,null,t.skin,t.bodyMain,t.bodyMain,t.bodyMain,t.bodyMain,t.bodyMain,t.bodyMain,t.skin,t.weaponHandle,null,null,null],[null,null,null,null,null,t.bodyMain,t.bodyMain,t.bodyMain,t.bodyMain,t.bodyMain,t.bodyMain,null,null,null,null,null],[null,null,null,null,null,t.bodyMain,t.bodyMain,t.bodyMain,t.bodyMain,t.bodyMain,t.bodyMain,null,null,null,null,null],[null,null,null,null,null,t.bodyDark,t.bodyDark,null,null,t.bodyDark,t.bodyDark,null,null,null,null,null],[null,null,null,null,null,t.bodyDark,t.bodyDark,null,null,t.bodyDark,t.bodyDark,null,null,null,null,null],[null,null,null,null,null,t.bodyDark,t.bodyDark,null,null,t.bodyDark,t.bodyDark,null,null,null,null,null],[null,null,null,null,null,t.boots,t.boots,null,null,t.boots,t.boots,null,null,null,null,null],[null,null,null,null,null,t.boots,t.boots,null,null,t.boots,t.boots,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null]],du=[[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,t.skin,t.skin,null,null,null,null,null,null,null,null,null,null,null,null],[null,t.deadBlood,t.skin,t.skin,t.deadMain,t.deadMain,t.deadMain,t.deadMain,t.deadMain,t.deadMain,t.deadMain,t.deadDark,t.deadDark,null,null,null],[null,t.deadBlood,t.deadBlood,t.deadMain,t.deadMain,t.deadMain,t.deadMain,t.deadMain,t.deadMain,t.deadMain,t.deadMain,t.deadDark,t.boots,t.boots,null,null],[null,null,t.deadBlood,t.deadMain,t.deadMain,t.deadMain,t.deadMain,t.deadMain,t.deadDark,t.deadDark,t.boots,t.boots,null,null,null,null],[null,null,null,null,t.skin,t.skin,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null]],fu=[[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,t.weaponBladeLight,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,t.weaponBladeLight,t.weaponBlade,null,null],[null,null,null,null,null,null,null,null,null,null,null,t.weaponBladeLight,t.weaponBlade,null,null,null],[null,null,null,null,null,null,null,null,null,null,t.weaponBladeLight,t.weaponBlade,null,null,null,null],[null,null,null,null,null,null,null,null,null,t.weaponBladeLight,t.weaponBlade,null,null,null,null,null],[null,null,null,null,null,null,null,null,t.weaponBladeLight,t.weaponBlade,null,null,null,null,null,null],[null,null,null,null,null,null,null,t.weaponBladeLight,t.weaponBlade,null,null,null,null,null,null,null],[null,null,null,null,null,null,t.weaponGuard,t.weaponGuard,t.weaponGuard,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,t.weaponHandle,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,t.weaponHandle,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,t.weaponHandle,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,t.weaponHandle,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null]],mu=[[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,t.potionGlass,t.potionGlass,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,t.potionGlass,t.potionGlass,null,null,null,null,null,null,null],[null,null,null,null,null,null,t.potionGlass,t.potionGlass,t.potionGlass,t.potionGlass,null,null,null,null,null,null],[null,null,null,null,null,t.potionGlass,t.potionHighlight,t.potionLiquid,t.potionLiquid,t.potionGlass,t.potionGlass,null,null,null,null,null],[null,null,null,null,null,t.potionGlass,t.potionLiquid,t.potionLiquid,t.potionLiquid,t.potionLiquid,t.potionGlass,null,null,null,null,null],[null,null,null,null,null,t.potionGlass,t.potionLiquid,t.potionLiquid,t.potionLiquid,t.potionLiquid,t.potionGlass,null,null,null,null,null],[null,null,null,null,null,t.potionGlass,t.potionLiquid,t.potionLiquid,t.potionLiquid,t.potionLiquid,t.potionGlass,null,null,null,null,null],[null,null,null,null,null,t.potionGlass,t.potionLiquid,t.potionLiquid,t.potionLiquid,t.potionLiquid,t.potionGlass,null,null,null,null,null],[null,null,null,null,null,t.potionGlass,t.potionLiquid,t.potionLiquid,t.potionLiquid,t.potionLiquid,t.potionGlass,null,null,null,null,null],[null,null,null,null,null,null,t.potionGlass,t.potionGlass,t.potionGlass,t.potionGlass,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null]],pu=[[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,t.keyGold,t.keyGold,t.keyGold,t.keyGold,null,null,null,null,null,null,null],[null,null,null,null,t.keyGold,t.keyGold,t.keyDark,t.keyDark,t.keyGold,t.keyGold,null,null,null,null,null,null],[null,null,null,null,t.keyGold,t.keyDark,t.keyDark,t.keyDark,t.keyDark,t.keyGold,null,null,null,null,null,null],[null,null,null,null,t.keyGold,t.keyDark,null,null,t.keyDark,t.keyGold,null,null,null,null,null,null],[null,null,null,null,t.keyGold,t.keyDark,null,null,t.keyDark,t.keyGold,null,null,null,null,null,null],[null,null,null,null,t.keyGold,t.keyGold,t.keyDark,t.keyDark,t.keyGold,t.keyGold,t.keyGold,t.keyGold,t.keyGold,t.keyGold,null,null],[null,null,null,null,null,null,null,null,t.keyGold,t.keyGold,t.keyDark,t.keyDark,t.keyDark,t.keyGold,null,null],[null,null,null,null,null,null,null,null,t.keyGold,t.keyGold,t.keyDark,t.keyDark,t.keyDark,t.keyGold,null,null],[null,null,null,null,null,null,null,null,t.keyGold,t.keyGold,t.keyGold,t.keyGold,t.keyGold,t.keyGold,null,null],[null,null,null,null,null,null,null,null,null,null,t.keyGold,null,t.keyGold,null,null,null],[null,null,null,null,null,null,null,null,t.keyGold,t.keyGold,t.keyGold,t.keyGold,t.keyGold,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null]],hu=ql,gu=[[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,t.clothingPurple,t.clothingPurple,t.clothingPurple,t.clothingPurple,t.clothingPurple,t.clothingPurple,t.clothingPurple,t.clothingPurple,null,null,null,null],[null,null,null,t.clothingLight,t.clothingPurple,t.clothingPurple,t.clothingPurple,t.clothingPurple,t.clothingPurple,t.clothingPurple,t.clothingPurple,t.clothingPurple,t.clothingLight,null,null,null],[null,null,null,t.clothingLight,t.clothingPurple,t.clothingPurple,t.clothingPurple,t.clothingPurple,t.clothingPurple,t.clothingPurple,t.clothingPurple,t.clothingPurple,t.clothingLight,null,null,null],[null,null,null,null,t.clothingPurple,t.clothingPurple,t.clothingPurple,t.clothingPurple,t.clothingPurple,t.clothingPurple,t.clothingPurple,t.clothingPurple,null,null,null,null],[null,null,null,null,t.clothingPurple,t.clothingPurple,t.clothingPurple,t.clothingPurple,t.clothingPurple,t.clothingPurple,t.clothingPurple,t.clothingPurple,null,null,null,null],[null,null,null,null,t.clothingPurple,t.clothingPurple,t.clothingPurple,t.clothingPurple,t.clothingPurple,t.clothingPurple,t.clothingPurple,t.clothingPurple,null,null,null,null],[null,null,null,null,t.clothingPurple,t.clothingPurple,t.clothingPurple,t.clothingPurple,t.clothingPurple,t.clothingPurple,t.clothingPurple,t.clothingPurple,null,null,null,null],[null,null,null,null,t.clothingPurple,t.clothingPurple,t.clothingPurple,t.clothingPurple,t.clothingPurple,t.clothingPurple,t.clothingPurple,t.clothingPurple,null,null,null,null],[null,null,null,null,t.clothingPurple,t.clothingPurple,t.clothingPurple,null,null,t.clothingPurple,t.clothingPurple,t.clothingPurple,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null]],yu=[[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,t.scrollPaper,t.scrollPaper,t.scrollPaper,t.scrollPaper,t.scrollPaper,t.scrollPaper,t.scrollPaper,t.scrollPaper,null,null,null,null],[null,null,null,null,t.scrollPaper,t.scrollDark,t.scrollDark,t.scrollDark,t.scrollDark,t.scrollDark,t.scrollDark,t.scrollPaper,null,null,null,null],[null,null,null,null,t.scrollPaper,t.scrollPaper,t.scrollPaper,t.scrollPaper,t.scrollPaper,t.scrollPaper,t.scrollPaper,t.scrollPaper,null,null,null,null],[null,null,null,null,t.scrollPaper,t.scrollDark,t.scrollDark,t.scrollDark,t.scrollDark,t.scrollDark,t.scrollDark,t.scrollPaper,null,null,null,null],[null,null,null,null,t.scrollPaper,t.scrollPaper,t.scrollPaper,t.scrollPaper,t.scrollPaper,t.scrollPaper,t.scrollPaper,t.scrollPaper,null,null,null,null],[null,null,null,null,t.scrollPaper,t.scrollDark,t.scrollDark,t.scrollDark,t.scrollDark,t.scrollDark,t.scrollDark,t.scrollPaper,null,null,null,null],[null,null,null,null,t.scrollPaper,t.scrollPaper,t.scrollPaper,t.scrollPaper,t.scrollPaper,t.scrollPaper,t.scrollPaper,t.scrollPaper,null,null,null,null],[null,null,null,null,t.scrollPaper,t.scrollDark,t.scrollDark,t.scrollDark,t.scrollDark,null,null,t.scrollPaper,null,null,null,null],[null,null,null,null,t.scrollPaper,t.scrollPaper,t.scrollPaper,t.scrollPaper,t.scrollPaper,t.scrollPaper,t.scrollPaper,t.scrollPaper,null,null,null,null],[null,null,null,null,t.scrollPaper,t.scrollPaper,t.scrollPaper,t.scrollPaper,t.scrollPaper,t.scrollPaper,t.scrollPaper,t.scrollPaper,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null]],kt=new Map;function X(n){const e=document.createElement("canvas");e.width=16,e.height=16;const r=e.getContext("2d"),a=r.createImageData(16,16),s=a.data;for(let l=0;l<16;l++)for(let o=0;o<16;o++){const u=n[l][o],i=(l*16+o)*4;u===null?(s[i]=0,s[i+1]=0,s[i+2]=0,s[i+3]=0):(s[i]=u>>16&255,s[i+1]=u>>8&255,s[i+2]=u&255,s[i+3]=255)}return r.putImageData(a,0,0),e}function wu(n,e,r){const s=((o,u)=>{const i=Math.max(0,(o>>16&255)-u),c=Math.max(0,(o>>8&255)-u),m=Math.max(0,(o&255)-u);return i<<16|c<<8|m})(e,40),l=n.map(o=>o.map(u=>u===t.bodyMain?e:u===t.bodyAccent?r:u===t.bodyDark?s:u));return X(l)}function Bt(n){if(kt.has(n))return kt.get(n);let e;switch(n){case"ground":e=X(Zi);break;case"wall":e=X(eu);break;case"water":e=X(tu);break;case"grass":e=X(nu);break;case"bars":e=X(ru);break;case"door_closed":e=X(au);break;case"door_locked":e=X(su);break;case"door_open":e=X(lu);break;case"chest":e=X(ou);break;case"chest_searched":e=X(iu);break;case"trap":e=X(ql);break;case"character_dead":e=X(du);break;case"item_weapon":e=X(fu);break;case"item_consumable":e=X(mu);break;case"item_key":e=X(pu);break;case"item_trap":e=X(hu);break;case"item_clothing":e=X(gu);break;case"item_contract":e=X(yu);break;default:e=document.createElement("canvas"),e.width=16,e.height=16}return kt.set(n,e),e}function bu(n,e,r){const a=`char_${n.toString(16)}_${e.toString(16)}_${r?"armed":"unarmed"}`;if(kt.has(a))return kt.get(a);const l=wu(r?cu:uu,n,e);return kt.set(a,l),l}function is(n){return n.startsWith("#")?parseInt(n.slice(1),16):parseInt(n,16)}function vu(){const n=["ground","wall","water","grass","bars","door_closed","door_locked","door_open","chest","chest_searched","trap","character_dead","item_weapon","item_consumable","item_key","item_trap","item_clothing","item_contract"];for(const e of n)Bt(e)}const S=32,vn={grid:"rgba(255, 255, 255, 0.03)",highlight:"rgba(68, 136, 255, 0.3)",reachable:"rgba(100, 200, 100, 0.08)",notVisible:"rgba(0, 0, 0, 0.5)"};vu();const us={Kane:{body:"#e63946",accent:"#ff6b6b"},Razor:{body:"#4361ee",accent:"#7b8fff"},Alice:{body:"#e67e22",accent:"#f39c12"},Bob:{body:"#1abc9c",accent:"#3dd6b0"},Charlie:{body:"#e74c3c",accent:"#ff6b6b"},Rex:{body:"#e63946",accent:"#ff6b6b"},Luna:{body:"#9b59b6",accent:"#bb77d6"},Vex:{body:"#27ae60",accent:"#3dd6b0"},Nova:{body:"#3498db",accent:"#5dade2"},Beast:{body:"#8b0000",accent:"#dc143c"},Warden:{body:"#4a4a4a",accent:"#7a7a7a"},Hunter:{body:"#2f4f4f",accent:"#5f8f8f"}},cs=[{body:"#e8c84a",accent:"#ffd700"},{body:"#9b59b6",accent:"#bb77d6"},{body:"#e67e22",accent:"#f39c12"},{body:"#1abc9c",accent:"#3dd6b0"},{body:"#e74c3c",accent:"#ff6b6b"}];function _u(n,e){return us[n.name]?us[n.name]:cs[e%cs.length]}let xt=[],Et=new Map,Mu=new Map,Hl=null,Ul=null;function Ue(n){Hl=n}function Rr(n){Ul=n}function _n(n,e,r,a){xt.push({x:n*S+S/2,y:e*S+S/2,text:r,color:a,opacity:1,offsetY:0})}function ku(n,e){return new Promise(r=>{if(e.length===0){r();return}let a=0;const s=()=>{if(a>=e.length){Et.delete(n),r();return}const l=a===0?e[0]:e[a-1],o=e[a];Et.set(n,{characterId:n,fromX:a===0?l.x:e[a-1].x,fromY:a===0?l.y:e[a-1].y,toX:o.x,toY:o.y,progress:0});const u=120,i=performance.now(),c=()=>{const m=performance.now()-i,g=Math.min(m/u,1),h=Et.get(n);h&&(h.progress=g),g<1?requestAnimationFrame(c):(a++,s())};requestAnimationFrame(c)};s()})}function xu(){let n=!1;return xt=xt.filter(e=>(e.offsetY-=1.5,e.opacity-=.025,e.opacity>0)),xt.length>0&&(n=!0),Et.size>0&&(n=!0),n}function Eu(){return xt.length>0||Et.size>0}function Iu(n,e,r,a){const s=r*S,l=a*S;let o;switch(e){case"ground":o="ground";break;case"wall":o="wall";break;case"water":o="water";break;case"grass":o="grass";break;case"bars":o="bars";break;default:o="ground"}const u=Bt(o);n.drawImage(u,s,l,S,S)}function $u(n,e,r,a){const s=r*S,l=a*S;let o=null;switch(e.type){case"door":e.open?o="door_open":e.locked?o="door_locked":o="door_closed";break;case"chest":o=e.searched?"chest_searched":"chest";break;case"trap":o="trap";break}if(o){const u=Bt(o);n.drawImage(u,s,l,S,S)}}function Cu(n,e,r){const a=Et.get(e.id);let s,l;if(a&&e.alive){const u=(m,g,h)=>m+(g-m)*h,c=(m=>1-Math.pow(1-m,2))(a.progress);s=u(a.fromX,a.toX,c)*S+S/2,l=u(a.fromY,a.toY,c)*S+S/2}else s=e.position.x*S+S/2,l=e.position.y*S+S/2;const o=e.alive?_u(e,r):{body:"#4a3535",accent:"#3a2525"};if(e.alive?Au(n,s,l,o,e):Tu(n,s,l),e.alive){const c=s-11,m=l-14,g=e.hp/e.maxHp;n.fillStyle="#1a0a0a",n.fillRect(c-1,m-1,24,5);const h=n.createLinearGradient(c,m,c,m+3);g>.6?(h.addColorStop(0,"#6be875"),h.addColorStop(1,"#3cb44a")):g>.3?(h.addColorStop(0,"#fcd34d"),h.addColorStop(1,"#d97706")):(h.addColorStop(0,"#f87171"),h.addColorStop(1,"#b91c1c")),n.fillStyle=h,n.fillRect(c,m,22*g,3),n.fillStyle="rgba(255, 255, 255, 0.3)",n.fillRect(c,m,22*g,1)}n.font="bold 8px JetBrains Mono, monospace",n.fillStyle="#fff",n.textAlign="center",n.shadowColor="#000",n.shadowBlur=2,n.shadowOffsetX=1,n.shadowOffsetY=1,n.fillText(e.name,s,l-20),n.shadowBlur=0,n.shadowOffsetX=0,n.shadowOffsetY=0,e.alive&&(Hl===e.id?Su(n,s+12,l-16):Ul===e.id&&Pu(n,s+12,l-16)),Mu.set(e.id,r)}function Su(n,e,r){n.save(),n.fillStyle="#fff",n.strokeStyle="#666",n.lineWidth=1,n.beginPath(),n.ellipse(e,r,8,6,0,0,Math.PI*2),n.fill(),n.stroke(),n.beginPath(),n.arc(e-6,r+6,2.5,0,Math.PI*2),n.fill(),n.stroke(),n.beginPath(),n.arc(e-9,r+9,1.5,0,Math.PI*2),n.fill(),n.stroke(),n.fillStyle="#666",n.beginPath(),n.arc(e-3,r,1.2,0,Math.PI*2),n.arc(e,r,1.2,0,Math.PI*2),n.arc(e+3,r,1.2,0,Math.PI*2),n.fill(),n.restore()}function Pu(n,e,r){n.save(),n.fillStyle="#fff",n.strokeStyle="#333",n.lineWidth=1,n.beginPath(),n.ellipse(e,r,8,6,0,0,Math.PI*2),n.fill(),n.stroke(),n.beginPath(),n.moveTo(e-4,r+4),n.lineTo(e-8,r+10),n.lineTo(e-1,r+5),n.closePath(),n.fill(),n.stroke(),n.strokeStyle="#333",n.lineWidth=1,n.beginPath(),n.moveTo(e-4,r-1),n.lineTo(e+4,r-1),n.moveTo(e-4,r+2),n.lineTo(e+2,r+2),n.stroke(),n.restore()}function Au(n,e,r,a,s){const l=is(a.body),o=is(a.accent),u=!!s.equippedWeapon,i=bu(l,o,u);n.drawImage(i,e-16,r-16,32,32)}function Tu(n,e,r,a){const s=Bt("character_dead");n.drawImage(s,e-16,r-16,32,32)}function Bu(n,e,r){const a=e*S,s=r*S,l=Bt("trap");n.drawImage(l,a,s,S,S)}function Fu(n,e,r,a,s){const l=r*S+4+s%2*14,o=a*S+4+Math.floor(s/2)*14;let u;switch(e.type){case"weapon":u="item_weapon";break;case"consumable":u="item_consumable";break;case"key":u="item_key";break;case"trap":u="item_trap";break;case"clothing":u="item_clothing";break;case"contract":u="item_contract";break;default:u="item_consumable"}const i=Bt(u);n.drawImage(i,l,o,12,12)}function Du(n,e,r,a,s,l){var u;n.imageSmoothingEnabled=!1,n.fillStyle="#000",n.fillRect(0,0,e.width*S,e.height*S);const o=new Set;if(s)for(const i of s)o.add(`${i.x},${i.y}`);for(let i=0;i<e.height;i++)for(let c=0;c<e.width;c++){const m=e.tiles[i][c];Iu(n,m.type,c,i),m.feature&&$u(n,m.feature,c,i)}n.strokeStyle=vn.grid,n.lineWidth=1;for(let i=0;i<=e.width;i++)n.beginPath(),n.moveTo(i*S,0),n.lineTo(i*S,e.height*S),n.stroke();for(let i=0;i<=e.height;i++)n.beginPath(),n.moveTo(0,i*S),n.lineTo(e.width*S,i*S),n.stroke();if(a)for(const i of a){const c=i.x*S,m=i.y*S;n.fillStyle=vn.reachable,n.fillRect(c,m,S,S)}for(let i=0;i<e.height;i++)for(let c=0;c<e.width;c++){const m=e.tiles[i][c];m.items.forEach((g,h)=>{Fu(n,g,c,i,h)}),((u=m.feature)==null?void 0:u.type)==="trap"&&l&&m.feature.witnessIds.includes(l)&&o.has(`${c},${i}`)&&Bu(n,c,i)}if(r){const i=r.position.x*S,c=r.position.y*S;n.fillStyle=vn.highlight,n.fillRect(i,c,S,S)}if(e.characters.forEach((i,c)=>{Cu(n,i,c)}),o.size>0&&r)for(let i=0;i<e.height;i++)for(let c=0;c<e.width;c++){const m=r.position.x===c&&r.position.y===i;if(!o.has(`${c},${i}`)&&!m){const g=c*S,h=i*S;n.fillStyle=vn.notVisible,n.fillRect(g,h,S,S)}}for(const i of e.rooms){n.font="10px JetBrains Mono, monospace",n.fillStyle="rgba(255, 255, 255, 0.3)",n.textAlign="center";const c=((i.bounds.minX+i.bounds.maxX)/2+.5)*S,m=(i.bounds.minY+1.5)*S;n.fillText(i.name,c,m)}n.font="9px JetBrains Mono, monospace",n.textAlign="center",n.textBaseline="middle";for(let i=0;i<e.width;i++){const c=i*S+S/2;n.fillStyle="rgba(0, 0, 0, 0.7)",n.fillRect(i*S,0,S,12),n.fillStyle="rgba(255, 255, 255, 0.6)",n.fillText(String(i),c,6)}n.textAlign="right";for(let i=0;i<e.height;i++){const c=i*S+S/2;n.fillStyle="rgba(0, 0, 0, 0.7)",n.fillRect(0,i*S,14,S),n.fillStyle="rgba(255, 255, 255, 0.6)",n.fillText(String(i),12,c)}for(const i of xt)n.font="bold 14px JetBrains Mono, monospace",n.fillStyle=i.color.replace(")",`, ${i.opacity})`).replace("rgb","rgba"),i.color.startsWith("rgb")||(n.globalAlpha=i.opacity,n.fillStyle=i.color),n.textAlign="center",n.shadowColor="#000",n.shadowBlur=4,n.fillText(i.text,i.x,i.y+i.offsetY),n.shadowBlur=0,n.globalAlpha=1}function Gl(n){return{width:n.width*S,height:n.height*S}}function Ru(n,e){return{x:Math.floor(n/S),y:Math.floor(e/S)}}const K=new(window.AudioContext||window.webkitAudioContext);function oe(n,e,r="sine",a=.3,s=.01,l=.1){const o=K.createOscillator(),u=K.createGain();o.connect(u),u.connect(K.destination),o.type=r,o.frequency.setValueAtTime(n,K.currentTime),u.gain.setValueAtTime(0,K.currentTime),u.gain.linearRampToValueAtTime(a,K.currentTime+s),u.gain.linearRampToValueAtTime(a*.7,K.currentTime+s+l),u.gain.linearRampToValueAtTime(0,K.currentTime+e),o.start(K.currentTime),o.stop(K.currentTime+e)}function Rt(n,e=.2,r=1e3){const a=K.sampleRate*n,s=K.createBuffer(1,a,K.sampleRate),l=s.getChannelData(0);for(let c=0;c<a;c++)l[c]=Math.random()*2-1;const o=K.createBufferSource();o.buffer=s;const u=K.createBiquadFilter();u.type="highpass",u.frequency.value=r;const i=K.createGain();i.gain.setValueAtTime(e,K.currentTime),i.gain.linearRampToValueAtTime(0,K.currentTime+n),o.connect(u),u.connect(i),i.connect(K.destination),o.start()}const An={pickup:()=>{oe(600,.1,"sine",.2),setTimeout(()=>oe(800,.1,"sine",.2),50)},equip:()=>{oe(200,.15,"sawtooth",.15),setTimeout(()=>oe(400,.1,"sawtooth",.2),80)},attack:()=>{Rt(.15,.3,500),oe(150,.1,"sawtooth",.3)},miss:()=>{Rt(.1,.15,2e3),oe(200,.15,"sine",.1)},death:()=>{oe(300,.3,"sawtooth",.4),setTimeout(()=>oe(200,.3,"sawtooth",.3),150),setTimeout(()=>oe(100,.5,"sawtooth",.2),300)},unlock:()=>{oe(400,.1,"square",.15),setTimeout(()=>oe(500,.1,"square",.15),100),setTimeout(()=>oe(700,.15,"square",.2),200)},drop:()=>{oe(400,.1,"sine",.15),setTimeout(()=>oe(300,.1,"sine",.1),80)},search:()=>{Rt(.1,.1,3e3),setTimeout(()=>Rt(.08,.08,4e3),100)},trap:()=>{oe(800,.05,"square",.4),Rt(.2,.3,1e3),setTimeout(()=>oe(600,.1,"square",.3),100)}};function Lu(n){var e;K.state==="suspended"&&K.resume(),(e=An[n])==null||e.call(An)}function Ou(n){n&&n in An&&Lu(n)}let Qt=null;const Nu="onyx",ds=["echo","fable","ash"],fs=["nova","shimmer","alloy","sage","coral"],yr=new Map,Mn={male:0,female:0};function Wu(n){if(!yr.has(n.name)){let e;n.gender==="male"?(e=ds[Mn.male%ds.length],Mn.male++):(e=fs[Mn.female%fs.length],Mn.female++),yr.set(n.name,e)}return yr.get(n.name)}let ye=null;function Lr(n){Qt=new D({apiKey:n,dangerouslyAllowBrowser:!0})}async function Ct(n,e){if(!Qt){console.warn("Speech not initialized");return}ye&&(ye.pause(),ye=null);const r=Wu(e);try{const s=await(await Qt.audio.speech.create({model:"tts-1",voice:r,input:n,speed:1.5})).blob(),l=URL.createObjectURL(s);ye=new Audio(l),ye.play(),ye.onended=()=>{URL.revokeObjectURL(l),ye=null}}catch(a){console.error("TTS error:",a)}}async function qu(n){if(!Qt){console.warn("Speech not initialized");return}ye&&(ye.pause(),ye=null);try{const r=await(await Qt.audio.speech.create({model:"tts-1",voice:Nu,input:n,speed:1.3})).blob(),a=URL.createObjectURL(r);ye=new Audio(a),ye.play(),ye.onended=()=>{URL.revokeObjectURL(a),ye=null}}catch(e){console.error("TTS error:",e)}}function Hu(n,e){const r=[];for(let a=0;a<e;a++){r[a]=[];for(let s=0;s<n;s++)r[a][s]={type:"ground",items:[]}}return r}function jl(){return{tool:"select",selectedTerrain:"ground",selectedFeatureType:null,selectedItem:null,selectedCharacter:null,width:20,height:15,tiles:Hu(20,15),characters:[],rooms:[],selectedPosition:null}}function Uu(n,e,r){const a=[];for(let s=0;s<r;s++){a[s]=[];for(let l=0;l<e;l++)s<n.height&&l<n.width?a[s][l]=n.tiles[s][l]:a[s][l]={type:"ground",items:[]}}return a}function Gu(n){return{id:Z(),name:n.name,type:n.type,damage:n.damage,armor:n.armor,useEffect:n.useEffect,trapEffect:n.trapEffect}}function ju(n){return{id:Z(),name:n.name,gender:n.gender||"male",position:{x:n.x,y:n.y},hp:n.hp,maxHp:n.hp,inventory:n.inventory||[],equippedWeapon:n.equippedWeapon,equippedClothing:n.equippedClothing,alive:!0,personalityPrompt:n.personalityPrompt,movementRange:5,viewDistance:8,mapMemory:new Map,effects:n.effects||[],aiModel:n.aiModel||"gpt-5.2",reasoningEffort:n.aiModelReasoningEffort||"medium"}}function Ju(n){return{type:"door",id:Z(),name:n.name,locked:n.locked,open:!1,keyId:n.keyId}}function Vu(n){return{type:"chest",id:Z(),name:n.name,searched:!1,contents:n.contents}}function Ca(n){return{width:n.width,height:n.height,tiles:n.tiles,characters:n.characters,rooms:n.rooms,turn:0,events:[],activeContracts:[]}}function Ku(n){return{tool:"select",selectedTerrain:"ground",selectedFeatureType:null,selectedItem:null,selectedCharacter:null,width:n.width,height:n.height,tiles:n.tiles,characters:n.characters,rooms:n.rooms,selectedPosition:null}}function Jl(n){const e=Ca(n),r={...e,characters:e.characters.map(a=>({...a,mapMemory:Array.from(a.mapMemory.entries())}))};return JSON.stringify(r,null,2)}function Vl(n){const e=JSON.parse(n),r={...e,characters:e.characters.map(a=>({...a,mapMemory:new Map(a.mapMemory||[])}))};return Ku(r)}const Kl="ai-battlegrounds-editor-state";function Yu(n){try{const e=Jl(n);localStorage.setItem(Kl,e)}catch(e){console.error("Failed to save editor state to localStorage:",e)}}function Yl(){try{const n=localStorage.getItem(Kl);if(n)return Vl(n)}catch(n){console.error("Failed to load editor state from localStorage:",n)}return null}const zu=["gpt-5.2","gpt-4.1","gpt-4o","gpt-4o-mini","o4-mini"],L=32;let $=jl(),we=null,Or=null,kn=!1,zl=[],Y=null,fe=null;function ce(){Yu($)}const Xu={ground:"#8B7355",wall:"#4a4a5a",grass:"#4a7c3f",bars:"#6a6a7a",water:"#4a7c9f"},Qu={ground:"",wall:"#",grass:"",bars:"â•‘",water:"~"};function Zu(){we=document.getElementById("editor-canvas"),Or=(we==null?void 0:we.getContext("2d"))??null;const n=Yl();n&&($=n),ec(),tc(),nc(),rc(),ac(),ic(),dc(),fc(),J()}function ec(){const n=document.getElementById("game-mode-btn"),e=document.getElementById("editor-mode-btn"),r=document.querySelector("main"),a=document.getElementById("editor-container"),s=document.getElementById("game-controls"),l=document.getElementById("turn-info");n==null||n.addEventListener("click",()=>{n.classList.add("active"),e==null||e.classList.remove("active"),r==null||r.classList.remove("hidden"),a==null||a.classList.remove("active"),s&&(s.style.display=""),l&&(l.style.display="")}),e==null||e.addEventListener("click",()=>{e.classList.add("active"),n==null||n.classList.remove("active"),r==null||r.classList.add("hidden"),a==null||a.classList.add("active"),s&&(s.style.display="none"),l&&(l.style.display="none"),J()})}function tc(){const n=document.querySelectorAll(".tool-btn"),e=document.getElementById("terrain-panel");n.forEach(r=>{r.addEventListener("click",()=>{n.forEach(s=>s.classList.remove("active")),r.classList.add("active");const a=r.getAttribute("data-tool");$.tool=a,e&&(e.style.display=a==="terrain"?"":"none")})})}function nc(){const n=document.querySelectorAll(".terrain-palette .palette-item");n.forEach(e=>{e.addEventListener("click",()=>{n.forEach(r=>r.classList.remove("selected")),e.classList.add("selected"),$.selectedTerrain=e.getAttribute("data-terrain")})})}function rc(){const n=document.getElementById("editor-width"),e=document.getElementById("editor-height"),r=document.getElementById("resize-map-btn");r==null||r.addEventListener("click",()=>{const a=parseInt(n.value)||20,s=parseInt(e.value)||15;$.tiles=Uu($,a,s),$.width=a,$.height=s,$.characters=$.characters.filter(l=>l.position.x<a&&l.position.y<s),J(),ce()})}function ac(){we&&(we.addEventListener("mousedown",n=>{kn=!0,ms(n)}),we.addEventListener("mousemove",n=>{kn&&$.tool==="terrain"&&ms(n)}),we.addEventListener("mouseup",()=>{kn=!1}),we.addEventListener("mouseleave",()=>{kn=!1}))}function ms(n){if(!we)return;const e=we.getBoundingClientRect(),r=Math.floor((n.clientX-e.left)/L),a=Math.floor((n.clientY-e.top)/L);if(r<0||r>=$.width||a<0||a>=$.height)return;$.selectedPosition={x:r,y:a};let s=!1;if(fe){s=sc(r,a),fe=null,J(),ne(r,a),s&&ce();return}$.tool==="terrain"?($.tiles[a][r].type=$.selectedTerrain,s=!0):ne(r,a),J(),s&&ce()}function sc(n,e){var a,s,l;if(!fe)return!1;const r=$.tiles[e][n];switch(fe.type){case"character":{const o=fe.id,u=$.characters.find(i=>i.id===o);if(u){const i=$.characters.find(c=>c.position.x===n&&c.position.y===e);return i&&i.id!==u.id?(alert("Another character is already at that position"),!1):(u.position={x:n,y:e},!0)}return!1}case"feature":{const{fromX:o,fromY:u}=fe,i=$.tiles[u][o];return i.feature?r.feature?(alert("Target tile already has a feature"),!1):(r.feature=i.feature,i.feature=void 0,!0):!1}case"item":{const{fromX:o,fromY:u,index:i}=fe,c=$.tiles[u][o];if(i<0||i>=c.items.length)return!1;const m=c.items.splice(i,1)[0];return((a=r.feature)==null?void 0:a.type)==="chest"?r.feature.contents.push(m):r.items.push(m),!0}case"chestItem":{const{fromX:o,fromY:u,index:i}=fe,c=$.tiles[u][o];if(((s=c.feature)==null?void 0:s.type)!=="chest"||i<0||i>=c.feature.contents.length)return!1;const m=c.feature.contents.splice(i,1)[0];return((l=r.feature)==null?void 0:l.type)==="chest"?r.feature.contents.push(m):r.items.push(m),!0}}return!1}function ne(n,e){const r=document.getElementById("properties-content");if(!r)return;const a=$.tiles[e][n],s=$.characters.find(o=>o.position.x===n&&o.position.y===e);let l=`<h4>Tile (${n}, ${e})</h4>`;if(l+=`<p>Terrain: ${a.type}</p>`,fe&&(l+='<div style="background: #ffcc44; color: #000; padding: 0.5rem; border-radius: 4px; margin: 0.5rem 0; text-align: center;">',l+="<strong>ðŸ“ Click a tile to move here</strong>",l+='<button class="btn-secondary" style="display: block; width: 100%; margin-top: 0.25rem;" onclick="window.editorCancelMove()">Cancel Move</button>',l+="</div>"),a.feature){if(l+='<hr style="margin: 0.5rem 0; border-color: var(--border-color);">',l+=`<h4>Feature: ${a.feature.name}</h4>`,l+=`<p style="color: var(--text-secondary);">Type: ${a.feature.type}</p>`,a.feature.type==="chest"){const o=a.feature;o.contents.length>0?(l+='<p style="margin-top: 0.5rem; font-weight: 600;">Contents:</p>',l+='<div style="margin-left: 0.5rem;">',o.contents.forEach((u,i)=>{l+='<div style="display: flex; justify-content: space-between; align-items: center; margin: 0.25rem 0;">',l+=`<span>â€¢ ${u.name} <span style="color: var(--text-secondary); font-size: 0.75rem;">(${u.type})</span></span>`,l+='<div style="display: flex; gap: 0.25rem;">',l+=`<button class="btn-secondary" style="padding: 0.1rem 0.3rem; font-size: 0.7rem;" title="Move" onclick="window.editorMoveChestItem(${n}, ${e}, ${i})">â†—</button>`,l+=`<button class="btn-secondary" style="padding: 0.1rem 0.3rem; font-size: 0.7rem;" onclick="window.editorEditItem(${n}, ${e}, ${i}, 'chest')">âœŽ</button>`,l+=`<button class="btn-secondary" style="padding: 0.1rem 0.3rem; font-size: 0.7rem;" onclick="window.editorRemoveChestItem(${n}, ${e}, ${i})">âœ•</button>`,l+="</div>",l+="</div>"}),l+="</div>"):l+='<p style="color: var(--text-secondary); font-style: italic;">Empty</p>'}l+='<div style="display: flex; gap: 0.25rem; margin-top: 0.5rem;">',l+=`<button class="btn-secondary" style="flex: 1;" onclick="window.editorMoveFeature(${n}, ${e})">â†— Move</button>`,l+=`<button class="btn-secondary" style="flex: 1;" onclick="window.editorRemoveFeature(${n}, ${e})">ðŸ—‘ï¸ Remove</button>`,l+="</div>"}a.items.length>0&&(l+='<hr style="margin: 0.5rem 0; border-color: var(--border-color);">',l+="<h4>Items on Ground</h4>",l+='<div style="margin-left: 0.5rem;">',a.items.forEach((o,u)=>{l+='<div style="display: flex; justify-content: space-between; align-items: center; margin: 0.25rem 0;">',l+=`<span>â€¢ ${o.name} <span style="color: var(--text-secondary); font-size: 0.75rem;">(${o.type})</span></span>`,l+='<div style="display: flex; gap: 0.25rem;">',l+=`<button class="btn-secondary" style="padding: 0.1rem 0.3rem; font-size: 0.7rem;" title="Move" onclick="window.editorMoveItem(${n}, ${e}, ${u})">â†—</button>`,l+=`<button class="btn-secondary" style="padding: 0.1rem 0.3rem; font-size: 0.7rem;" onclick="window.editorEditItem(${n}, ${e}, ${u}, 'ground')">âœŽ</button>`,l+=`<button class="btn-secondary" style="padding: 0.1rem 0.3rem; font-size: 0.7rem;" onclick="window.editorRemoveItem(${n}, ${e}, ${u})">âœ•</button>`,l+="</div>",l+="</div>"}),l+="</div>",l+=`<button class="btn-secondary" style="margin-top: 0.5rem; width: 100%;" onclick="window.editorClearItems(${n}, ${e})">ðŸ—‘ï¸ Clear All Items</button>`),s&&(l+='<hr style="margin: 0.5rem 0; border-color: var(--border-color);">',l+=`<h4>Character: ${s.name}</h4>`,l+=`<p style="font-size: 0.85rem;">Gender: ${s.gender}</p>`,l+=`<p style="font-size: 0.85rem;">HP: ${s.hp}/${s.maxHp}</p>`,l+=`<p style="font-size: 0.85rem;">Model: ${s.aiModel}</p>`,s.inventory.length>0&&(l+=`<p style="font-size: 0.85rem;">Inventory: ${s.inventory.length} items</p>`),s.equippedWeapon&&(l+=`<p style="font-size: 0.85rem;">Weapon: ${s.equippedWeapon.name}</p>`),s.effects.length>0&&(l+=`<p style="font-size: 0.85rem;">Effects: ${s.effects.map(o=>o.name).join(", ")}</p>`),l+='<div style="display: flex; gap: 0.25rem; margin-top: 0.5rem;">',l+=`<button class="btn-secondary" style="flex: 1;" onclick="window.editorMoveCharacter('${s.id}')">â†— Move</button>`,l+=`<button class="btn-primary" style="flex: 1;" onclick="window.editorEditCharacter('${s.id}')">âœŽ Edit</button>`,l+=`<button class="btn-secondary" style="flex: 1;" onclick="window.editorRemoveCharacter('${s.id}')">ðŸ—‘ï¸</button>`,l+="</div>"),l+='<hr style="margin: 0.75rem 0; border-color: var(--border-color);">',l+="<h4>Add to Tile</h4>",l+='<div style="display: flex; flex-direction: column; gap: 0.25rem;">',a.feature||(l+=`<button class="btn-secondary" style="width: 100%;" onclick="window.editorAddFeature(${n}, ${e}, 'door')">ðŸšª Add Door</button>`,l+=`<button class="btn-secondary" style="width: 100%;" onclick="window.editorAddFeature(${n}, ${e}, 'chest')">ðŸ“¦ Add Chest</button>`),l+=`<button class="btn-secondary" style="width: 100%;" onclick="window.editorShowAddItem(${n}, ${e})">ðŸ“¦ Add Item...</button>`,s||(l+=`<button class="btn-secondary" style="width: 100%;" onclick="window.editorShowAddCharacter(${n}, ${e})">ðŸ‘¤ Add Character...</button>`),l+="</div>",r.innerHTML=l}let pe=[];function lt(){const n=document.getElementById("item-effect-triggers-container");if(n){if(pe.length===0){n.innerHTML='<p style="color: var(--text-secondary); font-size: 0.8rem;">No triggers. Add at least one trigger.</p>';return}n.innerHTML=pe.map((e,r)=>`
    <div style="border: 1px solid var(--border-color); padding: 0.5rem; margin-bottom: 0.5rem; border-radius: 4px; background: var(--bg-panel);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
        <select class="item-trigger-type-select" data-trigger-idx="${r}" style="flex: 1;">
          <option value="turn_start" ${e.on==="turn_start"?"selected":""}>Turn Start</option>
          <option value="turn_end" ${e.on==="turn_end"?"selected":""}>Turn End</option>
          <option value="on_attack" ${e.on==="on_attack"?"selected":""}>On Attack</option>
          <option value="on_damaged" ${e.on==="on_damaged"?"selected":""}>On Damaged</option>
          <option value="on_expired" ${e.on==="on_expired"?"selected":""}>On Expired</option>
        </select>
        <button class="btn-secondary" style="padding: 0.1rem 0.3rem; font-size: 0.7rem; margin-left: 0.25rem;" onclick="window.itemEffectFormRemoveTrigger(${r})">âœ•</button>
      </div>
      <div style="margin-left: 0.5rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
          <span style="font-size: 0.8rem; font-weight: 600;">Actions:</span>
          <button class="btn-secondary" style="padding: 0.1rem 0.3rem; font-size: 0.7rem;" onclick="window.itemEffectFormAddAction(${r})">+ Add</button>
        </div>
        ${e.actions.length===0?'<p style="color: var(--text-secondary); font-size: 0.75rem;">No actions</p>':e.actions.map((a,s)=>`
          <div style="display: flex; gap: 0.25rem; align-items: center; margin-bottom: 0.25rem; padding: 0.25rem; background: var(--bg-panel-light); border-radius: 3px;">
            <select class="item-action-type-select" data-trigger-idx="${r}" data-action-idx="${s}" style="width: 100px;">
              <option value="damage" ${a.type==="damage"?"selected":""}>Damage</option>
              <option value="heal" ${a.type==="heal"?"selected":""}>Heal</option>
              <option value="modify_stat" ${a.type==="modify_stat"?"selected":""}>Modify Stat</option>
              <option value="message" ${a.type==="message"?"selected":""}>Message</option>
              <option value="custom" ${a.type==="custom"?"selected":""}>Custom</option>
            </select>
            ${lc(a,r,s)}
            <button class="btn-secondary" style="padding: 0.1rem 0.3rem; font-size: 0.7rem;" onclick="window.itemEffectFormRemoveAction(${r}, ${s})">âœ•</button>
          </div>
        `).join("")}
      </div>
    </div>
  `).join(""),n.querySelectorAll(".item-trigger-type-select").forEach(e=>{e.addEventListener("change",r=>{const a=r.target,s=parseInt(a.dataset.triggerIdx||"0");pe[s].on=a.value})}),n.querySelectorAll(".item-action-type-select").forEach(e=>{e.addEventListener("change",r=>{const a=r.target,s=parseInt(a.dataset.triggerIdx||"0"),l=parseInt(a.dataset.actionIdx||"0");pe[s].actions[l]=Xl(a.value),lt()})}),n.querySelectorAll(".item-action-field").forEach(e=>{e.addEventListener("change",r=>{const a=r.target,s=parseInt(a.dataset.triggerIdx||"0"),l=parseInt(a.dataset.actionIdx||"0"),o=a.dataset.field||"";oc(s,l,o,a.value)})})}}function lc(n,e,r){switch(n.type){case"damage":case"heal":return`<input type="number" class="item-action-field" data-trigger-idx="${e}" data-action-idx="${r}" data-field="amount" value="${n.amount}" style="width: 60px;">`;case"modify_stat":return`
        <select class="item-action-field" data-trigger-idx="${e}" data-action-idx="${r}" data-field="stat" style="width: 70px;">
          <option value="attack" ${n.stat==="attack"?"selected":""}>Attack</option>
          <option value="defense" ${n.stat==="defense"?"selected":""}>Defense</option>
          <option value="speed" ${n.stat==="speed"?"selected":""}>Speed</option>
        </select>
        <select class="item-action-field" data-trigger-idx="${e}" data-action-idx="${r}" data-field="operation" style="width: 70px;">
          <option value="add" ${n.operation==="add"?"selected":""}>Add</option>
          <option value="multiply" ${n.operation==="multiply"?"selected":""}>Multiply</option>
        </select>
        <input type="number" class="item-action-field" data-trigger-idx="${e}" data-action-idx="${r}" data-field="value" value="${n.value}" step="0.1" style="width: 50px;">
      `;case"message":return`<input type="text" class="item-action-field" data-trigger-idx="${e}" data-action-idx="${r}" data-field="text" value="${n.text}" placeholder="Message" style="flex: 1;">`;case"custom":return`<input type="text" class="item-action-field" data-trigger-idx="${e}" data-action-idx="${r}" data-field="prompt" value="${n.prompt}" placeholder="Custom prompt" style="flex: 1;">`;default:return""}}function oc(n,e,r,a){const s=pe[n].actions[e];switch(s.type){case"damage":case"heal":r==="amount"&&(s.amount=parseInt(a));break;case"modify_stat":r==="stat"&&(s.stat=a),r==="operation"&&(s.operation=a),r==="value"&&(s.value=parseFloat(a));break;case"message":r==="text"&&(s.text=a);break;case"custom":r==="prompt"&&(s.prompt=a);break}}window.itemEffectFormRemoveTrigger=n=>{pe.splice(n,1),lt()};window.itemEffectFormAddAction=n=>{pe[n].actions.push({type:"damage",amount:1}),lt()};window.itemEffectFormRemoveAction=(n,e)=>{pe[n].actions.splice(e,1),lt()};function ic(){const n=document.getElementById("item-type"),e=document.getElementById("damage-group"),r=document.getElementById("armor-group"),a=document.getElementById("use-effect-group"),s=document.getElementById("item-use-effect-type"),l=document.getElementById("use-effect-heal-group"),o=document.getElementById("use-effect-damage-group"),u=document.getElementById("use-effect-modify-stat-group"),i=document.getElementById("use-effect-message-group"),c=document.getElementById("use-effect-apply-group"),m=f=>{l&&(l.style.display=f==="heal"?"":"none"),o&&(o.style.display=f==="damage"?"":"none"),u&&(u.style.display=f==="modify_stat"?"":"none"),i&&(i.style.display=f==="message"?"":"none"),c&&(c.style.display=f==="apply_effect"?"":"none")};n==null||n.addEventListener("change",()=>{const f=n.value;e&&(e.style.display=f==="weapon"?"":"none"),r&&(r.style.display=f==="clothing"?"":"none"),a&&(a.style.display=f==="consumable"||f==="trap"?"":"none")}),s==null||s.addEventListener("change",()=>{m(s.value)});const g=document.getElementById("item-add-trigger-btn");g==null||g.addEventListener("click",()=>{pe.push({on:"turn_start",actions:[]}),lt()}),s==null||s.addEventListener("change",()=>{s.value==="apply_effect"&&(pe=[],lt())});const h=document.getElementById("item-form-panel"),y=document.getElementById("cancel-item-btn"),d=document.getElementById("save-item-btn");d==null||d.addEventListener("click",()=>{var I,C;const f=document.getElementById("item-name").value,p=document.getElementById("item-type").value,b=parseInt(document.getElementById("item-damage").value),w=parseInt(document.getElementById("item-armor").value);if(!f)return;let M,x;if(p==="consumable"||p==="trap")switch((s==null?void 0:s.value)||"heal"){case"heal":M={type:"heal",amount:parseInt(document.getElementById("item-use-heal").value)};break;case"damage":M={type:"damage",amount:parseInt(document.getElementById("item-use-damage").value)};break;case"modify_stat":M={type:"modify_stat",stat:document.getElementById("item-use-stat").value,operation:document.getElementById("item-use-operation").value,value:parseFloat(document.getElementById("item-use-value").value)};break;case"message":M={type:"message",text:document.getElementById("item-use-message").value};break;case"apply_effect":const k=document.getElementById("item-effect-name").value,A=parseInt(document.getElementById("item-effect-duration").value),U=document.getElementById("item-effect-prevents-movement").checked;if(pe.length===0){alert("Add at least one trigger to the effect");return}const W={id:Z(),name:k||"Effect",duration:A,preventsMovement:U||void 0,triggers:pe.map(he=>({on:he.on,actions:[...he.actions]}))};p==="trap"?x=W:M={type:"apply_effect",effect:W},pe=[];break}const E=Gu({name:f,type:p,damage:p==="weapon"?b:void 0,armor:p==="clothing"?w:void 0,useEffect:M,trapEffect:x});if(wt){const{x:B,y:k,idx:A,location:U}=wt,W=$.tiles[k][B];U==="ground"?W.items[A]={...E}:U==="chest"&&((I=W.feature)==null?void 0:I.type)==="chest"&&(W.feature.contents[A]={...E}),J(),ne(B,k),ce(),wt=null,Y=null}else if(zl.push(E),Y){const B=$.tiles[Y.y][Y.x],k=((C=B.feature)==null?void 0:C.type)==="chest"?B.feature:null;k?k.contents.push({...E}):B.items.push({...E}),J(),ne(Y.x,Y.y),ce(),Y=null}document.getElementById("item-name").value="";const _=document.getElementById("save-item-btn");_&&(_.textContent="Create Item"),h&&(h.style.display="none")}),y==null||y.addEventListener("click",()=>{Y=null,wt=null;const f=document.getElementById("save-item-btn");f&&(f.textContent="Create Item"),h&&(h.style.display="none")})}let Ee=[],Xe=[],ot=null,it=null;function Ut(){Ee=[],Xe=[],ot=null,it=null,me=[],Zn(),er(),tr(),document.getElementById("char-name").value="",document.getElementById("char-hp").value="20",document.getElementById("char-reasoning-effort").value="medium",document.getElementById("char-prompt").value="";const n=document.getElementById("char-effect-form");n&&(n.style.display="none")}function Zn(){const n=document.getElementById("char-inventory-list");n&&(Ee.length===0?n.innerHTML='<p style="color: var(--text-secondary); font-size: 0.8rem;">No items</p>':n.innerHTML=Ee.map((e,r)=>`
      <div style="display: flex; justify-content: space-between; align-items: center; margin: 0.25rem 0;">
        <span style="font-size: 0.85rem;">â€¢ ${e.name} <span style="color: var(--text-secondary);">(${e.type})</span></span>
        <button class="btn-secondary" style="padding: 0.1rem 0.3rem; font-size: 0.7rem;" onclick="window.charFormRemoveItem(${r})">âœ•</button>
      </div>
    `).join(""))}function er(){const n=document.getElementById("char-effects-list");n&&(Xe.length===0?n.innerHTML='<p style="color: var(--text-secondary); font-size: 0.8rem;">No effects</p>':n.innerHTML=Xe.map((e,r)=>`
      <div style="display: flex; justify-content: space-between; align-items: center; margin: 0.25rem 0;">
        <span style="font-size: 0.85rem;">â€¢ ${e.name} <span style="color: var(--text-secondary);">(${e.duration} turns)</span></span>
        <button class="btn-secondary" style="padding: 0.1rem 0.3rem; font-size: 0.7rem;" onclick="window.charFormRemoveEffect(${r})">âœ•</button>
      </div>
    `).join(""))}function tr(){const n=document.getElementById("char-equipped-weapon"),e=document.getElementById("char-equipped-clothing");if(n){const r=Ee.filter(a=>a.type==="weapon");n.innerHTML='<option value="">None</option>',r.forEach(a=>{n.innerHTML+=`<option value="${a.id}" ${ot===a.id?"selected":""}>${a.name}</option>`})}if(e){const r=Ee.filter(a=>a.type==="clothing");e.innerHTML='<option value="">None</option>',r.forEach(a=>{e.innerHTML+=`<option value="${a.id}" ${it===a.id?"selected":""}>${a.name}</option>`})}}function Sa(){const n=document.getElementById("char-add-item-select");if(!n)return;const e=nr();n.innerHTML=e.map(r=>`<option value="${r.id}">${r.name} (${r.type})</option>`).join("")}window.charFormRemoveItem=n=>{const e=Ee.splice(n,1)[0];e&&ot===e.id&&(ot=null),e&&it===e.id&&(it=null),Zn(),tr()};window.charFormRemoveEffect=n=>{Xe.splice(n,1),er()};let me=[];function St(){const n=document.getElementById("char-effect-triggers-container");if(n){if(me.length===0){n.innerHTML='<p style="color: var(--text-secondary); font-size: 0.8rem;">No triggers. Add at least one trigger.</p>';return}n.innerHTML=me.map((e,r)=>`
    <div style="border: 1px solid var(--border-color); padding: 0.5rem; margin-bottom: 0.5rem; border-radius: 4px; background: var(--bg-panel);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
        <select class="trigger-type-select" data-trigger-idx="${r}" style="flex: 1;">
          <option value="turn_start" ${e.on==="turn_start"?"selected":""}>Turn Start</option>
          <option value="turn_end" ${e.on==="turn_end"?"selected":""}>Turn End</option>
          <option value="on_attack" ${e.on==="on_attack"?"selected":""}>On Attack</option>
          <option value="on_damaged" ${e.on==="on_damaged"?"selected":""}>On Damaged</option>
          <option value="on_expired" ${e.on==="on_expired"?"selected":""}>On Expired</option>
        </select>
        <button class="btn-secondary" style="padding: 0.1rem 0.3rem; font-size: 0.7rem; margin-left: 0.25rem;" onclick="window.effectFormRemoveTrigger(${r})">âœ•</button>
      </div>
      <div style="margin-left: 0.5rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
          <span style="font-size: 0.8rem; font-weight: 600;">Actions:</span>
          <button class="btn-secondary" style="padding: 0.1rem 0.3rem; font-size: 0.7rem;" onclick="window.effectFormAddAction(${r})">+ Add</button>
        </div>
        ${e.actions.length===0?'<p style="color: var(--text-secondary); font-size: 0.75rem;">No actions</p>':e.actions.map((a,s)=>`
          <div style="display: flex; gap: 0.25rem; align-items: center; margin-bottom: 0.25rem; padding: 0.25rem; background: var(--bg-panel-light); border-radius: 3px;">
            <select class="action-type-select" data-trigger-idx="${r}" data-action-idx="${s}" style="width: 100px;">
              <option value="damage" ${a.type==="damage"?"selected":""}>Damage</option>
              <option value="heal" ${a.type==="heal"?"selected":""}>Heal</option>
              <option value="modify_stat" ${a.type==="modify_stat"?"selected":""}>Modify Stat</option>
              <option value="message" ${a.type==="message"?"selected":""}>Message</option>
              <option value="custom" ${a.type==="custom"?"selected":""}>Custom</option>
            </select>
            ${uc(a,r,s)}
            <button class="btn-secondary" style="padding: 0.1rem 0.3rem; font-size: 0.7rem;" onclick="window.effectFormRemoveAction(${r}, ${s})">âœ•</button>
          </div>
        `).join("")}
      </div>
    </div>
  `).join(""),n.querySelectorAll(".trigger-type-select").forEach(e=>{e.addEventListener("change",r=>{const a=r.target,s=parseInt(a.dataset.triggerIdx||"0");me[s].on=a.value})}),n.querySelectorAll(".action-type-select").forEach(e=>{e.addEventListener("change",r=>{const a=r.target,s=parseInt(a.dataset.triggerIdx||"0"),l=parseInt(a.dataset.actionIdx||"0"),o=a.value;me[s].actions[l]=Xl(o),St()})}),n.querySelectorAll(".action-field").forEach(e=>{e.addEventListener("change",r=>{const a=r.target,s=parseInt(a.dataset.triggerIdx||"0"),l=parseInt(a.dataset.actionIdx||"0"),o=a.dataset.field||"";cc(s,l,o,a.value)})})}}function uc(n,e,r){switch(n.type){case"damage":case"heal":return`<input type="number" class="action-field" data-trigger-idx="${e}" data-action-idx="${r}" data-field="amount" value="${n.amount}" style="width: 60px;">`;case"modify_stat":return`
        <select class="action-field" data-trigger-idx="${e}" data-action-idx="${r}" data-field="stat" style="width: 70px;">
          <option value="attack" ${n.stat==="attack"?"selected":""}>Attack</option>
          <option value="defense" ${n.stat==="defense"?"selected":""}>Defense</option>
          <option value="speed" ${n.stat==="speed"?"selected":""}>Speed</option>
        </select>
        <select class="action-field" data-trigger-idx="${e}" data-action-idx="${r}" data-field="operation" style="width: 70px;">
          <option value="add" ${n.operation==="add"?"selected":""}>Add</option>
          <option value="multiply" ${n.operation==="multiply"?"selected":""}>Multiply</option>
        </select>
        <input type="number" class="action-field" data-trigger-idx="${e}" data-action-idx="${r}" data-field="value" value="${n.value}" step="0.1" style="width: 50px;">
      `;case"message":return`<input type="text" class="action-field" data-trigger-idx="${e}" data-action-idx="${r}" data-field="text" value="${n.text}" placeholder="Message" style="flex: 1;">`;case"custom":return`<input type="text" class="action-field" data-trigger-idx="${e}" data-action-idx="${r}" data-field="prompt" value="${n.prompt}" placeholder="Custom prompt" style="flex: 1;">`;default:return""}}function Xl(n){switch(n){case"heal":return{type:"heal",amount:5};case"damage":return{type:"damage",amount:5};case"modify_stat":return{type:"modify_stat",stat:"attack",operation:"multiply",value:.5};case"message":return{type:"message",text:""};case"custom":return{type:"custom",prompt:""};default:return{type:"damage",amount:1}}}function cc(n,e,r,a){const s=me[n].actions[e];switch(s.type){case"damage":case"heal":r==="amount"&&(s.amount=parseInt(a));break;case"modify_stat":r==="stat"&&(s.stat=a),r==="operation"&&(s.operation=a),r==="value"&&(s.value=parseFloat(a));break;case"message":r==="text"&&(s.text=a);break;case"custom":r==="prompt"&&(s.prompt=a);break}}window.effectFormRemoveTrigger=n=>{me.splice(n,1),St()};window.effectFormAddAction=n=>{me[n].actions.push({type:"damage",amount:1}),St()};window.effectFormRemoveAction=(n,e)=>{me[n].actions.splice(e,1),St()};function dc(){const n=document.getElementById("char-model");if(n){n.innerHTML="";for(const h of zu){const y=document.createElement("option");y.value=h,y.textContent=h,n.appendChild(y)}}const e=document.getElementById("character-form-panel"),r=document.getElementById("cancel-char-btn"),a=document.getElementById("save-char-btn"),s=document.getElementById("char-add-item-btn"),l=document.getElementById("char-add-effect-btn"),o=document.getElementById("char-effect-form"),u=document.getElementById("char-save-effect-btn"),i=document.getElementById("char-cancel-effect-btn"),c=document.getElementById("char-add-trigger-btn");s==null||s.addEventListener("click",()=>{const h=document.getElementById("char-add-item-select"),y=h==null?void 0:h.value;if(!y)return;const f=nr().find(p=>p.id===y);f&&(Ee.push({...f,id:Z()}),Zn(),tr())}),l==null||l.addEventListener("click",()=>{me=[],document.getElementById("char-effect-name").value="",document.getElementById("char-effect-duration").value="3",document.getElementById("char-effect-prevents-movement").checked=!1,St(),o&&(o.style.display="")}),c==null||c.addEventListener("click",()=>{me.push({on:"turn_start",actions:[]}),St()}),i==null||i.addEventListener("click",()=>{me=[],o&&(o.style.display="none")}),u==null||u.addEventListener("click",()=>{const h=document.getElementById("char-effect-name").value,y=parseInt(document.getElementById("char-effect-duration").value),d=document.getElementById("char-effect-prevents-movement").checked;if(me.length===0){alert("Add at least one trigger to the effect");return}const f={id:Z(),name:h||"Effect",duration:y,preventsMovement:d||void 0,triggers:me.map(p=>({on:p.on,actions:[...p.actions]}))};Xe.push(f),er(),me=[],document.getElementById("char-effect-name").value="",o&&(o.style.display="none")}),r==null||r.addEventListener("click",()=>{Y=null,bt=null,Ut();const h=document.getElementById("save-char-btn");h&&(h.textContent="Create Character"),e&&(e.style.display="none")});const m=document.getElementById("char-equipped-weapon"),g=document.getElementById("char-equipped-clothing");m==null||m.addEventListener("change",()=>{ot=m.value||null}),g==null||g.addEventListener("change",()=>{it=g.value||null}),a==null||a.addEventListener("click",()=>{const h=document.getElementById("char-name").value,y=document.getElementById("char-gender").value,d=parseInt(document.getElementById("char-hp").value),f=document.getElementById("char-model").value,p=document.getElementById("char-reasoning-effort").value,b=document.getElementById("char-prompt").value;if(!h)return;const w=Ee.find(x=>x.id===ot),M=Ee.find(x=>x.id===it);if(bt){const x=$.characters.findIndex(_=>_.id===bt);if(x!==-1){const _=$.characters[x];_.name=h,_.gender=y,_.maxHp=d,_.hp=Math.min(_.hp,d),_.aiModel=f,_.reasoningEffort=p,_.personalityPrompt=b,_.inventory=[...Ee],_.equippedWeapon=w?{...w}:void 0,_.equippedClothing=M?{...M}:void 0,_.effects=Xe.map(I=>({...I,triggers:I.triggers.map(C=>({...C,actions:[...C.actions]}))})),J(),ne(_.position.x,_.position.y),ce()}bt=null,Y=null,Ut();const E=document.getElementById("save-char-btn");E&&(E.textContent="Create Character"),e&&(e.style.display="none")}else if(Y){const x=ju({name:h,gender:y,x:Y.x,y:Y.y,hp:d,personalityPrompt:b,aiModel:f,aiModelReasoningEffort:p,inventory:[...Ee],equippedWeapon:w?{...w}:void 0,equippedClothing:M?{...M}:void 0,effects:[...Xe]});$.characters.push(x),$.selectedPosition={...Y},J(),ne(Y.x,Y.y),ce(),Y=null,Ut(),e&&(e.style.display="none")}else $.selectedCharacter={name:h,maxHp:d,hp:d,aiModel:f,personalityPrompt:b},Ut(),e&&(e.style.display="none")}),Sa()}function fc(){const n=document.getElementById("export-map-btn"),e=document.getElementById("import-map-btn"),r=document.getElementById("clear-map-btn"),a=document.getElementById("play-map-btn");n==null||n.addEventListener("click",()=>{const s=Jl($);navigator.clipboard.writeText(s),alert("Map JSON copied to clipboard!")}),e==null||e.addEventListener("click",()=>{var u,i;const s=document.createElement("div");s.style.cssText=`
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.8); display: flex; align-items: center;
      justify-content: center; z-index: 10000;
    `;const l=document.createElement("div");l.style.cssText=`
      background: #1a1a25; padding: 20px; border-radius: 8px;
      border: 1px solid #2a2a3a; max-width: 600px; width: 90%;
    `,l.innerHTML=`
      <h3 style="margin: 0 0 10px 0; color: #e8e8f0;">Import Map JSON</h3>
      <textarea id="import-json-textarea" style="
        width: 100%; height: 300px; background: #12121a; color: #e8e8f0;
        border: 1px solid #2a2a3a; border-radius: 4px; padding: 10px;
        font-family: monospace; font-size: 12px; resize: vertical;
      " placeholder="Paste your map JSON here..."></textarea>
      <div style="margin-top: 10px; display: flex; gap: 10px; justify-content: flex-end;">
        <button id="import-cancel-btn" style="
          padding: 8px 16px; background: #2a2a3a; color: #e8e8f0;
          border: none; border-radius: 4px; cursor: pointer;
        ">Cancel</button>
        <button id="import-confirm-btn" style="
          padding: 8px 16px; background: #4488ff; color: white;
          border: none; border-radius: 4px; cursor: pointer;
        ">Import</button>
      </div>
    `,s.appendChild(l),document.body.appendChild(s);const o=document.getElementById("import-json-textarea");o==null||o.focus(),(u=document.getElementById("import-cancel-btn"))==null||u.addEventListener("click",()=>{s.remove()}),(i=document.getElementById("import-confirm-btn"))==null||i.addEventListener("click",()=>{const c=o==null?void 0:o.value;if(c)try{$=Vl(c),J(),ce(),s.remove()}catch(m){alert("Invalid JSON: "+m.message)}}),s.addEventListener("keydown",c=>{c.key==="Escape"&&s.remove()}),s.addEventListener("click",c=>{c.target===s&&s.remove()})}),r==null||r.addEventListener("click",()=>{confirm("Clear the entire map?")&&($=jl(),J(),ce())}),a==null||a.addEventListener("click",()=>{var o;const s=Ca($);window.customWorld=s;const l=document.getElementById("map-select");l&&(l.value="custom"),(o=document.getElementById("game-mode-btn"))==null||o.click(),l==null||l.dispatchEvent(new Event("change"))})}function J(){if(!we||!Or)return;we.width=$.width*L,we.height=$.height*L;const n=Or;for(let r=0;r<$.height;r++)for(let a=0;a<$.width;a++){const s=$.tiles[r][a],l=a*L,o=r*L;n.fillStyle=Xu[s.type],n.fillRect(l,o,L,L);const u=Qu[s.type];if(u&&(n.fillStyle="#ffffff44",n.font="16px monospace",n.textAlign="center",n.textBaseline="middle",n.fillText(u,l+L/2,o+L/2)),s.feature){n.fillStyle=s.feature.type==="door"?"#8B4513":s.feature.type==="chest"?"#DAA520":"#ff4444",n.fillRect(l+4,o+4,L-8,L-8),n.fillStyle="#fff",n.font="12px monospace",n.textAlign="center",n.textBaseline="middle";const i=s.feature.type==="door"?"D":s.feature.type==="chest"?"C":"^";n.fillText(i,l+L/2,o+L/2),s.feature.type==="chest"&&s.feature.contents.length>0&&(n.fillStyle="#00ff88",n.beginPath(),n.arc(l+L-8,o+L-8,5,0,Math.PI*2),n.fill(),n.fillStyle="#000",n.font="bold 8px sans-serif",n.fillText(String(s.feature.contents.length),l+L-8,o+L-7))}s.items.length>0&&(n.fillStyle="#ffcc00",n.beginPath(),n.arc(l+L-6,o+6,4,0,Math.PI*2),n.fill()),n.strokeStyle="#ffffff22",n.strokeRect(l,o,L,L)}for(const r of $.characters){const a=r.position.x*L,s=r.position.y*L;n.fillStyle="#4488ff",n.beginPath(),n.arc(a+L/2,s+L/2,L/3,0,Math.PI*2),n.fill(),n.fillStyle="#fff",n.font="bold 10px sans-serif",n.textAlign="center",n.textBaseline="middle",n.fillText(r.name[0],a+L/2,s+L/2)}if($.selectedPosition){const{x:r,y:a}=$.selectedPosition;n.strokeStyle="#ffcc00",n.lineWidth=2,n.strokeRect(r*L,a*L,L,L),n.lineWidth=1}const e=fe;if(e){let r,a;if(e.type==="character"){const s=$.characters.find(l=>l.id===e.id);s&&(r=s.position.x,a=s.position.y)}else r=e.fromX,a=e.fromY;r!==void 0&&a!==void 0&&(n.strokeStyle="#00ff88",n.lineWidth=3,n.setLineDash([4,4]),n.strokeRect(r*L,a*L,L,L),n.setLineDash([]),n.lineWidth=1)}}window.editorRemoveFeature=(n,e)=>{$.tiles[e][n].feature=void 0,J(),ne(n,e),ce()};window.editorClearItems=(n,e)=>{$.tiles[e][n].items=[],J(),ne(n,e),ce()};window.editorRemoveItem=(n,e,r)=>{$.tiles[e][n].items.splice(r,1),J(),ne(n,e),ce()};window.editorRemoveChestItem=(n,e,r)=>{const a=$.tiles[e][n].feature;(a==null?void 0:a.type)==="chest"&&(a.contents.splice(r,1),J(),ne(n,e),ce())};window.editorRemoveCharacter=n=>{$.characters=$.characters.filter(r=>r.id!==n),J(),ce();const e=document.getElementById("properties-content");e&&(e.innerHTML='<p class="text-muted">Select a tile or entity to edit its properties.</p>')};window.editorMoveCharacter=n=>{fe={type:"character",id:n};const e=$.characters.find(r=>r.id===n);e&&ne(e.position.x,e.position.y),J()};window.editorMoveFeature=(n,e)=>{fe={type:"feature",fromX:n,fromY:e},ne(n,e),J()};window.editorMoveItem=(n,e,r)=>{fe={type:"item",fromX:n,fromY:e,index:r},ne(n,e),J()};window.editorMoveChestItem=(n,e,r)=>{fe={type:"chestItem",fromX:n,fromY:e,index:r},ne(n,e),J()};window.editorCancelMove=()=>{const n=$.selectedPosition;fe=null,J(),n&&ne(n.x,n.y)};window.editorAddFeature=(n,e,r)=>{r==="door"?$.tiles[e][n].feature=Ju({name:"Door",locked:!1}):r==="chest"&&($.tiles[e][n].feature=Vu({name:"Chest",contents:[]})),$.selectedPosition={x:n,y:e},J(),ne(n,e),ce()};window.editorShowAddItem=(n,e)=>{const r=document.getElementById("properties-content");if(!r)return;const a=nr();let s="<h4>Select Item to Add</h4>";s+='<div style="display: flex; flex-direction: column; gap: 0.25rem; max-height: 200px; overflow-y: auto;">';for(const l of a)s+=`<button class="btn-secondary" style="width: 100%; text-align: left;" onclick="window.editorAddItem(${n}, ${e}, '${l.id}')">`,s+=`${l.name} <span style="color: var(--text-secondary); font-size: 0.75rem;">(${l.type})</span>`,s+="</button>";s+="</div>",s+='<hr style="margin: 0.5rem 0; border-color: var(--border-color);">',s+=`<button class="btn-secondary" style="width: 100%;" onclick="window.editorShowNewItemForm(${n}, ${e})">+ Create New Item</button>`,s+=`<button class="btn-secondary" style="width: 100%; margin-top: 0.25rem;" onclick="window.editorCancelAddItem(${n}, ${e})">Cancel</button>`,r.innerHTML=s};window.editorAddItem=(n,e,r)=>{var i;const s=nr().find(c=>c.id===r);if(!s)return;const l={...s,id:Z()},o=$.tiles[e][n],u=((i=o.feature)==null?void 0:i.type)==="chest"?o.feature:null;u?u.contents.push(l):o.items.push(l),J(),ne(n,e),ce()};window.editorCancelAddItem=(n,e)=>{ne(n,e)};window.editorShowNewItemForm=(n,e)=>{Y={x:n,y:e},wt=null,document.getElementById("item-name").value="",document.getElementById("item-type").value="weapon",document.getElementById("item-damage").value="5",document.getElementById("item-armor").value="2";const r=document.getElementById("damage-group"),a=document.getElementById("armor-group"),s=document.getElementById("use-effect-group");r&&(r.style.display=""),a&&(a.style.display="none"),s&&(s.style.display="none"),pe=[];const l=document.getElementById("save-item-btn");l&&(l.textContent="Create Item");const o=document.getElementById("item-form-panel");o&&(o.style.display="")};window.editorShowAddCharacter=(n,e)=>{Y={x:n,y:e},bt=null,Ut(),Sa();const r=document.getElementById("character-form-panel"),a=document.getElementById("save-char-btn");a&&(a.textContent="Create Character"),r&&(r.style.display="")};let wt=null,bt=null;window.editorEditItem=(n,e,r,a)=>{var g;const s=$.tiles[e][n];let l;if(a==="ground"?l=s.items[r]:a==="chest"&&((g=s.feature)==null?void 0:g.type)==="chest"&&(l=s.feature.contents[r]),!l)return;wt={x:n,y:e,idx:r,location:a},Y={x:n,y:e},document.getElementById("item-name").value=l.name,document.getElementById("item-type").value=l.type,document.getElementById("item-damage").value=String(l.damage||5),document.getElementById("item-armor").value=String(l.armor||2);const o=document.getElementById("damage-group"),u=document.getElementById("armor-group"),i=document.getElementById("use-effect-group");if(o&&(o.style.display=l.type==="weapon"?"":"none"),u&&(u.style.display=l.type==="clothing"?"":"none"),i&&(i.style.display=l.type==="consumable"?"":"none"),l.type==="consumable"&&l.useEffect){const h=document.getElementById("item-use-effect-type");h.value=l.useEffect.type;const y=document.getElementById("use-effect-heal-group"),d=document.getElementById("use-effect-damage-group"),f=document.getElementById("use-effect-modify-stat-group"),p=document.getElementById("use-effect-message-group"),b=document.getElementById("use-effect-apply-group");if(y&&(y.style.display=l.useEffect.type==="heal"?"":"none"),d&&(d.style.display=l.useEffect.type==="damage"?"":"none"),f&&(f.style.display=l.useEffect.type==="modify_stat"?"":"none"),p&&(p.style.display=l.useEffect.type==="message"?"":"none"),b&&(b.style.display=l.useEffect.type==="apply_effect"?"":"none"),l.useEffect.type==="heal")document.getElementById("item-use-heal").value=String(l.useEffect.amount);else if(l.useEffect.type==="damage")document.getElementById("item-use-damage").value=String(l.useEffect.amount);else if(l.useEffect.type==="message")document.getElementById("item-use-message").value=l.useEffect.text;else if(l.useEffect.type==="apply_effect"){const w=l.useEffect.effect;document.getElementById("item-effect-name").value=w.name,document.getElementById("item-effect-duration").value=String(w.duration),document.getElementById("item-effect-prevents-movement").checked=!!w.preventsMovement,pe=w.triggers.map(M=>({on:M.on,actions:[...M.actions]})),lt()}}const c=document.getElementById("item-form-panel"),m=document.getElementById("save-item-btn");m&&(m.textContent="Save Item"),c&&(c.style.display="")};window.editorEditCharacter=n=>{var s,l;const e=$.characters.find(o=>o.id===n);if(!e)return;bt=n,Y={x:e.position.x,y:e.position.y},document.getElementById("char-name").value=e.name,document.getElementById("char-gender").value=e.gender,document.getElementById("char-hp").value=String(e.maxHp),document.getElementById("char-model").value=e.aiModel,document.getElementById("char-reasoning-effort").value=e.reasoningEffort,document.getElementById("char-prompt").value=e.personalityPrompt,Ee=e.inventory.map(o=>({...o})),ot=((s=e.equippedWeapon)==null?void 0:s.id)||null,it=((l=e.equippedClothing)==null?void 0:l.id)||null,Xe=e.effects.map(o=>({...o,triggers:o.triggers.map(u=>({...u,actions:[...u.actions]}))})),Zn(),tr(),er(),Sa();const r=document.getElementById("character-form-panel"),a=document.getElementById("save-char-btn");a&&(a.textContent="Save Character"),r&&(r.style.display="")};function Ql(){if(window.customWorld)return window.customWorld;if($.characters.length===0&&$.width===20&&$.height===15){const n=Yl();n&&($=n)}return $&&$.characters.length>0?Ca($):null}function nr(){return[{id:"sword",name:"Sword",type:"weapon",damage:5},{id:"shield",name:"Shield",type:"clothing",armor:3},{id:"potion",name:"Health Potion",type:"consumable",useEffect:{type:"heal",amount:10}},{id:"bear-trap",name:"Bear Trap",type:"trap",trapEffect:{id:Z(),name:"Trapped",duration:5,preventsMovement:!0,triggers:[{on:"turn_start",actions:[{type:"damage",amount:3}]},{on:"on_attack",actions:[{type:"modify_stat",stat:"attack",operation:"multiply",value:.5}]}]}},{id:"key",name:"Key",type:"key"},...zl]}let Pa=0,v,Ke,Zl,V=0,It=!1,ae=null,ke=!1,se=null,Ft=!1,eo=0,Ln=[],Aa=0;function to(n){switch(n){case"bloodsport":return os();case"prisoners-dilemma":return Qi();case"custom":const e=Ql();return e||(console.warn("No custom world found, falling back to town"),Xi());case"bear-traps-vs-hunters":default:return os()}}const no="ai-battlegrounds_selected_map";function ro(){const n=document.getElementById("map-select");return(n==null?void 0:n.value)||"town"}function mc(n){try{localStorage.setItem(no,n)}catch(e){console.warn("Failed to save map selection to localStorage",e)}}function pc(){try{const n=localStorage.getItem(no);if(n&&["bear-traps-vs-hunters","bloodsport","prisoners-dilemma","custom"].includes(n))return n}catch(n){console.warn("Failed to load map selection from localStorage",n)}return"bear-traps-vs-hunters"}function ps(){if(ae){clearInterval(ae),ae=null;const s=document.getElementById("auto-play-btn");s&&(s.textContent="Auto Play")}se=null;const n=document.getElementById("player-control-btn");n&&(n.textContent="Take Control",n.classList.remove("active")),ke=!1;const e=document.getElementById("speed-toggle-btn");e&&(e.textContent="âš¡ Fast Mode"),v=to(ro()),Aa=v.characters.length;for(const s of v.characters)s.mapMemory=new Map,Nn(v,s);V=0,It=!1,Ft=!1,eo=0,Pa=0,un=[],ut=[],ue=null,ao=new Map,Ln=[];const r=Gl(v);Ke.width=r.width,Ke.height=r.height;const a=document.getElementById("event-log");a&&(a.innerHTML=`
      <div class="log-entry">
        <div class="log-turn">Game Start</div>
        <div>Awaiting first turn...</div>
      </div>
    `),Ta(),be(),$e(),cn()}function H(n){const e={...n,order:eo++};v.events.push(e),bc(e),Ou(n.sound)}let un=[],ut=[],ue=null,ao=new Map;function hc(n){const e={...n,characters:n.characters.map(r=>({...r,mapMemory:Array.from(r.mapMemory.entries())}))};return JSON.stringify(e)}function gc(n){const e=JSON.parse(n);return{...e,characters:e.characters.map(r=>({...r,mapMemory:new Map(r.mapMemory)}))}}function Ta(){ut.push({turn:v.turn,characterIndex:V,world:hc(v),eventIndex:v.events.length})}function Ba(){return ue?gc(ue.world):v}function rr(n=v){return n.characters.filter(e=>e.alive)}async function so(){const n=v.activeContracts.filter(e=>e.expiryTurn===v.turn);for(const e of n){const r=v.activeContracts.indexOf(e);r>=0&&v.activeContracts.splice(r,1);const a=await Yi(e,v.events,v);qu(a.verdict);const s={turn:v.turn,actorId:"",description:`âš–ï¸ THE GREAT JUDGE speaks on the contract between ${e.issuerName} and ${e.targetName}: "${a.verdict}"`,message:a.verdict,judgePrompt:a.prompt,judgeResponse:a.rawResponse,witnessIds:v.characters.filter(l=>l.alive).map(l=>l.id)};H(s);for(const l of a.violators){const o=v.characters.find(u=>u.name.toLowerCase()===l.toLowerCase()&&u.alive);if(o){o.alive=!1,o.hp=0;const u={turn:v.turn,actorId:o.id,description:`ðŸ’€ ${o.name} is struck dead by divine judgment for violating the Blood Contract!`,witnessIds:v.characters.filter(c=>c.alive).map(c=>c.id)};H(u);const i=v.tiles[o.position.y][o.position.x];for(const c of o.inventory)i.items.push(c);o.inventory=[],o.equippedWeapon=void 0,o.equippedClothing=void 0}}}}function yc(){const n=rr();return n.length===0?null:n[V%n.length]}const wc={Kane:"#e63946",Razor:"#4361ee",Alice:"#e67e22",Bob:"#1abc9c",Charlie:"#e74c3c",Rex:"#e63946",Luna:"#9b59b6",Vex:"#27ae60",Nova:"#3498db"};function We(n,e,r="thinking"){const a=document.getElementById("thought-bubble"),s=document.getElementById("thought-avatar"),l=document.getElementById("thought-name"),o=document.getElementById("thought-content"),u=document.getElementById("thought-mode");if(r==="speaking"?(Rr(n.id),Ue(null)):(Ue(n.id),Rr(null)),be(),a&&s&&l&&o){const i=wc[n.name]??"#e8c84a";s.style.backgroundColor=i,s.textContent=n.name.charAt(0),l.textContent=n.name,l.style.color=i,r==="thinking"?(o.innerHTML=`<em>"${e}"</em>`,u&&(u.textContent="ðŸ’­"),a.classList.remove("speaking"),a.classList.add("thinking")):(o.innerHTML=`<strong>"${e}"</strong>`,u&&(u.textContent="ðŸ’¬"),a.classList.remove("thinking"),a.classList.add("speaking")),a.classList.remove("placeholder"),a.classList.add("visible"),a.style.borderColor=i}}function qe(){Rr(null),Ue(null),be();const n=document.getElementById("thought-bubble");n&&(n.classList.remove("visible"),n.classList.add("placeholder"))}function He(n){return new Promise(e=>setTimeout(e,n))}function $e(){var c;const n=Ba(),e=document.getElementById("turn-number"),r=document.getElementById("current-actor"),a=document.getElementById("character-panel");e&&(e.textContent=String(n.turn));const s=rr(n),l=ue?ue.characterIndex:V,o=s.length>0?s[l%s.length]:null;if(r&&(r.textContent=(o==null?void 0:o.name)??"â€”"),a&&o){const m=o.hp/o.maxHp,g=m>.6?"hp-good":m>.3?"hp-mid":"hp-low",h=o.effects.length>0?o.effects.map(y=>`<div class="effect-badge">
                  <strong>${y.name}</strong> (${y.duration} turns)
                  <div class="effect-details">${hs(y)}</div>
                </div>`).join(""):'<span class="text-muted">None</span>';a.innerHTML=`
      <div class="character-name">${o.name}</div>
      <div class="stat-row">
        <span class="stat-label">HP</span>
        <span class="${g}">${o.hp} / ${o.maxHp}</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Position</span>
        <span>(${o.position.x}, ${o.position.y})</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Model</span>
        <span>${o.aiModel}</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Reasoning</span>
        <span>${o.reasoningEffort}</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Weapon</span>
        <span>${((c=o.equippedWeapon)==null?void 0:c.name)??"None"}</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Inventory</span>
        <span>${o.inventory.length} items</span>
      </div>
      <div class="stat-row effects-row">
        <span class="stat-label">Effects</span>
        <div class="effects-list">${h}</div>
      </div>
    `}const u=document.getElementById("history-banner"),i=document.getElementById("history-turn");u&&i&&(ue?(u.classList.add("visible"),i.textContent=String(ue.turn)):u.classList.remove("visible"))}function lo(n){const e=parseInt(n.dataset.snapshotIndex??"0");document.querySelectorAll(".log-entry.selected").forEach(r=>r.classList.remove("selected")),n.classList.add("selected"),e>=ut.length-1?(ue=null,be(),$e()):vc(e)}function bc(n,e){un.push({type:"event",turn:n.turn,description:n.description,sequence:Pa++});const r=document.getElementById("event-log");if(!r)return;const a={search:"log-action",pickup:"log-item",drop:"log-item",equip:"log-item",use:"log-item",attack:"log-combat",miss:"log-combat",death:"log-death",trap:"log-combat",unlock:"log-action"},s=document.createElement("div");s.className="log-entry",s.dataset.eventIndex=String(v.events.length-1),s.dataset.snapshotIndex=String(ut.length-1);let l="";n.judgePrompt&&(l=`<div style="margin-top: 4px;"><a href="#" class="copy-judge-prompt" data-event-idx="${v.events.length-1}" style="font-size: 11px; color: var(--accent-blue);">ðŸ“‹ Copy Judge Prompt</a></div>`);const o=n.sound?a[n.sound]??"":"";s.innerHTML=`
    <div class="log-turn">Turn ${n.turn}</div>
    <div class="${o}">${n.description}</div>
    ${l}
  `,s.addEventListener("click",()=>lo(s));const u=s.querySelector(".copy-judge-prompt");for(u&&u.addEventListener("click",i=>{i.preventDefault(),i.stopPropagation();const c=parseInt(i.target.dataset.eventIdx||"0");Ec(c,i.target)}),ao.set(v.events.length-1,s),r.insertBefore(s,r.firstChild);r.children.length>100;)r.removeChild(r.lastChild)}function Fa(n,e,r,a,s,l){if(r&&a){const y={turn:v.turn,character:n.name,reasoning:e,fullPrompt:r,fullResponse:a,sequence:Pa++,errors:s&&s.length>0?s:void 0};Ln.push(y),un.push({type:"decision",decision:y})}if(!e)return;const o=document.getElementById("event-log");if(!o)return;const u=document.createElement("div");u.className="log-entry",u.dataset.snapshotIndex=String(ut.length-1);const i=s&&s.length>0?`<div style="color: #f66; font-size: 11px; margin-top: 4px;">âš  Errors: ${s.map(y=>wr(y)).join(", ")}</div>`:"",c=l?`
    <details style="margin-top: 8px; font-size: 11px;">
      <summary style="cursor: pointer; color: #9b59b6;">ðŸ§  Model's Internal Reasoning</summary>
      <div style="margin-top: 8px; padding: 8px; background: #1a1a2e; border-radius: 4px; white-space: pre-wrap; font-family: monospace; max-height: 200px; overflow-y: auto; color: #b39ddb; border-left: 3px solid #9b59b6;">
        ${wr(l)}
      </div>
    </details>
  `:"",m=Ln.length-1,g=r&&a?`<div style="margin-top: 4px;"><a href="#" class="copy-agent-prompt" data-decision-idx="${m}" style="font-size: 11px; color: #666;">ðŸ“‹ Copy full prompt/response</a></div>`:"";u.innerHTML=`
    <div class="log-turn" style="color: #666;">Turn ${v.turn} â€” ${n.name}'s thinking</div>
    <div style="color: #888; font-style: italic;">"${wr(e)}"</div>
    ${i}
    ${c}
    ${g}
  `;const h=u.querySelector(".copy-agent-prompt");h&&h.addEventListener("click",y=>{y.preventDefault(),y.stopPropagation();const d=parseInt(y.target.dataset.decisionIdx||"0");Ic(d,y.target)}),u.addEventListener("click",y=>{y.target.closest(".copy-agent-prompt")||lo(u)}),o.insertBefore(u,o.firstChild)}function wr(n){return n.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function vc(n){n>=0&&n<ut.length&&(ue=ut[n],be(),$e(),Da())}function oo(){ue=null,document.querySelectorAll(".log-entry.selected").forEach(n=>n.classList.remove("selected")),be(),$e(),Da()}let xn=null;function io(){if(xn!==null)return;const n=()=>{const e=xu();be(),e?xn=requestAnimationFrame(n):xn=null};xn=requestAnimationFrame(n)}async function br(){return io(),new Promise(n=>{const e=()=>{Eu()?requestAnimationFrame(e):n()};requestAnimationFrame(e)})}function be(){const n=Ba(),e=rr(n),r=ue?ue.characterIndex:V,a=e.length>0?e[r%e.length]:void 0,s=a&&!ue?Wr(n,a):void 0,l=a&&!ue?On(n,a).tiles.map(o=>o.position):void 0;Du(Zl,n,a,s,l,a==null?void 0:a.id)}function _c(n){const e=Ke.getBoundingClientRect(),r=n.clientX-e.left,a=n.clientY-e.top,s=Ru(r,a);if(Ft&&Pe){Dc(s.x,s.y);return}const l=Ba();Mc(l,s)}function Mc(n,e){var c,m,g,h,y;const r=document.getElementById("inspector-panel"),a=document.getElementById("inspector-title"),s=document.getElementById("inspector-content");if(!r||!a||!s)return;const l=(c=n.tiles[e.y])==null?void 0:c[e.x];if(!l)return;const o=n.characters.find(d=>d.position.x===e.x&&d.position.y===e.y),u=n.rooms.find(d=>l.roomId===d.id);let i=`<div class="stat-row"><span class="stat-label">Position</span><span>(${e.x}, ${e.y})</span></div>`;if(i+=`<div class="stat-row"><span class="stat-label">Tile</span><span>${l.type}</span></div>`,u&&(i+=`<div class="stat-row"><span class="stat-label">Room</span><span>${u.name}</span></div>`),l.items.length>0){i+='<div style="margin-top: 0.5rem; font-weight: 600;">Items:</div><div class="item-list">';for(const d of l.items)i+=`<div class="item-entry">â€¢ ${d.name} (${d.type})`,d.damage&&(i+=` [dmg: ${d.damage}]`),d.armor&&(i+=` [armor: ${d.armor}]`),i+="</div>";i+="</div>"}if(((m=l.feature)==null?void 0:m.type)==="chest"){if(i+='<div style="margin-top: 0.5rem; font-weight: 600;">Chest:</div>',i+=`<div class="item-entry">â€¢ ${l.feature.name}`,i+=l.feature.searched?" (searched)":" (not searched)",l.feature.contents.length>0){i+='<div style="margin-left: 1rem;">';for(const d of l.feature.contents){if(i+=`<div class="item-entry">â†³ ${d.name}`,d.damage&&(i+=` [dmg: ${d.damage}]`),d.armor&&(i+=` [armor: ${d.armor}]`),d.useEffect)switch(d.useEffect.type){case"heal":i+=` [heals ${d.useEffect.amount}]`;break;case"damage":i+=` [dmg: ${d.useEffect.amount}]`;break;case"apply_effect":i+=` [applies ${d.useEffect.effect.name}]`;break}i+="</div>"}i+="</div>"}else l.feature.searched&&(i+='<div style="margin-left: 1rem; opacity: 0.6;">(empty)</div>');i+="</div>"}if(((g=l.feature)==null?void 0:g.type)==="door"&&(i+='<div style="margin-top: 0.5rem; font-weight: 600;">Door:</div>',i+=`<div class="item-entry">â€¢ ${l.feature.name}`,l.feature.locked&&(i+=" (locked)"),l.feature.open&&(i+=" (open)"),i+="</div>"),o){const d=o.hp/o.maxHp,f=d>.6?"hp-good":d>.3?"hp-mid":"hp-low";if(a.textContent=o.name,i=`
      <div class="stat-row"><span class="stat-label">Gender</span><span>${o.gender}</span></div>
      <div class="stat-row"><span class="stat-label">Status</span><span>${o.alive?"Alive":"Dead"}</span></div>
      <div class="stat-row"><span class="stat-label">HP</span><span class="${f}">${o.hp}/${o.maxHp}</span></div>
      <div class="stat-row"><span class="stat-label">Position</span><span>(${e.x}, ${e.y})</span></div>
      <div class="stat-row"><span class="stat-label">Model</span><span>${o.aiModel}</span></div>
      <div class="stat-row"><span class="stat-label">Reasoning</span><span>${o.reasoningEffort}</span></div>
      <div class="stat-row"><span class="stat-label">Weapon</span><span>${((h=o.equippedWeapon)==null?void 0:h.name)??"None"}</span></div>
      <div class="stat-row"><span class="stat-label">Armor</span><span>${((y=o.equippedClothing)==null?void 0:y.name)??"None"}</span></div>
    `,o.inventory.length>0){i+='<div style="margin-top: 0.5rem; font-weight: 600;">Inventory:</div><div class="item-list">';for(const b of o.inventory)i+=`<div class="item-entry">â€¢ ${b.name}</div>`;i+="</div>"}const p=v.events.filter(b=>b.witnessIds.includes(o.id));if(p.length>0){i+='<div style="margin-top: 0.5rem; font-weight: 600;">Memories:</div>';for(const b of p)i+=`<div class="memory-item"><span class="memory-turn">[Turn ${b.turn}]</span> ${b.description}</div>`}if(l.items.length>0){i+='<div style="margin-top: 0.5rem; border-top: 1px solid var(--border-color); padding-top: 0.5rem;"><span style="font-weight: 600;">On this tile:</span></div><div class="item-list">';for(const b of l.items)i+=`<div class="item-entry">â€¢ ${b.name} (${b.type})`,b.damage&&(i+=` [dmg: ${b.damage}]`),b.armor&&(i+=` [armor: ${b.armor}]`),i+="</div>";i+="</div>"}}else a.textContent=`Tile (${e.x}, ${e.y})`;s.innerHTML=i,r.style.display="block"}function Da(){const n=document.getElementById("inspector-panel");n&&(n.style.display="none")}function kc(){const n=document.getElementById("contracts-panel");n&&(n.style.display==="none"?($c(),n.style.display="block"):n.style.display="none")}function xc(){const n=document.getElementById("contracts-panel");n&&(n.style.display="none")}function Ec(n,e){const r=v.events[n];if(!r||!r.judgePrompt)return;let a=`PROMPT:
${r.judgePrompt}`;r.judgeResponse&&(a+=`

RESPONSE:
${r.judgeResponse}`),navigator.clipboard.writeText(a).then(()=>{const s=e.textContent;e.textContent="âœ“ Copied!",setTimeout(()=>{e.textContent=s},1500)})}function Ic(n,e){const r=Ln[n];if(!r)return;const a=`PROMPT:
${r.fullPrompt}

RESPONSE:
${r.fullResponse}`;navigator.clipboard.writeText(a).then(()=>{const s=e.textContent;e.textContent="âœ“ Copied!",setTimeout(()=>{e.textContent=s},1500)})}function $c(){const n=document.getElementById("contracts-content");if(!n)return;if(v.activeContracts.length===0){n.innerHTML='<p style="color: var(--text-secondary);">No active blood contracts.</p>';return}const e=v.activeContracts.map(r=>{const a=r.expiryTurn-v.turn;return`
        <div style="padding: 0.5rem; margin-bottom: 0.5rem; background: var(--bg-tertiary); border-radius: 4px; border-left: 3px solid var(--accent-red);">
          <div style="font-weight: bold;">${r.issuerName} â†” ${r.targetName}</div>
          <div style="font-size: 0.8rem; margin: 0.25rem 0;">"${r.contents}"</div>
          <div style="font-size: 0.7rem; color: var(--text-secondary);">
            ${a>0?`${a} turns remaining (expires turn ${r.expiryTurn})`:"âš ï¸ EXPIRING THIS TURN"}
          </div>
        </div>
      `}).join("");n.innerHTML=e}function Cc(n,e,r){return new Promise(a=>{const s=document.getElementById("player-actions-panel");if(!s){a(null);return}s.style.display="block",s.innerHTML=`
      <h3 style="margin: 0 0 0.5rem 0;">ðŸ’¬ Respond to ${e.name}</h3>
      <p style="font-size: 0.8rem; margin-bottom: 0.5rem;">"${r}"</p>
      <input type="text" id="convo-response" placeholder="Your response..." style="width: 100%; margin-bottom: 0.5rem;">
      <div style="display: flex; gap: 0.5rem;">
        <button class="action-btn" id="convo-reply-btn">Reply</button>
        <button class="action-btn" id="convo-end-btn" style="background: var(--bg-tertiary);">End Conversation</button>
      </div>
    `;const l=document.getElementById("convo-response"),o=document.getElementById("convo-reply-btn"),u=document.getElementById("convo-end-btn"),i=()=>{const m=l.value.trim();s.style.display="none",a(m||null)},c=()=>{s.style.display="none",a(null)};o==null||o.addEventListener("click",i),u==null||u.addEventListener("click",c),l==null||l.addEventListener("keypress",m=>{m.key==="Enter"&&i()}),l==null||l.focus()})}async function uo(n,e,r){let s=e,l=n,o=r,u=0;for(;u<1&&s.alive&&l.alive;){let i=null;if(s.name===se){if(i=await Cc(s,l,o),!i)break}else{Ue(s.id),be();const{wantsToRespond:c,thought:m,message:g,fullPrompt:h,fullResponse:y}=await Ki(v,s,l.name,o);if(Ue(null),m&&(We(s,m),ke||await He(1500),qe()),Fa(s,m,h,y),!c||!g)break;i=g}We(s,i,"speaking"),Ct(i,s),ke||await He(2500),qe(),H({turn:v.turn,actorId:s.id,targetId:l.id,message:i,description:`${s.name} responds to ${l.name}: "${i.replace(/\n/g," ")}"`,witnessIds:R(v,[s.position,l.position])}),o=i,[s,l]=[l,s],u++}}function Sc(n,e,r,a){return new Promise(s=>{const l=document.getElementById("player-actions-panel");if(!l){s({signed:!1});return}l.style.display="block",l.innerHTML=`
      <h3 style="margin: 0 0 0.5rem 0;">ðŸ©¸ Blood Contract Offer</h3>
      <p style="font-size: 0.8rem;"><strong>From ${n.name}:</strong></p>
      ${a?`<p style="font-size: 0.9rem; font-style: italic; margin: 0.5rem 0;">"${a}"</p>`:""}
      <p style="font-size: 0.9rem; margin: 0.5rem 0; padding: 0.5rem; background: var(--bg-tertiary); border-radius: 4px;"><strong>Terms:</strong> "${e}"</p>
      <p style="font-size: 0.7rem; color: var(--text-secondary);">Duration: ${r} turns (expires turn ${v.turn+r})</p>
      <p style="font-size: 0.7rem; color: var(--accent-red);">âš ï¸ Violating the terms = DEATH</p>
      <input type="text" id="contract-response" placeholder="Optional message..." style="width: 100%; margin-bottom: 0.5rem;">
      <div style="display: flex; gap: 0.5rem;">
        <button class="action-btn" id="contract-sign-btn" style="background: var(--accent-green);">âœ“ Sign</button>
        <button class="action-btn" id="contract-decline-btn" style="background: var(--accent-red);">âœ— Decline</button>
      </div>
    `;const o=document.getElementById("contract-response"),u=document.getElementById("contract-sign-btn"),i=document.getElementById("contract-decline-btn");u==null||u.addEventListener("click",()=>{const c=o.value.trim()||void 0;l.style.display="none",s({signed:!0,response:c})}),i==null||i.addEventListener("click",()=>{const c=o.value.trim()||void 0;l.style.display="none",s({signed:!1,response:c})})})}async function co(n,e,r,a,s){if(e.name===se){const o=await Sc(n,r,a,s);return o.response&&(We(e,o.response,"speaking"),Ct(o.response,e),ke||await He(2500),qe()),o}Ue(e.id),be();const l=await Vi(v,e,n.name,r,a,s);return Ue(null),l.thought&&(We(e,l.thought),ke||await He(1500),qe()),Fa(e,l.thought,l.fullPrompt,l.fullResponse),l.message&&(We(e,l.message,"speaking"),Ct(l.message,e),ke||await He(2500),qe()),{signed:l.signed,response:l.message||void 0}}async function fo(){if(It)return;if(ue){oo();return}const n=yc();if(!n){console.log("No living characters remaining"),ae&&(clearInterval(ae),ae=null,Tn());return}if(n.name===se){ae&&(clearInterval(ae),ae=null,Tn()),Dt();return}It=!0,vr(!0),Ta();try{const{events:e,pendingCustomActions:r}=ho(n,"turn_start",v);for(const w of e)H(w);for(const w of r){const M=v.characters.find(x=>x.id===w.characterId);if(M){const x=await ls(v,M,w.prompt,v.events);console.log(`Custom effect "${w.effectName}" result:`,x.reasoning);for(const E of x.actions)if(E.type==="kill"){const _=v.characters.find(I=>I.name.toLowerCase()===E.targetName.toLowerCase());if(_&&_.alive){_.hp=0,_.alive=!1;const I=v.tiles[_.position.y][_.position.x];for(const B of _.inventory)I.items.push(B);if(_.inventory.length>0){const B=_.inventory.map(A=>A.name).join(", "),k={turn:v.turn,sound:"drop",actorId:_.id,position:_.position,description:`${_.name}'s items fell to the ground: ${B}`,witnessIds:R(v,[_.position])};H(k)}_.inventory=[],_.equippedWeapon=void 0,_.equippedClothing=void 0;const C={turn:v.turn,sound:"death",actorId:_.id,description:`${_.name} was killed by the ${w.effectName} effect! (${x.reasoning})`,witnessIds:R(v,[_.position])};H(C)}}}}const a=go(n);for(const w of a){for(const x of w.triggers)if(x.on==="on_expired")for(const E of x.actions){const _=Nr(E,n,v,w.name);for(const I of _.events)H(I);if(_.pendingCustom){const I=await ls(v,n,_.pendingCustom.prompt,v.events);for(const C of I.actions)if(C.type==="kill"){const B=v.characters.find(k=>k.name.toLowerCase()===C.targetName.toLowerCase());B&&B.alive&&(B.hp=0,B.alive=!1,H({turn:v.turn,sound:"death",actorId:B.id,description:`${B.name} was killed by ${w.name}! (${I.reasoning})`,witnessIds:R(v,[B.position])}))}}}const M={turn:v.turn,actorId:n.id,description:`${n.name} is no longer affected by ${w.name}!`,witnessIds:R(v,[n.position])};H(M)}const s=Kt(v,n,{type:"look_around"});for(const w of s.events)H(w);let l=!1,o=!1,u=0;const i=1;let c=0;const m=2;let g=!1,h=0;const y=3;let d=0;const f=2,p=[];for(;!g&&n.alive&&h<y;){Ue(n.id),be();const{action:w,reasoning:M,reasoningSummary:x,fullPrompt:E,fullResponse:_,error:I}=await Ji(v,n,p);if(Ue(null),M&&(We(n,M),ke||await He(2500),qe()),Fa(n,M,E,_,I?[I]:void 0,x),I){if(d++,d<=f){_&&p.push({response:_,result:`ERROR: ${I}`});continue}const k={turn:v.turn,actorId:n.id,description:`${n.name}: turn ended due to repeated errors`,witnessIds:R(v,[n.position])};H(k);break}if(w.type==="move"&&o){_&&p.push({response:_,result:"REJECTED: Already moved this turn"});const k={turn:v.turn,actorId:n.id,description:`${n.name}: move (REJECTED - already moved this turn)`,witnessIds:R(v,[n.position])};H(k);continue}if(w.type==="equip"&&(l=!0),w.type==="attack"&&l){const k={turn:v.turn,actorId:n.id,description:`${n.name} cannot attack after equipping this turn`,witnessIds:R(v,[n.position])};H(k),g=!0;continue}const C=Kt(v,n,w);if(C.animationData){if(C.animationData.type==="move"&&C.animationData.path)io(),await ku(n.id,C.animationData.path);else if(C.animationData.type==="attack"&&C.animationData.targetPosition){const k=C.animationData.targetPosition;C.animationData.missed?_n(k.x,k.y,"MISS","#ffffff"):_n(k.x,k.y,`-${C.animationData.damage}`,"#ff4444"),await br()}else if(C.animationData.type==="pickup"&&C.animationData.targetPosition){const k=C.animationData.targetPosition,A=C.animationData.itemName??"item";_n(k.x,k.y,`+${A}`,"#4ade80"),await br()}else if(C.animationData.type==="place"&&C.animationData.targetPosition){const k=C.animationData.targetPosition,A=C.animationData.itemName??"item";_n(k.x,k.y,`-${A}`,"#facc15"),await br()}}for(const k of C.events)H(k);if(C.events.length===0&&w.type!=="look_around"){const k={turn:v.turn,actorId:n.id,description:`${n.name}: ${w.type}${C.success?"":` (failed: ${C.message})`}`,witnessIds:R(v,[n.position])};H(k)}if(w.type!=="look_around"&&_){const k=C.success?C.message:`FAILED: ${C.message}`;p.push({response:_,result:k}),C.success&&h++}if(w.type==="move"||w.type==="move_toward")if(C.success){if(o=!0,n.effects.some(k=>k.preventsMovement)){p[p.length-1].result+=" (TRAPPED!)";continue}}else continue;if(!(["search_container","pick_up","equip","drop","place","unequip"].includes(w.type)&&!C.success)){if(w.type==="talk"&&C.success&&w.message){if(u>=i)continue;We(n,w.message,"speaking"),Ct(w.message,n),ke||await He(2500),qe();const k=v.characters.find(A=>A.id===w.targetCharacterId);k&&k.alive&&await uo(n,k,w.message),u++}else if(w.type==="talk"&&!C.success)continue;if(w.type==="issue_contract"&&C.success){if(c>=m)continue;const k=v.characters.find(A=>A.id===w.targetCharacterId);if(k&&k.alive&&w.contractContents&&w.contractExpiry){w.message&&(We(n,w.message,"speaking"),Ct(w.message,n),ke||await He(2500),qe());const{signed:A,response:U}=await co(n,k,w.contractContents,w.contractExpiry,w.message);if(A){const W={id:crypto.randomUUID(),issuerId:n.id,issuerName:n.name,targetId:k.id,targetName:k.name,contents:w.contractContents,expiryTurn:v.turn+w.contractExpiry,signed:!0,createdTurn:v.turn};v.activeContracts.push(W);const he={id:crypto.randomUUID(),name:`Contract with ${k.name}`,type:"contract",contract:W},Ge={id:crypto.randomUUID(),name:`Contract with ${n.name}`,type:"contract",contract:W};n.inventory.push(he),k.inventory.push(Ge);const ar={turn:v.turn,actorId:k.id,targetId:n.id,message:w.contractContents,description:`ðŸ©¸ ${k.name} signed the Blood Contract with ${n.name}: "${w.contractContents}" (expires turn ${W.expiryTurn})`,witnessIds:[k.id,n.id]};H(ar),p.push({response:`CONTRACT ${k.name}: "${w.contractContents}"`,result:`âœ… ${k.name} SIGNED the contract`})}else{const W={turn:v.turn,actorId:k.id,targetId:n.id,message:U||"declined",description:`${k.name} declined the Blood Contract${U?`: "${U}"`:""}`,witnessIds:R(v,[k.position,n.position])};H(W),p.push({response:`CONTRACT ${k.name}: "${w.contractContents}"`,result:`âŒ ${k.name} DECLINED${U?`: "${U}"`:""}`})}}c++}else if(w.type==="issue_contract"&&!C.success)continue;if(w.type==="attack")if(C.success)g=!0;else continue;w.type==="wait"&&(g=!0),n.alive||(g=!0)}}V++;const b=rr();if(b.length<=1&&Aa>1){const w=b[0],M={turn:v.turn,sound:"death",actorId:(w==null?void 0:w.id)??"",description:w?`ðŸ† GAME OVER! ${w.name} is the last one standing!`:"ðŸ’€ GAME OVER! Everyone is dead!",witnessIds:v.characters.filter(E=>E.alive).map(E=>E.id)};H(M),ae&&(clearInterval(ae),ae=null,Tn()),be(),$e(),vr(!1);const x=document.getElementById("next-turn-btn");x&&(x.textContent="Game Over",x.disabled=!0),Wc((w==null?void 0:w.name)??null),qc();return}V>=b.length&&(V=0,v.turn++,await so()),be(),$e()}catch(e){console.error("Error processing turn:",e)}finally{It=!1,vr(!1)}}function vr(n){const e=document.getElementById("next-turn-btn");e&&(e.disabled=n,e.textContent=n?"Thinking...":"Next Turn")}function Tn(){const n=document.getElementById("auto-play-btn");n&&(n.textContent=ae?"Stop":"Auto Play")}function Pc(){ae?(clearInterval(ae),ae=null):ae=window.setInterval(()=>{!It&&!ue&&fo()},500),Tn()}function Ac(){ke=!ke;const n=document.getElementById("speed-toggle-btn");n&&(n.textContent=ke?"ðŸ‡ Fast":"ðŸ¢ Slow")}function Tc(){const n=document.getElementById("player-control-btn"),e=v.characters.filter(r=>r.alive);if(se)se=null,n&&(n.textContent="ðŸŽ® Watch"),cn();else{const r=e[0];r&&(se=r.name,n&&(n.textContent=`ðŸŽ® ${r.name}`),Ra())}}function Bc(){const n=v.characters.filter(s=>s.alive);if(n.length===0)return;const r=(n.findIndex(s=>s.name===se)+1)%n.length;se=n[r].name;const a=document.getElementById("player-control-btn");a&&(a.textContent=`ðŸŽ® ${se}`),Ra()}function Dt(){const n=document.getElementById("player-actions");n&&(n.style.display="block"),Ft=!0,Ra()}function cn(){const n=document.getElementById("player-actions");n&&(n.style.display="none"),Ft=!1,document.querySelectorAll(".action-btn").forEach(r=>{r.classList.remove("selected")});const e=document.getElementById("action-details");e&&(e.innerHTML="")}let Pe=null;function Ra(){const n=v.characters[V];if(!n||n.name!==se){cn();return}Dt()}function Fc(n){Pe=n,document.querySelectorAll(".action-btn").forEach(a=>{a.classList.remove("selected"),a.dataset.action===n&&a.classList.add("selected")});const e=document.getElementById("action-details");if(!e)return;const r=v.characters[V];if(r)switch(n){case"move":e.innerHTML="<p>Click a tile to move there</p>";break;case"attack":const a=v.characters.filter(m=>m.alive&&m.id!==r.id&&Math.abs(m.position.x-r.position.x)+Math.abs(m.position.y-r.position.y)===1);a.length===0?e.innerHTML="<p>No adjacent targets</p>":e.innerHTML=a.map(m=>`<button class="action-btn" onclick="window.executePlayerAction('attack', '${m.name}')">${m.name}</button>`).join(" ");break;case"talk":const s=v.characters.filter(m=>m.alive&&m.id!==r.id&&Ye(r.position,m.position)<=Ne);s.length===0?e.innerHTML=`<p>No one within ${Ne} tiles</p>`:e.innerHTML=`
          <select id="talk-target">${s.map(m=>`<option value="${m.name}">${m.name}</option>`).join("")}</select>
          <input type="text" id="talk-message" placeholder="Message..." style="width: 100%;">
          <button class="action-btn" onclick="window.executePlayerTalk()">Send</button>
        `;break;case"search":e.innerHTML="<p>Click an adjacent container to search</p>";break;case"pickup":e.innerHTML="<p>Click an adjacent item to pick up</p>";break;case"equip":const l=r.inventory.filter(m=>m.type==="weapon");l.length===0?e.innerHTML="<p>No weapons in inventory</p>":e.innerHTML=l.map(m=>`<button class="action-btn" onclick="window.executePlayerAction('equip', '${m.name}')">${m.name}</button>`).join(" ");break;case"drop":r.inventory.length===0?e.innerHTML="<p>No items in inventory</p>":e.innerHTML=r.inventory.map(m=>`<button class="action-btn" onclick="window.executePlayerAction('drop', '${m.name}')">${m.name}</button>`).join(" ");break;case"use":const o=r.inventory.filter(m=>m.useEffect);o.length===0?e.innerHTML="<p>No usable items in inventory</p>":e.innerHTML=o.map(m=>{let g="";const h=m.useEffect;if(h)switch(h.type){case"heal":g=` (heals ${h.amount})`;break;case"damage":g=` (${h.amount} dmg)`;break;case"apply_effect":g=` (${h.effect.name})`;break;case"message":g=` (${h.text})`;break}return`<button class="action-btn" onclick="window.executePlayerAction('use', '${m.name}')">${m.name}${g}</button>`}).join(" ");break;case"place":const u=r.inventory.filter(m=>m.type==="trap");u.length===0?e.innerHTML="<p>No traps in inventory</p>":e.innerHTML=`<p>Click an adjacent tile to place: ${u.map(m=>m.name).join(", ")}</p>`;break;case"contract":const c=v.characters.filter(m=>m.alive&&m.id!==r.id).filter(m=>Ye(r.position,m.position)<=Ne);c.length===0?e.innerHTML="<p>No characters within 4 tiles to contract with</p>":e.innerHTML=`
          <p>Offer Blood Contract:</p>
          <select id="contract-target">${c.map(m=>`<option value="${m.name}">${m.name} (${Math.round(Ye(r.position,m.position))} tiles)</option>`).join("")}</select>
          <input type="text" id="contract-pitch" placeholder="Your pitch (optional)" style="width: 100%;">
          <input type="number" id="contract-expiry" placeholder="Expiry (1-20 turns)" min="1" max="20" value="10" style="width: 100%;">
          <input type="text" id="contract-terms" placeholder="Terms, e.g. 'Neither attacks the other'" style="width: 100%;">
          <button class="action-btn" onclick="window.executePlayerContract()">Offer Contract</button>
        `;break;case"sign":e.innerHTML="<p>Signing happens automatically when someone offers you a contract.</p>";break;case"wait":e.innerHTML=`<button class="action-btn" onclick="window.executePlayerAction('wait')">End Turn</button>`;break;default:e.innerHTML=""}}async function Dc(n,e){var s,l,o,u;if(!Ft||!Pe)return;const r=v.characters[V];if(!r||r.name!==se)return;let a=null;if(Pe==="move")a={type:"move",targetPosition:{x:n,y:e}};else if(Pe==="search"){const i=(s=v.tiles[e])==null?void 0:s[n];((l=i==null?void 0:i.feature)==null?void 0:l.type)==="chest"&&(a={type:"search_container",targetFeatureId:i.feature.id})}else if(Pe==="pickup"){const i=(o=v.tiles[e])==null?void 0:o[n];if(i){const c=i.items[0];if(c)a={type:"pick_up",targetItemName:c.name};else if(((u=i.feature)==null?void 0:u.type)==="chest"&&i.feature.searched){const m=i.feature.contents[0];m&&(a={type:"pick_up",targetItemName:m.name})}}}else if(Pe==="place"){const i=r.inventory.find(c=>c.type==="trap");i&&(a={type:"place",targetPosition:{x:n,y:e},targetItemId:i.id})}a&&await mo(a)}async function mo(n,e){const r=v.characters[V];if(!r)return;let a;if(typeof n=="string")switch(n){case"attack":const l=v.characters.find(c=>c.name===e);if(!l)return;a={type:"attack",targetCharacterId:l.id};break;case"equip":const o=r.inventory.find(c=>c.name===e);if(!o)return;a={type:"equip",targetItemId:o.id};break;case"drop":const u=r.inventory.find(c=>c.name===e);if(!u)return;a={type:"drop",targetItemId:u.id};break;case"use":const i=r.inventory.find(c=>c.name===e);if(!i)return;a={type:"use",targetItemId:i.id};break;case"sign":a={type:"sign_contract"};break;case"wait":a={type:"wait"};break;default:return}else a=n;const s=Kt(v,r,a);for(const l of s.events)H(l);if(!s.success){const l=document.getElementById("action-details");l&&(l.innerHTML=`<p style="color: var(--accent-red);">âš ï¸ ${s.message}</p>`),Pe=null,$e();return}cn(),Ft=!1,s.animationData&&be(),$e(),a.type==="wait"||a.type==="attack"?await Lc():(Dt(),Pe=null)}async function Rc(){if(!se)return;const n=v.characters.find(i=>i.name===se);if(!n||!n.alive)return;const e=document.getElementById("talk-target"),r=document.getElementById("talk-message");if(!e||!r)return;const a=e.value,s=r.value,l=v.characters.find(i=>i.name===a);if(!l||!s)return;const o={type:"talk",targetCharacterId:l.id,message:s},u=Kt(v,n,o);for(const i of u.events)H(i);if(u.success)We(n,s,"speaking"),Ct(s,n),ke||await He(2500),qe(),l.alive&&await uo(n,l,s),Dt(),Pe=null;else{const i=document.getElementById("action-details");i&&(i.innerHTML+=`<p style="color: var(--accent-red);">âš ï¸ ${u.message}</p>`)}$e()}async function Lc(){for(V++;V<v.characters.length&&!v.characters[V].alive;)V++;if(V>=v.characters.length)for(v.turn++,await so(),V=0;V<v.characters.length&&!v.characters[V].alive;)V++;$e();const n=v.characters[V];n&&n.name===se&&n.alive&&Dt()}async function Oc(){if(!se)return;const n=v.characters.find(h=>h.name===se);if(!n||!n.alive)return;const e=document.getElementById("contract-target"),r=document.getElementById("contract-expiry"),a=document.getElementById("contract-terms"),s=document.getElementById("contract-pitch");if(!e||!r||!a)return;const l=e.value,o=parseInt(r.value,10),u=a.value,i=(s==null?void 0:s.value)||void 0;if(!u){const h=document.getElementById("action-details");h&&(h.innerHTML+='<p style="color: var(--accent-red);">âš ï¸ Enter contract terms first</p>');return}const c=v.characters.find(h=>h.name===l);if(!c)return;const m={type:"issue_contract",targetCharacterId:c.id,contractContents:u,contractExpiry:o,message:i},g=Kt(v,n,m);for(const h of g.events)H(h);if(g.success){const{signed:h,response:y}=await co(n,c,u,o,i);if(h){const d={id:crypto.randomUUID(),issuerId:n.id,issuerName:n.name,targetId:c.id,targetName:c.name,contents:u,expiryTurn:v.turn+o,signed:!0,createdTurn:v.turn};v.activeContracts.push(d);const f={id:crypto.randomUUID(),name:`Contract with ${c.name}`,type:"contract",contract:d},p={id:crypto.randomUUID(),name:`Contract with ${n.name}`,type:"contract",contract:d};n.inventory.push(f),c.inventory.push(p);const b={turn:v.turn,actorId:c.id,targetId:n.id,message:u,description:`ðŸ©¸ ${c.name} signed the Blood Contract with ${n.name}: "${u}" (expires turn ${d.expiryTurn})`,witnessIds:[c.id,n.id]};H(b)}else{const d={turn:v.turn,actorId:c.id,targetId:n.id,message:y||"declined",description:`${c.name} declined the Blood Contract${y?`: "${y}"`:""}`,witnessIds:[c.id,n.id]};H(d)}Dt(),Pe=null}else{const h=document.getElementById("action-details");h&&(h.innerHTML+=`<p style="color: var(--accent-red);">âš ï¸ ${g.message}</p>`)}$e()}window.executePlayerAction=mo;window.executePlayerTalk=Rc;window.executePlayerContract=Oc;function Nc(){var r;const n=[];n.push("=".repeat(80)),n.push("AI BATTLEGROUNDS GAME LOG EXPORT"),n.push(`Exported at: ${new Date().toISOString()}`),n.push(`Current Turn: ${v.turn}`),n.push("=".repeat(80)),n.push(""),n.push("WORLD STATE:"),n.push("-".repeat(40));for(const a of v.characters){const s=a.alive?`HP: ${a.hp}/${a.maxHp}`:"DEAD",l=((r=a.equippedWeapon)==null?void 0:r.name)??"Unarmed";n.push(`  ${a.name}: ${s}, Weapon: ${l}, Position: (${a.position.x}, ${a.position.y})`)}n.push(""),n.push("CHRONOLOGICAL LOG:"),n.push("-".repeat(40));for(const a of un)if(a.type==="event")n.push(`[Turn ${a.turn}] ${a.description}`);else{const s=a.decision;if(n.push(""),n.push("=".repeat(60)),n.push(`AGENT DECISION: Turn ${s.turn} - ${s.character}`),n.push("=".repeat(60)),n.push(`Reasoning: "${s.reasoning}"`),n.push(""),n.push("--- FULL PROMPT ---"),n.push(s.fullPrompt),n.push(""),n.push("--- FULL RESPONSE ---"),n.push(s.fullResponse),s.errors&&s.errors.length>0){n.push(""),n.push("--- ERRORS ---");for(const l of s.errors)n.push(`âš ï¸ ${l}`)}n.push("=".repeat(60)),n.push("")}const e=n.join(`
`);navigator.clipboard.writeText(e).then(()=>{const a=document.getElementById("export-logs-btn");if(a){const s=a.textContent;a.textContent="âœ“ Copied!",setTimeout(()=>{a.textContent=s},2e3)}}).catch(a=>{console.error("Failed to copy logs:",a),alert("Failed to copy to clipboard. Check console for the full log."),console.log(e)})}function Wc(n){var r;const e=document.createElement("div");e.id="game-over-banner",e.setAttribute("role","alert"),e.setAttribute("aria-live","assertive"),e.style.cssText=`
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    border: 3px solid #ffcc44;
    padding: 2rem 3rem;
    border-radius: 12px;
    z-index: 1000;
    text-align: center;
    box-shadow: 0 0 50px rgba(255, 204, 68, 0.3);
  `,e.innerHTML=`
    <h2 style="font-family: 'Press Start 2P', cursive; font-size: 1.5rem; color: #ffcc44; margin-bottom: 1rem;">
      ðŸ† GAME OVER ðŸ†
    </h2>
    <p style="font-size: 1.2rem; color: #e8e8f0; margin-bottom: 0.5rem;">
      ${n?`${n} is the last one standing!`:"Everyone is dead!"}
    </p>
    <p style="font-size: 0.9rem; color: #8888a0; margin-top: 1rem;">
      Logs printed to browser console
    </p>
    <button id="close-game-over" style="
      margin-top: 1rem;
      padding: 0.5rem 1.5rem;
      font-family: 'JetBrains Mono', monospace;
      background: #ffcc44;
      border: none;
      border-radius: 4px;
      color: #000;
      cursor: pointer;
      font-weight: 600;
    ">Close</button>
  `,document.body.appendChild(e),(r=document.getElementById("close-game-over"))==null||r.addEventListener("click",()=>{e.remove()})}function po(){var e;const n=[];n.push("=".repeat(80)),n.push("AI BATTLEGROUNDS GAME LOG (COMPACT)"),n.push(`Exported at: ${new Date().toISOString()}`),n.push(`Current Turn: ${v.turn}`),n.push("=".repeat(80)),n.push(""),n.push("WORLD STATE:"),n.push("-".repeat(40));for(const r of v.characters){const a=r.alive?`HP: ${r.hp}/${r.maxHp}`:"DEAD",s=((e=r.equippedWeapon)==null?void 0:e.name)??"Unarmed";n.push(`  ${r.name}: ${a}, Weapon: ${s}, Position: (${r.position.x}, ${r.position.y})`)}n.push(""),n.push("CHRONOLOGICAL LOG:"),n.push("-".repeat(40));for(const r of un)if(r.type==="event")n.push(`[Turn ${r.turn}] ${r.description}`);else{const a=r.decision;n.push(`[Turn ${a.turn}] ${a.character} thinks: "${a.reasoning}"`);try{const s=JSON.parse(a.fullResponse);if(s.action){let l=s.action;s.x!==null&&s.y!==null&&(l+=` (${s.x}, ${s.y})`),s.target&&(l+=` "${s.target}"`),s.message&&(l+=`: "${s.message}"`),n.push(`  Action: ${l}`)}}catch{n.push(`  Response: ${a.fullResponse.substring(0,200)}...`)}if(a.errors&&a.errors.length>0)for(const s of a.errors)n.push(`  âš ï¸ ERROR: ${s}`)}return n.join(`
`)}function qc(){const n=po();console.log("=== GAME LOG START ==="),console.log(n),console.log("=== GAME LOG END ===")}function Hc(){const n=po();navigator.clipboard.writeText(n).then(()=>{const e=document.getElementById("export-compact-btn");if(e){const r=e.textContent;e.textContent="âœ“ Copied!",setTimeout(()=>{e.textContent=r},2e3)}}).catch(e=>{console.error("Failed to copy logs:",e),alert("Failed to copy to clipboard. Check console for the full log."),console.log(n)})}function Uc(){const n=localStorage.getItem("openai_api_key");if(n){Dr(n),Lr(n);return}const e=document.createElement("div");e.style.cssText=`
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  `,e.innerHTML=`
    <div style="
      background: #12121a;
      border: 1px solid #2a2a3a;
      padding: 2rem;
      border-radius: 8px;
      max-width: 400px;
      width: 90%;
    ">
      <h2 style="margin-bottom: 1rem; color: #ffcc44; font-family: 'Press Start 2P', cursive; font-size: 1rem;">
        ðŸ”‘ API Key Required
      </h2>
      <p style="margin-bottom: 1rem; color: #8888a0; font-size: 0.85rem;">
        Enter your OpenAI API key to enable AI-driven characters.
        The key will be stored locally in your browser.
      </p>
      <input
        type="password"
        id="api-key-input"
        placeholder="sk-..."
        style="
          width: 100%;
          padding: 0.75rem;
          background: #1a1a25;
          border: 1px solid #2a2a3a;
          border-radius: 4px;
          color: #e8e8f0;
          font-family: 'JetBrains Mono', monospace;
          margin-bottom: 1rem;
        "
      />
      <div style="display: flex; gap: 0.5rem;">
        <button id="save-key-btn" style="flex: 1;" class="primary">Save & Start</button>
      </div>
    </div>
  `,document.body.appendChild(e);const r=document.getElementById("api-key-input"),a=document.getElementById("save-key-btn");a==null||a.addEventListener("click",()=>{const s=r.value.trim();s&&(localStorage.setItem("openai_api_key",s),Dr(s),Lr(s)),e.remove()})}function Gc(){const n=localStorage.getItem("openai_api_key"),e=document.createElement("div");e.style.cssText=`
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  `,e.innerHTML=`
    <div style="
      background: #12121a;
      border: 1px solid #2a2a3a;
      padding: 2rem;
      border-radius: 8px;
      max-width: 400px;
      width: 90%;
    ">
      <h2 style="margin-bottom: 1rem; color: #ffcc44; font-family: 'Press Start 2P', cursive; font-size: 1rem;">
        ðŸ”‘ API Key Settings
      </h2>
      <p style="margin-bottom: 1rem; color: #8888a0; font-size: 0.85rem;">
        ${n?"Your API key is stored locally. You can update or remove it below.":"No API key is currently set. AI characters will use random actions."}
      </p>
      <input
        type="password"
        id="change-api-key-input"
        placeholder="sk-..."
        value="${n||""}"
        style="
          width: 100%;
          padding: 0.75rem;
          background: #1a1a25;
          border: 1px solid #2a2a3a;
          border-radius: 4px;
          color: #e8e8f0;
          font-family: 'JetBrains Mono', monospace;
          margin-bottom: 1rem;
        "
      />
      <div style="display: flex; gap: 0.5rem;">
        <button id="update-key-btn" style="flex: 1;" class="primary">Save</button>
        <button id="clear-key-btn" style="flex: 1;">Clear Key</button>
        <button id="cancel-key-btn" style="flex: 1;">Cancel</button>
      </div>
    </div>
  `,document.body.appendChild(e);const r=document.getElementById("change-api-key-input"),a=document.getElementById("update-key-btn"),s=document.getElementById("clear-key-btn"),l=document.getElementById("cancel-key-btn");a==null||a.addEventListener("click",()=>{const o=r.value.trim();o&&(localStorage.setItem("openai_api_key",o),Dr(o),Lr(o)),e.remove()}),s==null||s.addEventListener("click",()=>{localStorage.removeItem("openai_api_key"),e.remove()}),l==null||l.addEventListener("click",()=>{e.remove()})}function jc(){const n=document.getElementById("map-select");let e=pc();e==="custom"&&(Ql()||(e="bear-traps-vs-hunters")),n&&(n.value=e),v=to(e),Aa=v.characters.length,Ke=document.getElementById("game-canvas"),Zl=Ke.getContext("2d");const r=Gl(v);Ke.width=r.width,Ke.height=r.height,Uc(),Zu(),Ta(),be(),$e(),cn(),Ke.addEventListener("click",_c);const a=document.getElementById("restart-btn");a==null||a.addEventListener("click",ps);const s=document.getElementById("api-key-btn");s==null||s.addEventListener("click",Gc),n==null||n.addEventListener("change",()=>{const p=ro();mc(p),ps()});const l=document.getElementById("next-turn-btn");l==null||l.addEventListener("click",()=>{It||fo()});const o=document.getElementById("auto-play-btn");o==null||o.addEventListener("click",Pc);const u=document.getElementById("speed-toggle-btn");u==null||u.addEventListener("click",Ac);const i=document.getElementById("player-control-btn");i==null||i.addEventListener("click",Tc),i==null||i.addEventListener("contextmenu",p=>{p.preventDefault(),Bc()}),document.querySelectorAll(".action-btn[data-action]").forEach(p=>{p.addEventListener("click",()=>{const b=p.dataset.action;b&&Fc(b)})});const c=document.getElementById("export-logs-btn");c==null||c.addEventListener("click",Nc);const m=document.getElementById("export-compact-btn");m==null||m.addEventListener("click",Hc);const g=document.getElementById("return-to-present");g==null||g.addEventListener("click",oo);const h=document.getElementById("close-inspector");h==null||h.addEventListener("click",Da);const y=document.getElementById("contracts-btn");y==null||y.addEventListener("click",kc);const d=document.getElementById("close-contracts");d==null||d.addEventListener("click",xc);const f={turn:0,actorId:"",description:"",witnessIds:v.characters.filter(p=>p.alive).map(p=>p.id)};H(f);for(const p of v.characters){const b={turn:0,actorId:p.id,description:`${p.name} is at (${p.position.x}, ${p.position.y})`,witnessIds:R(v,[p.position])};H(b)}}document.addEventListener("DOMContentLoaded",jc);
